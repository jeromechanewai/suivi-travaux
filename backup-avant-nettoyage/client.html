<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi de votre chantier - SuiviTravaux.app</title>
    <meta name="description" content="Suivez l'avancement de votre chantier en temps rÃ©el">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 400; overflow: hidden; }
        .confetti {
            position: absolute; width: 10px; height: 10px;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Loading State -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 bg-primary-600 rounded-2xl flex items-center justify-center mx-auto mb-4 loading">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
            </div>
            <p class="text-slate-500">Chargement de votre chantier...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="min-h-screen flex items-center justify-center hidden">
        <div class="text-center px-6">
            <div class="text-6xl mb-4">ðŸ”—</div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Lien invalide</h1>
            <p class="text-slate-500 mb-6">Ce lien de suivi n'existe pas ou a expirÃ©.</p>
            <p class="text-sm text-slate-400">Contactez votre artisan pour obtenir un nouveau lien.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <!-- Header -->
        <div class="bg-white border-b border-slate-200 px-4 py-4 sticky top-0 z-10">
            <div class="flex items-center gap-2 mb-1">
                <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </div>
                <span class="font-bold text-primary-600">SuiviTravaux<span class="text-slate-400">.app</span></span>
            </div>
            <h1 id="chantier-name" class="text-xl font-bold text-slate-800">-</h1>
            <p id="artisan-name" class="text-slate-500 text-sm">Artisan : -</p>
        </div>

        <!-- Progress Circle -->
        <div class="px-4 py-6">
            <div class="flex justify-center mb-6">
                <div class="relative w-40 h-40">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="80" cy="80" r="70" stroke="#e2e8f0" stroke-width="12" fill="none"></circle>
                        <circle id="progress-circle" cx="80" cy="80" r="70" stroke="#2563eb" stroke-width="12" fill="none"
                            stroke-dasharray="440" stroke-dashoffset="440" stroke-linecap="round"></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="progress-percent" class="text-4xl font-bold text-slate-800">0%</span>
                        <span id="status-text" class="text-sm text-slate-500">-</span>
                    </div>
                </div>
            </div>

            <!-- Stages -->
            <div id="stages-container" class="flex justify-between mb-6 px-2">
                <!-- Filled dynamically -->
            </div>

            <!-- Last Update Card -->
            <div class="bg-white rounded-2xl p-4 mb-4 shadow-sm border border-slate-100">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-semibold text-slate-800">DerniÃ¨re mise Ã  jour</h3>
                    <span id="last-update-date" class="text-xs text-slate-400">-</span>
                </div>
                <p id="last-message" class="text-slate-600 text-sm">Aucune mise Ã  jour rÃ©cente</p>
            </div>

            <!-- Feedback Section (only visible when completed) -->
            <div id="feedback-section" class="hidden mb-6">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-2xl p-5 text-center">
                    <div class="text-4xl mb-3">ðŸŽ‰</div>
                    <h3 class="font-bold text-slate-800 mb-2">Chantier terminÃ© !</h3>
                    <p class="text-sm text-slate-600 mb-4">Comment s'est passÃ©e cette expÃ©rience ?</p>
                    <div id="emoji-feedback" class="flex justify-center gap-4 mb-4">
                        <button onclick="selectFeedback(1)" class="emoji-btn text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="1">ðŸ˜•</button>
                        <button onclick="selectFeedback(2)" class="emoji-btn text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="2">ðŸ™‚</button>
                        <button onclick="selectFeedback(3)" class="emoji-btn text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="3">ðŸ˜Š</button>
                        <button onclick="selectFeedback(4)" class="emoji-btn text-4xl transition-all hover:scale-125" data-mood="4">ðŸ¤©</button>
                    </div>
                    <p id="feedback-hint" class="text-xs text-slate-400 mb-3">Optionnel, sans pression</p>
                    <button id="submit-feedback-btn" onclick="submitFeedback()" disabled
                        class="w-full bg-primary-600 text-white py-2 rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        Envoyer mon avis
                    </button>
                </div>
            </div>

            <!-- Already Rated Section -->
            <div id="already-rated-section" class="hidden mb-6">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-4 text-center">
                    <span id="rated-emoji" class="text-4xl">ðŸ¤©</span>
                    <p class="text-sm text-green-700 mt-2 font-medium">Merci pour votre avis !</p>
                </div>
            </div>

            <!-- History -->
            <h3 class="font-semibold text-slate-800 mb-3">Historique complet</h3>
            <div id="history-container" class="space-y-3 mb-6">
                <!-- Filled dynamically -->
            </div>

            <!-- Contact Artisan -->
            <div class="pt-4 border-t border-slate-200">
                <h3 class="font-semibold text-slate-800 mb-3">Contacter l'artisan</h3>
                <div class="flex gap-2">
                    <a id="call-btn" href="tel:" class="flex-1 bg-primary-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        Appeler
                    </a>
                    <a id="whatsapp-btn" href="" target="_blank" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                        </svg>
                        WhatsApp
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center py-6 text-xs text-slate-400">
            PropulsÃ© par <a href="/" class="text-primary-600 font-medium">SuiviTravaux.app</a>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        // Variables globales
        let currentToken = null;
        let currentChantier = null;
        let selectedMood = 0;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            // RÃ©cupÃ©rer le token de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            currentToken = urlParams.get('t');

            if (!currentToken) {
                showError();
                return;
            }

            try {
                // Initialiser Supabase
                SuiviTravauxAPI.init();

                // Charger les donnÃ©es du chantier
                await loadChantier();
            } catch (error) {
                console.error('Erreur:', error);
                showError();
            }
        });

        // Charger les donnÃ©es du chantier
        async function loadChantier() {
            try {
                currentChantier = await SuiviTravauxAPI.ClientAPI.getChantierByToken(currentToken);

                if (!currentChantier) {
                    showError();
                    return;
                }

                // Charger l'historique
                const updates = await SuiviTravauxAPI.ClientAPI.getUpdatesByToken(currentToken);

                // Afficher les donnÃ©es
                renderChantier(currentChantier, updates);
                showMain();

            } catch (error) {
                console.error('Erreur chargement:', error);
                showError();
            }
        }

        // Afficher le chantier
        function renderChantier(chantier, updates) {
            // Infos de base
            document.getElementById('chantier-name').textContent = chantier.name;
            document.getElementById('artisan-name').textContent = 'Artisan : ' + chantier.artisan_name;

            // Progression circulaire
            const circumference = 2 * Math.PI * 70;
            const offset = circumference - (chantier.progress / 100) * circumference;
            document.getElementById('progress-circle').setAttribute('stroke-dashoffset', offset);
            document.getElementById('progress-percent').textContent = chantier.progress + '%';
            document.getElementById('status-text').textContent = chantier.status;

            // Changer la couleur si terminÃ©
            if (chantier.progress === 100) {
                document.getElementById('progress-circle').setAttribute('stroke', '#22c55e');
            }

            // DerniÃ¨re mise Ã  jour
            if (chantier.updated_at) {
                const date = new Date(chantier.updated_at);
                document.getElementById('last-update-date').textContent = date.toLocaleDateString('fr-FR', {
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                });
            }
            document.getElementById('last-message').textContent = chantier.last_message || 'Aucune mise Ã  jour rÃ©cente';

            // Stages
            renderStages(chantier.stage, chantier.progress);

            // Historique
            renderHistory(updates);

            // Contact
            if (chantier.artisan_phone) {
                document.getElementById('call-btn').href = 'tel:' + chantier.artisan_phone;
                document.getElementById('whatsapp-btn').href = 'https://wa.me/' + chantier.artisan_phone.replace(/[^0-9]/g, '');
            }

            // Feedback section
            if (chantier.progress === 100) {
                if (chantier.client_feedback) {
                    document.getElementById('already-rated-section').classList.remove('hidden');
                    const emojis = {1: 'ðŸ˜•', 2: 'ðŸ™‚', 3: 'ðŸ˜Š', 4: 'ðŸ¤©'};
                    document.getElementById('rated-emoji').textContent = emojis[chantier.client_feedback];
                } else {
                    document.getElementById('feedback-section').classList.remove('hidden');
                }
            }
        }

        // Afficher les Ã©tapes
        function renderStages(currentStage, progress) {
            const container = document.getElementById('stages-container');
            const stages = ['preparation', 'en_cours', 'finitions', 'livre'];
            const stageNames = ['PrÃ©pa', 'En cours', 'Finitions', 'LivrÃ©'];
            const currentIndex = stages.indexOf(currentStage);
            const isCompleted = currentStage === 'livre' || progress === 100;

            let html = '';
            stages.forEach((stage, i) => {
                const isDone = isCompleted ? true : (i < currentIndex);
                const isCurrent = isCompleted ? false : (i === currentIndex);
                const bgClass = isDone ? 'bg-green-500 text-white' : (isCurrent ? 'bg-primary-600 text-white' : 'bg-slate-200 text-slate-400');
                const textClass = isDone ? 'text-green-600 font-medium' : (isCurrent ? 'text-primary-600 font-medium' : 'text-slate-400');
                const lineClass = isDone || (isCompleted && i < stages.length - 1) ? 'bg-green-500' : 'bg-slate-200';
                const content = isDone ? 'âœ“' : (i + 1);

                html += `<div class="flex flex-col items-center">
                    <div class="w-8 h-8 ${bgClass} rounded-full flex items-center justify-center text-sm">${content}</div>
                    <span class="text-xs ${textClass} mt-1">${stageNames[i]}</span>
                </div>`;

                if (i < stages.length - 1) {
                    html += `<div class="flex-1 h-1 ${lineClass} self-center mx-2 rounded"></div>`;
                }
            });
            container.innerHTML = html;
        }

        // Afficher l'historique
        function renderHistory(updates) {
            const container = document.getElementById('history-container');

            if (!updates || updates.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm text-center">Aucun historique</p>';
                return;
            }

            let html = '';
            updates.forEach(u => {
                const date = new Date(u.created_at);
                const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                html += `
                <div class="bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-slate-700">${u.title}</span>
                        <span class="text-xs text-slate-400">${dateStr}</span>
                    </div>
                    ${u.message ? `<p class="text-xs text-slate-500 mb-2">${u.message}</p>` : ''}
                    <div class="flex items-center gap-2">
                        <div class="h-1.5 flex-1 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-primary-600 rounded-full" style="width:${u.progress}%"></div>
                        </div>
                        <span class="text-xs text-slate-500">${u.progress}%</span>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // SÃ©lection du feedback
        function selectFeedback(mood) {
            selectedMood = mood;
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                const btnMood = parseInt(btn.dataset.mood);
                if (btnMood === mood) {
                    btn.classList.remove('opacity-60');
                    btn.classList.add('scale-125', 'opacity-100');
                } else {
                    btn.classList.add('opacity-60');
                    btn.classList.remove('scale-125', 'opacity-100');
                }
            });

            const messages = {
                1: "Merci pour votre honnÃªtetÃ©",
                2: "Merci pour votre retour",
                3: "Content que Ã§a se soit bien passÃ© !",
                4: "GÃ©nial ! Merci beaucoup !"
            };
            document.getElementById('feedback-hint').textContent = messages[mood];
            document.getElementById('submit-feedback-btn').disabled = false;

            if (mood === 4) showConfetti();
        }

        // Soumettre le feedback
        async function submitFeedback() {
            if (selectedMood === 0) return;

            try {
                await SuiviTravauxAPI.ClientAPI.submitFeedback(currentToken, selectedMood);

                document.getElementById('feedback-section').classList.add('hidden');
                document.getElementById('already-rated-section').classList.remove('hidden');
                const emojis = {1: 'ðŸ˜•', 2: 'ðŸ™‚', 3: 'ðŸ˜Š', 4: 'ðŸ¤©'};
                document.getElementById('rated-emoji').textContent = emojis[selectedMood];

                showConfetti();
            } catch (error) {
                console.error('Erreur feedback:', error);
                alert('Erreur lors de l\'envoi. RÃ©essayez.');
            }
        }

        // Affichage des Ã©tats
        function showMain() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }

        function showError() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        // Confetti
        function showConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);

            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(confetti);
            }
            setTimeout(() => container.remove(), 4000);
        }
    </script>
</body>
</html>
