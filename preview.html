<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SEO Meta Tags -->
    <title>SuiviTravaux.app - Suivi de chantier simplifi√© pour artisans</title>
    <meta name="description" content="Application de suivi de chantier pour artisans. Partagez l'avancement de vos travaux avec vos clients en temps r√©el. Simple, rapide, efficace.">
    <meta name="keywords" content="chantier, artisan, suivi travaux, BTP, r√©novation, construction, gestion chantier, client, avancement">
    <meta name="author" content="SuiviTravaux.app">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://suivitravaux.app/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://suivitravaux.app/">
    <meta property="og:title" content="SuiviTravaux.app - Suivi de chantier simplifi√©">
    <meta property="og:description" content="Partagez l'avancement de vos chantiers avec vos clients. Simple et gratuit.">
    <meta property="og:image" content="https://suivitravaux.app/og-image.png">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:site_name" content="SuiviTravaux.app">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://suivitravaux.app/">
    <meta name="twitter:title" content="SuiviTravaux.app - Suivi de chantier simplifi√©">
    <meta name="twitter:description" content="Partagez l'avancement de vos chantiers avec vos clients. Simple et gratuit.">
    <meta name="twitter:image" content="https://suivitravaux.app/og-image.png">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SuiviTravaux">
    <meta name="application-name" content="SuiviTravaux">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Preconnect pour performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- DNS Prefetch pour Supabase -->
    <link rel="dns-prefetch" href="https://xschodvxoodyhakmeoxu.supabase.co">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }

        .phone-content::-webkit-scrollbar,
        .mobile-content::-webkit-scrollbar { width: 4px; }
        .phone-content::-webkit-scrollbar-track,
        .mobile-content::-webkit-scrollbar-track { background: transparent; }
        .phone-content::-webkit-scrollbar-thumb,
        .mobile-content::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 10px; }

        .phone-frame {
            width: 375px; height: 812px; background: #1a1a1a;
            border-radius: 50px; padding: 12px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.25);
        }
        .phone-screen {
            width: 100%; height: 100%; background: white;
            border-radius: 40px; overflow: hidden; position: relative;
        }
        .phone-notch {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 150px; height: 30px; background: #1a1a1a;
            border-radius: 0 0 20px 20px; z-index: 50;
        }
        .phone-status-bar {
            position: absolute; top: 0; left: 0; right: 0; height: 44px;
            background: linear-gradient(to bottom, white 80%, transparent);
            z-index: 40; pointer-events: none;
        }
        .phone-content { height: 100%; overflow-y: auto; padding-top: 44px; }
        .screen { display: none; opacity: 0; transform: translateX(10px); }
        .screen.active { display: block; animation: screenFadeIn 0.3s ease forwards; }
        @keyframes screenFadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .stage-btn.active { background: #2563eb; color: white; }
        .progress-bar { transition: width 0.3s ease; }

        /* Smooth transitions */
        button, a { transition: all 0.2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Accessibility - Focus states */
        button:focus-visible, a:focus-visible {
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
        }
        /* Better contrast for text */
        .text-slate-500 { color: #475569; } /* Improved from slate-500 */
        .text-slate-400 { color: #64748b; } /* Improved from slate-400 */

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Skip to content link for keyboard users */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #2563eb;
            color: white;
            padding: 8px 16px;
            z-index: 1000;
            border-radius: 0 0 8px 0;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Better touch targets (minimum 44x44px) */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .text-slate-400, .text-slate-500 {
                color: #1e293b !important;
            }
            .border-slate-200 {
                border-color: #475569 !important;
            }
        }

        /* Modal overlay */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 200; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        /* Auth modal - z-index plus √©lev√© */
        #authModal { z-index: 9999 !important; display: none; }
        #authModal.active { display: flex !important; }
        #authModal > div { position: relative; z-index: 10000 !important; pointer-events: auto; }
        .modal-content {
            background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 375px;
            max-height: 90vh; overflow-y: auto; padding: 24px; padding-bottom: 40px;
            animation: slideUp 0.3s ease; position: relative; z-index: 201;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Toast notification */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #059669; color: white; padding: 12px 24px; border-radius: 12px;
            font-weight: 500; z-index: 300; display: none; animation: fadeInUp 0.3s ease;
        }
        .toast.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* Loading spinner */
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: inline-block;
        }
        .spinner-dark { border-color: rgba(0,0,0,0.1); border-top-color: #2563eb; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-loading { pointer-events: none; opacity: 0.8; }

        /* Confetti animation */
        .confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 400; overflow: hidden; }
        .confetti {
            position: absolute; width: 10px; height: 10px;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Dark mode */
        .dark { background: #0f172a !important; color: #e2e8f0; }
        .dark .bg-white { background: #1e293b !important; }
        .dark .bg-slate-50, .dark .bg-slate-100 { background: #334155 !important; }
        .dark .bg-slate-200 { background: #475569 !important; }
        .dark .bg-slate-300 { background: #64748b !important; }
        .dark .text-slate-800 { color: #f1f5f9 !important; }
        .dark .text-slate-700 { color: #e2e8f0 !important; }
        .dark .text-slate-600 { color: #cbd5e1 !important; }
        .dark .text-slate-500 { color: #94a3b8 !important; }
        .dark .text-slate-400 { color: #94a3b8 !important; }
        .dark .border-slate-200, .dark .border-slate-100 { border-color: #475569 !important; }
        .dark .border-slate-300 { border-color: #64748b !important; }
        .dark .phone-screen { background: #1e293b !important; }
        .dark .modal-content { background: #1e293b !important; }
        /* Dark mode - inputs */
        .dark input, .dark textarea { background: #334155 !important; color: #e2e8f0 !important; border-color: #475569 !important; }
        .dark input::placeholder, .dark textarea::placeholder { color: #94a3b8 !important; }
        /* Dark mode - stage buttons */
        .dark .stage-btn { background: #1e293b; border-color: #475569 !important; }
        .dark .stage-btn.active { background: #2563eb !important; border-color: #2563eb !important; }
        .dark .mobile-stage-btn { background: #1e293b; border-color: #475569 !important; }
        .dark .mobile-stage-btn.active { background: #2563eb !important; border-color: #2563eb !important; }
        /* Dark mode - cards and notifications */
        .dark .from-green-50, .dark .to-emerald-50 { background: #064e3b !important; }
        .dark .border-green-200, .dark .border-green-300 { border-color: #065f46 !important; }
        .dark .from-blue-50 { background: #1e3a5f !important; }
        .dark .border-blue-200 { border-color: #1e40af !important; }
        /* Dark mode - progress bar background */
        .dark .rounded-full.overflow-hidden { background: #475569 !important; }
        /* Dark mode - nav buttons */
        .dark .nav-btn:not(.bg-primary-600) { color: #94a3b8 !important; }
        .dark .nav-btn:hover { background: #334155 !important; }

        /* Search bar */
        .search-bar {
            background: #f1f5f9; border-radius: 12px; padding: 10px 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .dark .search-bar { background: #334155; }
        .search-bar input {
            background: transparent; border: none; outline: none; flex: 1;
            font-size: 14px; color: inherit;
        }
        .search-bar input::placeholder { color: #94a3b8; }

        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #e5e7eb; padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 100;
        }

        @media (max-width: 500px) {
            body { background: white !important; padding: 0 !important; }
            .desktop-container { display: none !important; }
            .mobile-container { display: block !important; height: 100vh; }
            .mobile-nav { display: flex; justify-content: space-around; }
            .mobile-content { height: calc(100vh - 70px); overflow-y: auto; }
        }
        @media (min-width: 501px) {
            .mobile-container { display: none !important; }
        }

        /* Mode D√©mo - √âl√©ments restreints */
        .demo-mode .demo-restricted {
            position: relative;
            opacity: 0.5;
            pointer-events: none;
        }
        .demo-mode .demo-restricted::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            z-index: 5;
        }
        .demo-mode .demo-clickable {
            opacity: 0.6;
            pointer-events: auto;
            cursor: pointer;
        }
        .demo-mode .demo-clickable:hover {
            opacity: 0.8;
        }
        /* Banni√®re d√©mo - ajustement mobile */
        @media (max-width: 500px) {
            #demo-banner {
                padding: 8px 12px;
                font-size: 12px;
            }
            #demo-banner button {
                padding: 4px 8px;
                font-size: 10px;
            }
            body.demo-mode .mobile-content {
                padding-top: 36px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex items-center justify-center p-8">

<!-- Skip to content link for accessibility -->
<a href="#main-content" class="skip-link">Aller au contenu principal</a>

<!-- Toast notification avec role pour les lecteurs d'√©cran -->
<div id="toast" class="toast" role="alert" aria-live="polite"></div>

<!-- Banni√®re Mode D√©mo (fixe en haut) -->
<div id="demo-banner" class="hidden fixed top-0 left-0 right-0 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-center py-2 px-4 z-[9998] shadow-md">
    <div class="flex items-center justify-center gap-2 text-sm font-medium">
        <span>Mode d√©mo</span>
        <span class="opacity-75">‚Ä¢</span>
        <span class="opacity-90">Fonctionnalit√©s limit√©es</span>
        <button onclick="showDemoUpgradeModal()" class="ml-3 bg-white text-amber-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-amber-50 transition-colors">
            Cr√©er un compte
        </button>
    </div>
</div>

<!-- Modal Upgrade D√©mo -->
<div id="demoUpgradeModal" class="modal-overlay" style="align-items: center; background: rgba(0,0,0,0.8); z-index: 10001;">
    <div class="bg-white rounded-3xl w-full max-w-sm mx-4 overflow-hidden" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üîí</span>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Fonctionnalit√© limit√©e</h2>
                <p id="demo-upgrade-message" class="text-slate-500 text-sm mt-2">Cette fonctionnalit√© n'est pas disponible en mode d√©mo.</p>
            </div>

            <div class="space-y-3">
                <!-- Option 1: Cr√©er un compte gratuit -->
                <button onclick="hideDemoUpgradeModal(); showAuthModal(); showSignupForm();" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700 flex items-center justify-center gap-2">
                    <span>Cr√©er un compte gratuit</span>
                    <span class="text-xs opacity-75">(14j d'essai)</span>
                </button>

                <!-- Option 2: S'abonner -->
                <button onclick="hideDemoUpgradeModal(); openSubscriptionModal();" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 rounded-xl font-semibold hover:from-amber-600 hover:to-orange-600 flex items-center justify-center gap-2">
                    <span>S'abonner maintenant</span>
                    <span class="text-xs opacity-75">(9,90‚Ç¨/mois)</span>
                </button>

                <!-- Continuer en d√©mo -->
                <button onclick="hideDemoUpgradeModal()" class="w-full text-slate-500 py-2 text-sm hover:text-slate-700">
                    Continuer en mode d√©mo
                </button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <p class="text-xs text-slate-400 text-center">
                    En mode d√©mo : 1 chantier, pas de partage r√©el, pas de photos/vocaux
                </p>
            </div>
        </div>
    </div>
</div>

<div class="desktop-container" id="main-content">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-slate-800">SuiviTravaux<span class="text-primary-600">.app</span></h1>
        <p class="text-slate-500 mt-2">Light, simple, efficace</p>
    </div>

    <div class="flex justify-center gap-2 mb-6 flex-wrap">
        <button onclick="showScreen('list')" data-screen="list" class="nav-btn px-4 py-2 rounded-full text-sm font-medium bg-primary-600 text-white">Liste chantiers</button>
        <button onclick="showScreen('detail')" data-screen="detail" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:bg-slate-200">D√©tail chantier</button>
        <button onclick="showScreen('update')" data-screen="update" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:bg-slate-200">Mise √† jour</button>
        <button onclick="showScreen('client')" data-screen="client" class="nav-btn px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:bg-slate-200">Vue client</button>
    </div>

    <div class="phone-frame mx-auto">
        <div class="phone-screen">
            <div class="phone-notch"></div>
            <div class="phone-status-bar"></div>
            <div class="phone-content">
                <!-- Screen: Liste -->
                <div id="screen-list" class="screen active">
                    <div class="sticky top-0 bg-white z-10 pt-6 px-4 pb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 id="header-user-name" class="text-2xl font-bold text-slate-800">Bonjour !</h1>
                                <p class="text-slate-500 text-sm mt-1 header-chantiers-count">0 chantiers en cours</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openProfileModal()" id="header-avatar" class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center text-white font-bold hover:scale-105 transition-transform cursor-pointer">JD</button>
                            </div>
                        </div>
                    </div>
                    <!-- Notification positive - client a consult√© -->
                    <div id="notification-client-viewed" class="px-4 mb-4">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-3 flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm">
                                <span class="text-lg">üëÄ</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-slate-700"><span id="notif-client-name">Un client</span> a consult√© son chantier r√©cemment</p>
                                <p class="text-xs text-green-600 mt-1">Vos clients suivent vos avancements !</p>
                            </div>
                        </div>
                    </div>
                    <!-- Stats saines - focus relation client -->
                    <div class="px-4 mb-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-white border border-slate-200 rounded-xl p-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-lg">‚≠ê</span>
                                    <p class="text-xl font-bold text-slate-800 stat-rating">4.9</p>
                                </div>
                                <p class="text-xs text-slate-500">Note moyenne clients</p>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-xl p-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-lg">üí¨</span>
                                    <p class="text-xl font-bold text-slate-800 stat-total-chantiers">0</p>
                                </div>
                                <p class="text-xs text-slate-500">Chantiers total</p>
                            </div>
                        </div>
                    </div>
                    <!-- Barre de recherche -->
                    <div class="px-4 mb-4">
                        <div class="search-bar">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="search-chantiers" placeholder="Rechercher un chantier..." oninput="filterChantiers(this.value)">
                        </div>
                    </div>
                    <!-- Indicateur limite essai -->
                    <div id="trial-limit-indicator" class="px-4 mb-4 hidden">
                        <!-- G√©n√©r√© par updateTrialIndicator() -->
                    </div>

                    <!-- Chantiers en cours -->
                    <div class="px-4 mb-2">
                        <h2 class="font-semibold text-slate-800">üî® Chantiers en cours</h2>
                    </div>
                    <div id="chantiers-list" class="px-4 space-y-3 mb-6">
                        <!-- G√©n√©r√© dynamiquement par renderChantiersList() -->
                    </div>

                    <!-- Chantiers r√©alis√©s -->
                    <div class="px-4 mb-2">
                        <h2 class="font-semibold text-slate-800">‚úÖ Chantiers r√©alis√©s</h2>
                    </div>
                    <div id="chantiers-termines-list" class="px-4 space-y-3 mb-4">
                        <!-- G√©n√©r√© dynamiquement par renderChantiersList() -->
                    </div>

                    <!-- Acc√®s aux archives -->
                    <div class="px-4 pb-20">
                        <button onclick="showArchivesModal()" class="w-full flex items-center justify-between p-3 bg-slate-100 rounded-xl hover:bg-slate-200 transition-colors">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">üì¶</span>
                                <span class="text-sm text-slate-600">Chantiers archiv√©s</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="archives-count" class="text-xs bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">0</span>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Screen: Detail -->
                <div id="screen-detail" class="screen">
                    <div class="sticky top-0 bg-white z-10 pt-6 px-4 pb-4">
                        <button onclick="showScreen('list')" class="flex items-center text-primary-600 mb-2">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Retour
                        </button>
                        <h1 id="detail-chantier-name" class="text-2xl font-bold text-slate-800">Chantier</h1>
                        <p id="detail-client-name" class="text-slate-500 text-sm">Client</p>
                    </div>
                    <div class="px-4 pb-6">
                        <div id="detail-progress-card" class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl p-4 text-white mb-4">
                            <div class="flex justify-between items-center mb-2"><span class="text-sm opacity-90">Avancement</span><span id="detail-progress-percent" class="text-2xl font-bold">0%</span></div>
                            <div class="h-2 bg-white/30 rounded-full overflow-hidden"><div id="detail-progress-bar" class="h-full bg-white rounded-full" style="width:0%"></div></div>
                            <div class="flex justify-between items-center mt-3 text-xs opacity-90">
                                <span id="detail-stage">√âtape : -</span>
                                <span id="detail-end-date" class="flex items-center gap-1">üìÖ Fin estim√©e : -</span>
                            </div>
                        </div>
                        <!-- Actions rapides -->
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button id="quick-photo-btn-desktop" onclick="quickPhoto()" class="bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Photo rapide
                            </button>
                            <button onclick="showScreen('update')" class="bg-slate-100 text-slate-700 py-3 rounded-xl font-semibold">+ Mise √† jour</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                <p class="text-sm text-slate-600">Lien auto-g√©n√©r√© pour votre client</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input id="detail-client-link" type="text" value="suivitravaux.app/c/xxx" readonly class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-500">
                                <button onclick="copyLink()" class="p-2 bg-primary-100 text-primary-600 rounded-lg hover:bg-primary-200" title="Copier"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                                <button onclick="shareLink()" class="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200" title="Envoyer par WhatsApp"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Le client peut voir l'avancement sans cr√©er de compte</p>
                        </div>
                        <h3 class="font-semibold text-slate-800 mb-3">Historique</h3>
                        <div id="detail-history" class="space-y-4">
                            <!-- Historique dynamique -->
                        </div>

                        <!-- Actions chantier -->
                        <div class="mt-6 pt-4 border-t border-slate-200">
                            <button onclick="confirmCancelChantier()" class="w-full py-3 text-red-600 bg-red-50 hover:bg-red-100 rounded-xl font-medium flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                                Annuler ce chantier
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Screen: Update -->
                <div id="screen-update" class="screen">
                    <div class="sticky top-0 bg-white z-10 pt-6 px-4 pb-4">
                        <button onclick="showScreen('detail')" class="flex items-center text-primary-600 mb-2">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Retour
                        </button>
                        <h1 class="text-2xl font-bold text-slate-800">Mise √† jour</h1>
                        <p id="update-chantier-name" class="text-slate-500 text-sm">Chantier</p>
                    </div>
                    <div class="px-4 pb-6">
                        <div id="photo-section-container" class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Photos (optionnel)</label>
                            <input type="file" id="update-photos" accept="image/*" multiple class="hidden" onchange="handlePhotoSelect(this)">
                            <div id="photo-preview-container" class="flex gap-2 flex-wrap">
                                <div id="photo-add-btn" onclick="document.getElementById('update-photos').click()" class="w-24 h-24 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:bg-slate-200 transition-colors">
                                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Max 3 photos - Cliquez pour ajouter</p>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Avancement</label>
                            <div class="bg-slate-50 rounded-xl p-4">
                                <div class="flex justify-between items-center mb-3"><span class="text-slate-600">Progression</span><span id="progress-value" class="text-2xl font-bold text-primary-600">65%</span></div>
                                <input type="range" id="progress-slider" min="0" max="100" value="65" class="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-primary-600">
                                <div class="flex justify-between mt-3">
                                    <button onclick="setProgress(25)" class="px-3 py-1 bg-slate-200 rounded-full text-xs font-medium text-slate-600">25%</button>
                                    <button onclick="setProgress(50)" class="px-3 py-1 bg-slate-200 rounded-full text-xs font-medium text-slate-600">50%</button>
                                    <button onclick="setProgress(75)" class="px-3 py-1 bg-slate-200 rounded-full text-xs font-medium text-slate-600">75%</button>
                                    <button onclick="setProgress(100)" class="px-3 py-1 bg-slate-200 rounded-full text-xs font-medium text-slate-600">100%</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">√âtape</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span class="text-lg">&#127959;</span><p class="text-sm font-medium">Pr√©paration</p></button>
                                <button class="stage-btn active p-3 rounded-xl border-2 border-primary-500 text-left"><span class="text-lg">&#128296;</span><p class="text-sm font-medium">En cours</p></button>
                                <button class="stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span class="text-lg">&#10024;</span><p class="text-sm font-medium">Finitions</p></button>
                                <button class="stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span class="text-lg">&#127968;</span><p class="text-sm font-medium">Livr√©</p></button>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">üìÖ Fin estim√©e</label>
                            <input type="date" id="update-end-date" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <p class="text-xs text-slate-400 mt-1">Date pr√©visionnelle de fin de chantier</p>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Commentaire (optionnel)</label>
                            <textarea placeholder="Ex: Pose du carrelage termin√©e" rows="3" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary-500"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Note vocale (optionnel)</label>
                            <div id="voice-recorder-container">
                                <button id="voice-record-btn"
                                    onmousedown="startRecording()"
                                    onmouseup="stopRecording()"
                                    onmouseleave="stopRecording()"
                                    ontouchstart="startRecording()"
                                    ontouchend="stopRecording()"
                                    class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-slate-50 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                    <span id="voice-record-text">Maintenir pour enregistrer</span>
                                </button>
                                <div id="voice-preview" class="hidden mt-2 p-3 bg-slate-100 rounded-xl">
                                    <div class="flex items-center justify-between">
                                        <audio id="voice-audio" controls class="h-10 flex-1"></audio>
                                        <button onclick="deleteVoiceRecording()" class="ml-2 p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="sendUpdateWithLoading(this)" class="w-full bg-primary-600 text-white py-4 rounded-xl font-semibold hover:bg-primary-700">Envoyer la mise √† jour</button>
                    </div>
                </div>

                <!-- Screen: Client -->
                <div id="screen-client" class="screen">
                    <div class="sticky top-0 bg-white z-10 pt-6 px-4 pb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
                            <span class="font-bold text-primary-600">SuiviTravaux<span class="text-slate-400">.app</span></span>
                        </div>
                        <h1 id="client-view-name" class="text-2xl font-bold text-slate-800">Chantier</h1>
                        <p id="client-view-artisan" class="text-slate-500 text-sm">Artisan : -</p>
                    </div>
                    <div class="px-4 pb-6">
                        <div class="flex justify-center mb-6">
                            <div class="relative w-40 h-40">
                                <svg class="w-full h-full transform -rotate-90"><circle cx="80" cy="80" r="70" stroke="#e2e8f0" stroke-width="12" fill="none"></circle><circle id="client-progress-circle" cx="80" cy="80" r="70" stroke="#2563eb" stroke-width="12" fill="none" stroke-dasharray="440" stroke-dashoffset="154" stroke-linecap="round"></circle></svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="client-progress-percent" class="text-4xl font-bold text-slate-800">0%</span><span id="client-status-text" class="text-sm text-slate-500">En cours</span></div>
                            </div>
                        </div>
                        <div id="client-stages" class="flex justify-between mb-6 px-2">
                            <!-- Stages rendered dynamically -->
                        </div>
                        <div class="bg-slate-50 rounded-2xl p-4 mb-4">
                            <div class="flex justify-between items-start mb-3"><h3 class="font-semibold text-slate-800">Derni√®re mise √† jour</h3><span id="client-last-update" class="text-xs text-slate-400">-</span></div>
                            <p id="client-last-message" class="text-slate-600 text-sm mb-3">Aucune mise √† jour r√©cente</p>
                            <div id="client-estimated-end" class="flex items-center gap-2 text-sm text-slate-600 pt-2 border-t border-slate-200">
                                <span>üìÖ</span>
                                <span>Fin estim√©e : <strong id="client-end-date">-</strong></span>
                            </div>
                        </div>
                        <!-- Section feedback client (visible si chantier termin√©) -->
                        <div id="client-feedback-section" class="hidden mb-6">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-2xl p-5 text-center">
                                <div class="text-4xl mb-3">üéâ</div>
                                <h3 class="font-bold text-slate-800 mb-2">Chantier termin√© !</h3>
                                <p class="text-sm text-slate-600 mb-4">Comment s'est pass√©e cette exp√©rience ?</p>
                                <div id="client-emoji-feedback" class="flex justify-center gap-4 mb-4">
                                    <button onclick="setClientMoodInline(1)" class="emoji-mood text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="1">üòï</button>
                                    <button onclick="setClientMoodInline(2)" class="emoji-mood text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="2">üôÇ</button>
                                    <button onclick="setClientMoodInline(3)" class="emoji-mood text-4xl transition-all hover:scale-125 opacity-60 hover:opacity-100" data-mood="3">üòä</button>
                                    <button onclick="setClientMoodInline(4)" class="emoji-mood text-4xl transition-all hover:scale-125" data-mood="4">ü§©</button>
                                </div>
                                <p id="client-emoji-hint" class="text-xs text-slate-400 mb-3">Optionnel, sans pression</p>
                                <button id="client-emoji-submit" onclick="submitClientMoodInline()" disabled class="w-full bg-primary-600 text-white py-2 rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    Envoyer mon avis
                                </button>
                            </div>
                        </div>
                        <!-- Section d√©j√† not√© -->
                        <div id="client-already-rated" class="hidden mb-6">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-4 text-center">
                                <span id="client-rated-emoji" class="text-4xl">ü§©</span>
                                <p class="text-sm text-green-700 mt-2 font-medium">Merci pour votre avis !</p>
                            </div>
                        </div>

                        <h3 class="font-semibold text-slate-800 mb-3">Historique complet</h3>
                        <div id="client-history" class="space-y-3">
                            <!-- History rendered dynamically -->
                        </div>
                        <!-- Contact artisan -->
                        <div id="client-contact-section" class="mt-6 pt-4 border-t border-slate-200" style="display: none;">
                            <h3 class="font-semibold text-slate-800 mb-3">Contacter l'artisan</h3>
                            <div class="flex gap-2">
                                <a id="client-call-btn" href="tel:" class="flex-1 bg-primary-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                    Appeler
                                </a>
                                <a id="client-whatsapp-btn" href="https://wa.me/" target="_blank" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>
                                    WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FAB Nouveau chantier - toujours visible -->
            <button id="fab-new-chantier" onclick="openNewChantierModal()" class="absolute bottom-6 right-6 w-14 h-14 bg-primary-600 rounded-full shadow-lg flex items-center justify-center text-white hover:bg-primary-700 z-50 transition-transform hover:scale-110">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
    </div>
</div>

<!-- Mobile Container -->
<div class="mobile-container">
    <div class="mobile-content">
        <div id="mobile-screen-list" class="screen active">
            <div class="sticky top-0 bg-white z-10 px-4 pt-4 pb-3 border-b border-slate-100">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 id="mobile-header-user-name" class="text-xl font-bold text-slate-800">Bonjour !</h1>
                        <p class="text-slate-500 text-sm mobile-chantiers-count">3 chantiers en cours</p>
                    </div>
                    <button onclick="openProfileModal()" id="mobile-header-avatar" class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center text-white font-bold text-sm hover:scale-105 transition-transform">JD</button>
                </div>
            </div>
            <!-- Notification positive mobile -->
            <div id="mobile-notification-client" class="px-4 py-3">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-3 flex items-center gap-3 mb-3">
                    <span class="text-lg">üëÄ</span>
                    <div class="flex-1">
                        <p class="text-xs text-slate-700"><span id="mobile-notif-client-name">Un client</span> a vu votre derni√®re mise √† jour</p>
                        <p class="text-[10px] text-green-600">R√©cemment</p>
                    </div>
                </div>
                <!-- Stats saines mobile -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-white border border-slate-200 rounded-xl p-2 flex items-center gap-2">
                        <span>‚≠ê</span>
                        <div>
                            <p class="text-lg font-bold text-slate-800 mobile-stat-rating">4.9</p>
                            <p class="text-[10px] text-slate-500">Note clients</p>
                        </div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-xl p-2 flex items-center gap-2">
                        <span>üí¨</span>
                        <div>
                            <p class="text-lg font-bold text-slate-800 mobile-stat-total">0</p>
                            <p class="text-[10px] text-slate-500">Chantiers</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Barre de recherche mobile -->
            <div class="px-4 mb-3">
                <div class="search-bar">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" placeholder="Rechercher..." oninput="filterChantiers(this.value)">
                </div>
            </div>

            <!-- Chantiers en cours mobile -->
            <div class="px-4 mb-2">
                <h2 class="font-semibold text-slate-800 text-sm">üî® Chantiers en cours</h2>
            </div>
            <div id="mobile-chantiers-list" class="px-4 space-y-3 mb-4">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- Chantiers r√©alis√©s mobile -->
            <div class="px-4 mb-2">
                <h2 class="font-semibold text-slate-800 text-sm">‚úÖ Chantiers r√©alis√©s</h2>
            </div>
            <div id="mobile-chantiers-termines-list" class="px-4 space-y-3 mb-4">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- Acc√®s aux archives mobile -->
            <div class="px-4 pb-28">
                <button onclick="showArchivesModal()" class="w-full flex items-center justify-between p-3 bg-slate-100 rounded-xl active:bg-slate-200">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-500">üì¶</span>
                        <span class="text-sm text-slate-600">Chantiers archiv√©s</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="mobile-archives-count" class="text-xs bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">0</span>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                </button>
            </div>

            <!-- FAB mobile -->
            <button onclick="openNewChantierModal()" class="fixed bottom-24 right-4 w-14 h-14 bg-primary-600 rounded-full shadow-lg flex items-center justify-center text-white z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>

        <div id="mobile-screen-detail" class="screen">
            <div class="sticky top-0 bg-white z-10 px-4 pt-4 pb-3 border-b border-slate-100">
                <button onclick="showScreen('list')" class="flex items-center text-primary-600 mb-1 text-sm"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Retour</button>
                <h1 id="mobile-detail-chantier-name" class="text-xl font-bold text-slate-800">Chantier</h1>
                <p id="mobile-detail-client-name" class="text-slate-500 text-sm">Client</p>
            </div>
            <div class="px-4 py-3 pb-6">
                <div id="mobile-detail-progress-card" class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl p-4 text-white mb-4">
                    <div class="flex justify-between items-center mb-2"><span class="text-sm opacity-90">Avancement</span><span id="mobile-detail-progress" class="text-2xl font-bold">0%</span></div>
                    <div class="h-2 bg-white/30 rounded-full overflow-hidden"><div id="mobile-detail-progress-bar" class="h-full bg-white rounded-full" style="width:0%"></div></div>
                    <p id="mobile-detail-stage" class="text-xs mt-2 opacity-75">√âtape : -</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="quick-photo-btn-mobile" onclick="quickPhoto()" class="bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>
                        Photo rapide
                    </button>
                    <button onclick="showScreen('update')" class="bg-slate-100 text-slate-700 py-3 rounded-xl font-semibold text-sm">+ Mise √† jour</button>
                </div>
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                        <p class="text-sm text-slate-600">Lien auto-g√©n√©r√©</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" value="suivitravaux.app/c/abc123" readonly class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-500">
                        <button onclick="copyLink()" class="p-2 bg-primary-100 text-primary-600 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                        <button onclick="shareLink()" class="p-2 bg-green-100 text-green-600 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
                    </div>
                </div>
                <h3 class="font-semibold text-slate-800 mb-3">Historique</h3>
                <div id="mobile-detail-history" class="space-y-3">
                    <!-- Historique dynamique mobile -->
                </div>

                <!-- Actions chantier mobile -->
                <div class="mt-6 pt-4 border-t border-slate-200">
                    <button onclick="confirmCancelChantier()" class="w-full py-3 text-red-600 bg-red-50 hover:bg-red-100 rounded-xl font-medium flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                        Annuler ce chantier
                    </button>
                </div>
            </div>
        </div>

        <div id="mobile-screen-update" class="screen">
            <div class="sticky top-0 bg-white z-10 px-4 pt-4 pb-3 border-b border-slate-100">
                <button onclick="showScreen('detail')" class="flex items-center text-primary-600 mb-1 text-sm"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Retour</button>
                <h1 class="text-xl font-bold text-slate-800">Mise √† jour</h1>
                <p id="mobile-update-chantier-name" class="text-slate-500 text-sm">Chantier</p>
            </div>
            <div class="px-4 py-3">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Photos</label>
                    <div class="flex gap-2">
                        <div class="w-20 h-20 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center"><svg class="w-7 h-7 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg></div>
                        <div class="w-20 h-20 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center"><span class="text-slate-400 text-xl">+</span></div>
                        <div class="w-20 h-20 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center"><span class="text-slate-400 text-xl">+</span></div>
                    </div>
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Avancement</label>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3"><span class="text-slate-600">Progression</span><span id="mobile-progress-value" class="text-2xl font-bold text-primary-600">65%</span></div>
                        <input type="range" id="mobile-progress-slider" min="0" max="100" value="65" class="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-primary-600">
                        <div class="flex justify-between mt-3">
                            <button onclick="setProgress(25)" class="px-3 py-1 bg-slate-200 rounded-full text-xs">25%</button>
                            <button onclick="setProgress(50)" class="px-3 py-1 bg-slate-200 rounded-full text-xs">50%</button>
                            <button onclick="setProgress(75)" class="px-3 py-1 bg-slate-200 rounded-full text-xs">75%</button>
                            <button onclick="setProgress(100)" class="px-3 py-1 bg-slate-200 rounded-full text-xs">100%</button>
                        </div>
                    </div>
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">√âtape</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="mobile-stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span>&#127959;</span><p class="text-sm font-medium">Pr√©paration</p></button>
                        <button class="mobile-stage-btn active p-3 rounded-xl border-2 border-primary-500 bg-primary-600 text-white text-left"><span>&#128296;</span><p class="text-sm font-medium">En cours</p></button>
                        <button class="mobile-stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span>&#10024;</span><p class="text-sm font-medium">Finitions</p></button>
                        <button class="mobile-stage-btn p-3 rounded-xl border-2 border-slate-200 text-left"><span>&#127968;</span><p class="text-sm font-medium">Livr√©</p></button>
                    </div>
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">üìÖ Fin estim√©e</label>
                    <input type="date" id="mobile-update-end-date" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Commentaire</label>
                    <textarea placeholder="Ex: Pose du carrelage termin√©e" rows="3" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm resize-none"></textarea>
                </div>
                <button onclick="sendUpdateWithLoading(this)" class="w-full bg-primary-600 text-white py-4 rounded-xl font-semibold mb-4">Envoyer la mise √† jour</button>
            </div>
        </div>

        <div id="mobile-screen-client" class="screen">
            <div class="sticky top-0 bg-white z-10 px-4 pt-4 pb-3 border-b border-slate-100">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-7 h-7 bg-primary-600 rounded-lg flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
                    <span class="font-bold text-primary-600 text-sm">SuiviTravaux<span class="text-slate-400">.app</span></span>
                </div>
                <h1 id="mobile-client-view-name" class="text-xl font-bold text-slate-800">Chantier</h1>
                <p id="mobile-client-view-artisan" class="text-slate-500 text-sm">Artisan : -</p>
            </div>
            <div class="px-4 py-3 pb-6">
                <div class="flex justify-center mb-5">
                    <div class="relative w-36 h-36">
                        <svg class="w-full h-full transform -rotate-90"><circle cx="72" cy="72" r="62" stroke="#e2e8f0" stroke-width="10" fill="none"></circle><circle id="mobile-client-progress-circle" cx="72" cy="72" r="62" stroke="#2563eb" stroke-width="10" fill="none" stroke-dasharray="390" stroke-dashoffset="390" stroke-linecap="round"></circle></svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="mobile-client-progress-percent" class="text-3xl font-bold text-slate-800">0%</span><span id="mobile-client-status" class="text-xs text-slate-500">-</span></div>
                    </div>
                </div>
                <div id="mobile-client-stages" class="flex justify-between mb-5 px-1">
                    <!-- Stages dynamiques -->
                </div>
                <div class="bg-slate-50 rounded-2xl p-4 mb-4">
                    <div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-slate-800 text-sm">Derni√®re mise √† jour</h3><span id="mobile-client-last-update" class="text-xs text-slate-400">-</span></div>
                    <p id="mobile-client-last-message" class="text-slate-600 text-sm mb-3">Aucune mise √† jour</p>
                    <div id="mobile-client-estimated-end" class="flex items-center gap-2 text-sm text-slate-600 pt-2 border-t border-slate-200">
                        <span>üìÖ</span>
                        <span>Fin estim√©e : <strong id="mobile-client-end-date">-</strong></span>
                    </div>
                </div>
                <h3 class="font-semibold text-slate-800 mb-3 text-sm">Historique complet</h3>
                <div id="mobile-client-history" class="space-y-2">
                    <!-- Historique dynamique -->
                </div>
                <!-- Contact artisan mobile -->
                <div id="mobile-client-contact-section" class="mt-4 pt-4 border-t border-slate-200" style="display: none;">
                    <h3 class="font-semibold text-slate-800 mb-3 text-sm">Contacter l'artisan</h3>
                    <div class="flex gap-2">
                        <a id="mobile-client-call-btn" href="tel:" class="flex-1 bg-primary-600 text-white py-2.5 rounded-xl font-medium flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            Appeler
                        </a>
                        <a id="mobile-client-whatsapp-btn" href="https://wa.me/" target="_blank" class="flex-1 bg-green-500 text-white py-2.5 rounded-xl font-medium flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>
                            WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="mobile-nav">
        <button onclick="showScreen('list')" data-screen-mobile="list" class="nav-btn-mobile flex-1 flex flex-col items-center py-2 text-primary-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            <span class="text-xs mt-1 font-medium">Chantiers</span>
        </button>
        <button onclick="showScreen('detail')" data-screen-mobile="detail" class="nav-btn-mobile flex-1 flex flex-col items-center py-2 text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span class="text-xs mt-1">D√©tail</span>
        </button>
        <button onclick="showScreen('update')" data-screen-mobile="update" class="nav-btn-mobile flex-1 flex flex-col items-center py-2 text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <span class="text-xs mt-1">Mise √† jour</span>
        </button>
        <button onclick="showScreen('client')" data-screen-mobile="client" class="nav-btn-mobile flex-1 flex flex-col items-center py-2 text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            <span class="text-xs mt-1">Vue client</span>
        </button>
    </nav>
</div>

<!-- Modal: Nouveau chantier -->
<div id="newChantierModal" class="modal-overlay" onclick="closeNewChantierModal(event)" role="dialog" aria-modal="true" aria-labelledby="newChantierModalTitle">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 id="newChantierModalTitle" class="text-xl font-bold text-slate-800">Nouveau chantier</h2>
            <button onclick="closeNewChantierModal()" class="p-2 text-slate-400 hover:text-slate-600" aria-label="Fermer">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <!-- Info limite essai -->
        <div id="new-chantier-trial-info" class="mb-4 hidden"></div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Nom du chantier *</label>
                <input type="text" id="new-chantier-name" placeholder="Ex: R√©novation cuisine" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" style="position: relative; z-index: 210;">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Nom du client *</label>
                <input type="text" id="new-client-name" placeholder="Ex: M. Dupont" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" style="position: relative; z-index: 210;">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Date de fin estim√©e</label>
                <input type="date" id="new-estimated-end" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" style="position: relative; z-index: 210;">
                <p class="text-xs text-slate-400 mt-1">Optionnel - Visible par le client</p>
            </div>
            <div class="pt-2 border-t border-slate-100">
                <p class="text-xs text-slate-400 mb-3">Informations affich√©es au client</p>
                <label class="block text-sm font-medium text-slate-700 mb-2">Votre nom (artisan) *</label>
                <input type="text" id="new-artisan-name" placeholder="Ex: Jean Dupont" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500" style="position: relative; z-index: 210;">
            </div>
            <div class="bg-blue-50 rounded-xl p-4 mt-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                    <div>
                        <p class="text-sm text-blue-800 font-medium">Lien client auto-g√©n√©r√©</p>
                        <p class="text-xs text-blue-600 mt-1">Un lien unique sera cr√©√© pour que votre client puisse suivre l'avancement (sans compte)</p>
                    </div>
                </div>
            </div>
            <button onclick="createChantierWithLoading(this)" class="w-full bg-primary-600 text-white py-4 rounded-xl font-semibold hover:bg-primary-700 mt-4">
                Cr√©er le chantier
            </button>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast">
    <span id="toast-message">Mise √† jour envoy√©e !</span>
</div>

<!-- Success Modal after update -->
<div id="successModal" class="modal-overlay" onclick="closeSuccessModal(event)">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">C'est envoy√© !</h2>
        <p class="text-slate-500 mb-6"><span id="success-client-name">Le client</span> va recevoir une notification</p>

        <!-- Client engagement - positive feedback -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 mb-6">
            <div class="flex items-center justify-center gap-3">
                <span class="text-2xl">üëÄ</span>
                <div class="text-left">
                    <p class="text-sm font-medium text-slate-700">Ce client consulte souvent</p>
                    <p class="text-xs text-green-600">3 visites cette semaine</p>
                </div>
            </div>
        </div>

        <button onclick="closeSuccessModal()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold">
            Parfait
        </button>
    </div>
</div>

<!-- Modal demande avis client (quand chantier termin√©) - VUE ARTISAN -->
<div id="reviewRequestModal" class="modal-overlay" onclick="closeReviewModal(event)">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Chantier termin√© !</h2>
        <p class="text-slate-500 mb-6">F√©licitations pour ce beau travail</p>

        <div class="bg-slate-50 rounded-xl p-4 mb-4">
            <p class="text-sm text-slate-600 mb-2"><span id="review-client-name">Le client</span> pourra laisser un avis si il le souhaite</p>
            <p class="text-xs text-slate-400">Un lien lui sera envoy√© automatiquement</p>
        </div>

        <button onclick="closeReviewModal()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold">
            Super !
        </button>
    </div>
</div>

<!-- Modal avis client (c√¥t√© client - FIN DE CHANTIER uniquement) -->
<div id="clientFeedbackModal" class="modal-overlay" onclick="closeClientFeedback(event)">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-6xl mb-4">üè†</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Chantier termin√© !</h2>
        <p id="client-thank-artisan" class="text-slate-500 mb-6">Merci d'avoir fait confiance √† votre artisan</p>

        <div id="client-feedback-modal-section" class="bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl p-5 mb-4">
            <p class="text-sm font-medium text-slate-700 mb-4">Comment s'est pass√©e cette exp√©rience ?</p>
            <div class="flex justify-center gap-4 mb-4">
                <button onclick="setClientMood(1)" class="client-mood text-4xl transition-all hover:scale-110 opacity-50 hover:opacity-100" data-mood="1">üòï</button>
                <button onclick="setClientMood(2)" class="client-mood text-4xl transition-all hover:scale-110 opacity-50 hover:opacity-100" data-mood="2">üôÇ</button>
                <button onclick="setClientMood(3)" class="client-mood text-4xl transition-all hover:scale-110 opacity-50 hover:opacity-100" data-mood="3">üòä</button>
                <button onclick="setClientMood(4)" class="client-mood text-4xl transition-all hover:scale-110" data-mood="4">ü§©</button>
            </div>
            <p class="text-xs text-slate-400" id="client-mood-hint">Votre avis est optionnel</p>
        </div>

        <div class="space-y-2">
            <button id="submit-mood-btn" onclick="submitClientMood()" disabled class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold disabled:opacity-50">
                Envoyer mon ressenti
            </button>
            <button onclick="closeClientFeedback()" class="w-full text-slate-400 py-2 text-sm">
                Passer
            </button>
        </div>
    </div>
</div>

<!-- Modal Profil Artisan -->
<div id="profileModal" class="modal-overlay" onclick="closeProfileModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Mon profil</h2>
            <button onclick="closeProfileModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Avatar -->
        <div class="flex flex-col items-center mb-6">
            <div id="profile-avatar" class="w-20 h-20 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mb-3">JD</div>
            <h3 id="profile-name" class="text-lg font-semibold text-slate-800">-</h3>
            <p id="profile-since" class="text-sm text-slate-500">Artisan depuis -</p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p id="profile-chantiers-count" class="text-xl font-bold text-slate-800">0</p>
                <p class="text-xs text-slate-500">Chantiers</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p id="profile-note" class="text-xl font-bold text-slate-800">-</p>
                <p class="text-xs text-slate-500">Note</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p id="profile-satisfaction" class="text-xl font-bold text-slate-800">-</p>
                <p class="text-xs text-slate-500">Satisfaits</p>
            </div>
        </div>

        <!-- Options -->
        <div class="space-y-2">
            <button onclick="showEditProfileForm()" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="text-sm font-medium text-slate-700">Modifier mon profil</span>
                </div>
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <button onclick="closeProfileModal(); showNotificationsModal();" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span class="text-sm font-medium text-slate-700">Notifications</span>
                </div>
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <button onclick="toggleDarkMode()" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="flex items-center gap-3">
                    <span class="text-lg" id="dark-mode-icon">üåô</span>
                    <span class="text-sm font-medium text-slate-700" id="dark-mode-label">Mode sombre</span>
                </div>
                <div class="w-12 h-6 bg-slate-300 rounded-full relative transition-colors" id="dark-mode-toggle">
                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform shadow" id="dark-mode-knob"></div>
                </div>
            </button>
            <button onclick="closeProfileModal(); showSupportModal();" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="text-sm font-medium text-slate-700">Aide & Support</span>
                </div>
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <button onclick="closeProfileModal(); showSubscriptionModal();" class="w-full flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    <span class="text-sm font-medium text-slate-700">Mon abonnement</span>
                </div>
                <span id="subscription-badge" class="px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 rounded-full">Essai</span>
            </button>
            <button onclick="closeProfileModal(); showOnboarding();" class="w-full flex items-center justify-between p-4 bg-primary-50 rounded-xl hover:bg-primary-100">
                <div class="flex items-center gap-3">
                    <span class="text-lg">üéì</span>
                    <span class="text-sm font-medium text-primary-700">Revoir le tutoriel</span>
                </div>
                <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>

        <!-- Liens l√©gaux -->
        <div class="mt-4 flex justify-center gap-4 text-xs">
            <button onclick="closeProfileModal(); showLegalModal('privacy');" class="text-slate-400 hover:text-primary-600">Confidentialit√©</button>
            <span class="text-slate-300">‚Ä¢</span>
            <button onclick="closeProfileModal(); showLegalModal('terms');" class="text-slate-400 hover:text-primary-600">CGU</button>
            <span class="text-slate-300">‚Ä¢</span>
            <button onclick="closeProfileModal(); showLegalModal('legal');" class="text-slate-400 hover:text-primary-600">Mentions l√©gales</button>
        </div>

        <button onclick="handleLogout()" class="w-full mt-4 py-3 text-red-500 text-sm font-medium">
            Se d√©connecter
        </button>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal-overlay" onclick="closeEditProfileModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Modifier mon profil</h2>
            <button onclick="closeEditProfileModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nom complet</label>
                <input type="text" id="edit-profile-name" placeholder="Votre nom"
                    class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">T√©l√©phone</label>
                <input type="tel" id="edit-profile-phone" placeholder="0692 12 34 56"
                    class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                <input type="email" id="edit-profile-email" disabled
                    class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm bg-slate-50 text-slate-500">
                <p class="text-xs text-slate-400 mt-1">L'email ne peut pas √™tre modifi√©</p>
            </div>

            <p id="edit-profile-error" class="text-red-500 text-sm hidden"></p>
            <p id="edit-profile-success" class="text-green-600 text-sm hidden"></p>

            <button onclick="saveProfile()" id="save-profile-btn" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700">
                Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Notifications Modal -->
<div id="notificationsModal" class="modal-overlay" onclick="closeNotificationsModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Notifications</h2>
            <button onclick="closeNotificationsModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- √âtat des notifications -->
        <div id="notif-status" class="mb-6 p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="flex items-center gap-3">
                <div id="notif-status-icon" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                </div>
                <div>
                    <p id="notif-status-text" class="font-medium text-slate-700">Notifications d√©sactiv√©es</p>
                    <p id="notif-status-desc" class="text-xs text-slate-500">Activez pour recevoir les alertes</p>
                </div>
            </div>
        </div>

        <!-- Toggle principal -->
        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                <div class="flex items-center gap-3">
                    <span class="text-lg">üîî</span>
                    <div>
                        <span class="text-sm font-medium text-slate-700">Activer les notifications</span>
                        <p class="text-xs text-slate-500">Recevoir les alertes sur cet appareil</p>
                    </div>
                </div>
                <button onclick="toggleNotifications()" id="notif-toggle" class="w-12 h-6 bg-slate-300 rounded-full relative transition-colors">
                    <div id="notif-toggle-knob" class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform shadow"></div>
                </button>
            </div>

            <!-- Options de notifications -->
            <div id="notif-options" class="space-y-3 opacity-50 pointer-events-none">
                <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Types de notifications</p>

                <label class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span class="text-lg">üëÅÔ∏è</span>
                        <span class="text-sm text-slate-700">Client a vu la mise √† jour</span>
                    </div>
                    <input type="checkbox" id="notif-client-view" checked class="w-5 h-5 rounded text-primary-600 focus:ring-primary-500">
                </label>

                <label class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span class="text-lg">‚≠ê</span>
                        <span class="text-sm text-slate-700">Nouveau feedback client</span>
                    </div>
                    <input type="checkbox" id="notif-feedback" checked class="w-5 h-5 rounded text-primary-600 focus:ring-primary-500">
                </label>

                <label class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span class="text-lg">üìä</span>
                        <span class="text-sm text-slate-700">Rappel de mise √† jour (7j)</span>
                    </div>
                    <input type="checkbox" id="notif-reminder" class="w-5 h-5 rounded text-primary-600 focus:ring-primary-500">
                </label>
            </div>
        </div>

        <!-- Info navigateur -->
        <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-xl">
            <p class="text-xs text-blue-700">
                <strong>Note :</strong> Les notifications n√©cessitent votre autorisation dans le navigateur.
                Si bloqu√©es, autorisez-les dans les param√®tres de votre navigateur.
            </p>
        </div>
    </div>
</div>

<!-- Aide & Support Modal -->
<div id="supportModal" class="modal-overlay" onclick="closeSupportModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Aide & Support</h2>
            <button onclick="closeSupportModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- FAQ -->
        <div class="space-y-3 mb-6">
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Utilisation</p>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Comment partager un chantier avec mon client ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Ouvrez le chantier concern√©</li>
                        <li>Allez sur l'onglet "Vue client"</li>
                        <li>Cliquez sur "Copier le lien"</li>
                        <li>Envoyez ce lien par SMS, WhatsApp ou email</li>
                    </ol>
                    <p class="mt-2 text-slate-500">Votre client pourra suivre l'avancement en temps r√©el, sans cr√©er de compte.</p>
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Comment ajouter des photos et messages vocaux ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Lors d'une mise √† jour de chantier :
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Photo :</strong> Cliquez sur l'ic√¥ne appareil photo pour prendre ou choisir une image</li>
                        <li><strong>Message vocal :</strong> Maintenez le bouton micro pour enregistrer (pratique sur chantier !)</li>
                    </ul>
                    <p class="mt-2 text-slate-500">Vos clients verront les photos et pourront √©couter vos messages.</p>
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">L'application fonctionne-t-elle hors connexion ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    L'application n√©cessite une connexion internet pour synchroniser vos donn√©es. Cependant, vous pouvez l'installer sur votre t√©l√©phone comme une app native :
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>iPhone :</strong> Safari ‚Üí Partager ‚Üí "Sur l'√©cran d'accueil"</li>
                        <li><strong>Android :</strong> Chrome ‚Üí Menu ‚Üí "Installer l'application"</li>
                    </ul>
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Comment g√©rer plusieurs chantiers en parall√®le ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Tous vos chantiers actifs s'affichent sur la page d'accueil. Cliquez sur un chantier pour voir ses d√©tails ou le mettre √† jour. Les chantiers termin√©s peuvent √™tre archiv√©s pour garder une liste claire.
                </div>
            </details>
        </div>

        <div class="space-y-3 mb-6">
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Abonnement & Tarifs</p>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Combien co√ªte SuiviTravaux.app ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    <p class="mb-2">Nous proposons une <strong>p√©riode d'essai gratuite de 14 jours</strong>, puis :</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Abonnement mensuel :</strong> 9,90‚Ç¨/mois</li>
                        <li><strong>Abonnement annuel :</strong> 99‚Ç¨/an (2 mois offerts)</li>
                    </ul>
                    <p class="mt-2 text-slate-500">Chantiers illimit√©s, photos illimit√©es, support prioritaire inclus.</p>
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Puis-je annuler mon abonnement √† tout moment ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Oui, sans engagement. Vous pouvez annuler depuis les param√®tres de votre compte. Votre acc√®s reste actif jusqu'√† la fin de la p√©riode pay√©e. Vos donn√©es sont conserv√©es 30 jours apr√®s expiration.
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Quels moyens de paiement acceptez-vous ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Carte bancaire (Visa, Mastercard), PayPal. Les paiements sont s√©curis√©s et trait√©s par Stripe. Nous ne stockons jamais vos informations bancaires.
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Proposez-vous des factures pour la comptabilit√© ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Oui, une facture conforme est g√©n√©r√©e automatiquement √† chaque paiement. Vous pouvez les t√©l√©charger depuis votre espace abonnement. D√©ductible de vos charges professionnelles.
                </div>
            </details>
        </div>

        <div class="space-y-3 mb-6">
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">S√©curit√© & Donn√©es</p>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Mes donn√©es et celles de mes clients sont-elles prot√©g√©es ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Absolument. Nous utilisons :
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Chiffrement SSL/TLS pour toutes les communications</li>
                        <li>Serveurs s√©curis√©s en Europe (conformit√© RGPD)</li>
                        <li>Acc√®s restreint : seuls vous et vos clients peuvent voir vos chantiers</li>
                        <li>Aucune revente de donn√©es √† des tiers</li>
                    </ul>
                </div>
            </details>

            <details class="group bg-slate-50 rounded-xl overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                    <span class="text-sm font-medium text-slate-700">Puis-je exporter ou supprimer mes donn√©es ?</span>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="px-4 pb-4 text-sm text-slate-600">
                    Oui, conform√©ment au RGPD, vous avez le droit d'exporter toutes vos donn√©es ou de demander leur suppression compl√®te. Contactez-nous √† <a href="mailto:privacy@suivitravaux.app" class="text-primary-600 underline">privacy@suivitravaux.app</a>.
                </div>
            </details>
        </div>

        <!-- Contact -->
        <div class="space-y-3">
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nous contacter</p>

            <a href="mailto:support@suivitravaux.app" class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl hover:bg-slate-100">
                <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-700">Email</p>
                    <p class="text-xs text-slate-500">support@suivitravaux.app</p>
                </div>
            </a>
            <p class="text-xs text-slate-400 text-center mt-2">R√©ponse sous 24-48h</p>
        </div>

        <!-- Version -->
        <div class="mt-6 pt-4 border-t border-slate-200 text-center">
            <p class="text-xs text-slate-400">SuiviTravaux.app v1.0.0</p>
            <p class="text-xs text-slate-400 mt-1">Made with ‚ù§Ô∏è pour les artisans</p>
        </div>
    </div>
</div>

<!-- Legal Modal (Confidentialit√©, CGU, Mentions l√©gales) -->
<div id="legalModal" class="modal-overlay" onclick="closeLegalModal(event)">
    <div class="modal-content" style="max-height: 85vh;" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2">
            <h2 id="legal-title" class="text-xl font-bold text-slate-800">Informations l√©gales</h2>
            <button onclick="closeLegalModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Navigation onglets -->
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
            <button onclick="showLegalTab('privacy')" id="tab-privacy" class="legal-tab px-3 py-1.5 text-sm font-medium rounded-full bg-primary-600 text-white whitespace-nowrap">
                Confidentialit√©
            </button>
            <button onclick="showLegalTab('terms')" id="tab-terms" class="legal-tab px-3 py-1.5 text-sm font-medium rounded-full bg-slate-100 text-slate-600 whitespace-nowrap">
                CGU
            </button>
            <button onclick="showLegalTab('legal')" id="tab-legal" class="legal-tab px-3 py-1.5 text-sm font-medium rounded-full bg-slate-100 text-slate-600 whitespace-nowrap">
                Mentions l√©gales
            </button>
        </div>

        <!-- Contenu Confidentialit√© -->
        <div id="legal-privacy" class="legal-content text-sm text-slate-600 space-y-4 overflow-y-auto" style="max-height: 55vh;">
            <p class="text-xs text-slate-400">Derni√®re mise √† jour : Janvier 2025</p>

            <h3 class="font-semibold text-slate-800">1. Collecte des donn√©es</h3>
            <p>SuiviTravaux.app collecte uniquement les donn√©es n√©cessaires au fonctionnement du service :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li><strong>Donn√©es de compte :</strong> Email, nom, t√©l√©phone (optionnel)</li>
                <li><strong>Donn√©es de chantiers :</strong> Nom du chantier, client, avancement, photos</li>
                <li><strong>Donn√©es techniques :</strong> Logs de connexion, type d'appareil</li>
            </ul>

            <h3 class="font-semibold text-slate-800">2. Utilisation des donn√©es</h3>
            <p>Vos donn√©es sont utilis√©es exclusivement pour :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Fournir le service de suivi de chantier</li>
                <li>Permettre le partage avec vos clients</li>
                <li>Am√©liorer l'application</li>
                <li>Vous contacter en cas de besoin (support)</li>
            </ul>

            <h3 class="font-semibold text-slate-800">3. Partage des donn√©es</h3>
            <p>Nous ne vendons jamais vos donn√©es. Elles peuvent √™tre partag√©es avec :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li><strong>Vos clients :</strong> Via les liens de partage que vous cr√©ez</li>
                <li><strong>Supabase :</strong> Notre h√©bergeur de base de donn√©es (serveurs UE)</li>
            </ul>

            <h3 class="font-semibold text-slate-800">4. S√©curit√©</h3>
            <p>Vos donn√©es sont prot√©g√©es par :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Chiffrement SSL/TLS pour toutes les communications</li>
                <li>Authentification s√©curis√©e</li>
                <li>Acc√®s restreint aux donn√©es (Row Level Security)</li>
            </ul>

            <h3 class="font-semibold text-slate-800">5. Conservation</h3>
            <p>Vos donn√©es sont conserv√©es tant que votre compte est actif. Vous pouvez demander leur suppression √† tout moment.</p>

            <h3 class="font-semibold text-slate-800">6. Vos droits (RGPD)</h3>
            <p>Conform√©ment au RGPD, vous disposez des droits suivants :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li><strong>Acc√®s :</strong> Obtenir une copie de vos donn√©es</li>
                <li><strong>Rectification :</strong> Modifier vos informations</li>
                <li><strong>Suppression :</strong> Demander l'effacement de vos donn√©es</li>
                <li><strong>Portabilit√© :</strong> R√©cup√©rer vos donn√©es dans un format standard</li>
            </ul>
            <p class="mt-2">Pour exercer ces droits : <a href="mailto:privacy@suivitravaux.app" class="text-primary-600">privacy@suivitravaux.app</a></p>

            <h3 class="font-semibold text-slate-800">7. Cookies</h3>
            <p>Nous utilisons uniquement des cookies essentiels au fonctionnement (authentification, pr√©f√©rences). Aucun cookie publicitaire.</p>
        </div>

        <!-- Contenu CGU -->
        <div id="legal-terms" class="legal-content text-sm text-slate-600 space-y-4 overflow-y-auto hidden" style="max-height: 55vh;">
            <p class="text-xs text-slate-400">Derni√®re mise √† jour : Janvier 2025</p>

            <h3 class="font-semibold text-slate-800">1. Objet</h3>
            <p>Les pr√©sentes Conditions G√©n√©rales d'Utilisation (CGU) r√©gissent l'acc√®s et l'utilisation de SuiviTravaux.app, application professionnelle de suivi de chantier destin√©e aux artisans du b√¢timent.</p>

            <h3 class="font-semibold text-slate-800">2. Licence d'utilisation</h3>
            <p>En souscrivant √† SuiviTravaux.app, vous obtenez une <strong>licence d'utilisation personnelle et non-exclusive</strong> du service. Cette licence vous accorde :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Le droit d'utiliser l'application pour votre activit√© professionnelle</li>
                <li>L'acc√®s aux mises √† jour et nouvelles fonctionnalit√©s</li>
                <li>Le support technique par email</li>
            </ul>
            <p class="mt-2">Cette licence <strong>ne vous conf√®re pas</strong> :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>La propri√©t√© du code source ou de l'application</li>
                <li>Le droit de revendre, copier ou redistribuer l'application</li>
                <li>Le droit de modifier ou cr√©er des d√©riv√©s du service</li>
            </ul>

            <h3 class="font-semibold text-slate-800">3. Tarification et paiement</h3>
            <p><strong>Essai gratuit :</strong> 14 jours sans engagement ni carte bancaire.</p>
            <p class="mt-2"><strong>Abonnements :</strong></p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Mensuel : 9,90‚Ç¨ TTC/mois, renouvel√© automatiquement</li>
                <li>Annuel : 99‚Ç¨ TTC/an (√©conomie de 2 mois)</li>
                <li>Licence √† vie : 199‚Ç¨ TTC (paiement unique)</li>
            </ul>
            <p class="mt-2">Les prix peuvent √™tre modifi√©s. Tout changement sera notifi√© 30 jours √† l'avance et n'affectera pas les abonnements en cours.</p>

            <h3 class="font-semibold text-slate-800">4. Renouvellement et r√©siliation</h3>
            <p>Les abonnements sont renouvel√©s automatiquement. Vous pouvez annuler √† tout moment depuis les param√®tres de votre compte. L'annulation prend effet √† la fin de la p√©riode pay√©e.</p>
            <p class="mt-2"><strong>Aucun remboursement</strong> n'est accord√© pour les p√©riodes entam√©es, sauf disposition l√©gale contraire.</p>

            <h3 class="font-semibold text-slate-800">5. Responsabilit√©s de l'utilisateur</h3>
            <p>L'utilisateur s'engage √† :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Fournir des informations exactes lors de l'inscription</li>
                <li>Prot√©ger ses identifiants de connexion</li>
                <li>Utiliser le service de mani√®re l√©gale et professionnelle</li>
                <li>Ne pas partager de contenus illicites, diffamatoires ou violant les droits de tiers</li>
                <li>Ne pas tenter de contourner les mesures de s√©curit√©</li>
            </ul>

            <h3 class="font-semibold text-slate-800">6. Propri√©t√© intellectuelle</h3>
            <p>L'application SuiviTravaux.app, son code source, son design et sa marque sont la propri√©t√© exclusive de l'√©diteur et prot√©g√©s par le droit d'auteur.</p>
            <p class="mt-2">Les contenus que vous cr√©ez (photos, textes, donn√©es de chantiers) restent votre propri√©t√©. Vous nous accordez une licence limit√©e pour les stocker et les afficher dans le cadre du service.</p>

            <h3 class="font-semibold text-slate-800">7. Disponibilit√© et limitation de responsabilit√©</h3>
            <p>Nous nous effor√ßons d'assurer une disponibilit√© optimale mais ne garantissons pas un service sans interruption. Des maintenances peuvent √™tre effectu√©es.</p>
            <p class="mt-2">Notre responsabilit√© est limit√©e au montant des sommes vers√©es au cours des 12 derniers mois. Nous ne sommes pas responsables des dommages indirects.</p>

            <h3 class="font-semibold text-slate-800">8. Suspension et r√©siliation</h3>
            <p>Nous nous r√©servons le droit de suspendre ou r√©silier un compte en cas de :</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Non-paiement apr√®s relance</li>
                <li>Violation des pr√©sentes CGU</li>
                <li>Utilisation frauduleuse du service</li>
            </ul>

            <h3 class="font-semibold text-slate-800">9. Droit applicable</h3>
            <p>Les pr√©sentes CGU sont soumises au droit fran√ßais. En cas de litige, une solution amiable sera recherch√©e. √Ä d√©faut, les tribunaux de Saint-Denis de La R√©union seront comp√©tents.</p>
        </div>

        <!-- Contenu Mentions l√©gales -->
        <div id="legal-legal" class="legal-content text-sm text-slate-600 space-y-4 overflow-y-auto hidden" style="max-height: 55vh;">
            <h3 class="font-semibold text-slate-800">√âditeur du site</h3>
            <p>
                SuiviTravaux.app<br>
                Application web de suivi de chantier<br>
                Email : <a href="mailto:contact@suivitravaux.app" class="text-primary-600">contact@suivitravaux.app</a>
            </p>

            <h3 class="font-semibold text-slate-800">H√©bergement</h3>
            <p>
                <strong>Application :</strong> Vercel Inc.<br>
                440 N Barranca Ave #4133, Covina, CA 91723, USA<br><br>
                <strong>Base de donn√©es :</strong> Supabase Inc.<br>
                970 Toa Payoh North, Singapore 318992
            </p>

            <h3 class="font-semibold text-slate-800">Propri√©t√© intellectuelle</h3>
            <p>L'ensemble du contenu de SuiviTravaux.app (logos, textes, code source, design) est prot√©g√© par le droit d'auteur et reste la propri√©t√© exclusive de l'√©diteur.</p>

            <h3 class="font-semibold text-slate-800">Protection des donn√©es</h3>
            <p>
                Conform√©ment au R√®glement G√©n√©ral sur la Protection des Donn√©es (RGPD), vous disposez d'un droit d'acc√®s, de rectification et de suppression de vos donn√©es personnelles.<br><br>
                D√©l√©gu√© √† la protection des donn√©es : <a href="mailto:privacy@suivitravaux.app" class="text-primary-600">privacy@suivitravaux.app</a>
            </p>

            <h3 class="font-semibold text-slate-800">Cr√©dits</h3>
            <p>
                Ic√¥nes : Heroicons<br>
                Police : Inter (Google Fonts)<br>
                Framework CSS : Tailwind CSS
            </p>
        </div>
    </div>
</div>

<!-- Subscription Modal -->
<div id="subscriptionModal" class="modal-overlay" onclick="closeSubscriptionModal(event)">
    <div class="modal-content" style="max-height: 90vh;" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-slate-800">Mon abonnement</h2>
            <button onclick="closeSubscriptionModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Statut actuel -->
        <div id="subscription-status" class="mb-6 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">üéÅ</span>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">P√©riode d'essai</p>
                    <p class="text-sm text-slate-600">Il vous reste <strong id="trial-days">14 jours</strong></p>
                </div>
            </div>
            <div class="h-2 bg-amber-200 rounded-full overflow-hidden mt-3">
                <div id="trial-progress" class="h-full bg-amber-500 rounded-full" style="width: 100%"></div>
            </div>
        </div>

        <!-- Offres -->
        <p class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-3">Choisir une offre</p>

        <div class="space-y-3 mb-6">
            <!-- Mensuel -->
            <label class="block cursor-pointer">
                <input type="radio" name="plan" value="monthly" class="hidden peer">
                <div class="p-4 border-2 border-slate-200 rounded-xl peer-checked:border-primary-600 peer-checked:bg-primary-50 transition-all">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-slate-800">Mensuel</p>
                            <p class="text-sm text-slate-500">Sans engagement</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-slate-800">9,90‚Ç¨</p>
                            <p class="text-xs text-slate-500">/mois</p>
                        </div>
                    </div>
                </div>
            </label>

            <!-- Annuel (recommand√©) -->
            <label class="block cursor-pointer">
                <input type="radio" name="plan" value="yearly" class="hidden peer" checked>
                <div class="p-4 border-2 border-slate-200 rounded-xl peer-checked:border-primary-600 peer-checked:bg-primary-50 transition-all relative">
                    <span class="absolute -top-2 left-4 px-2 py-0.5 bg-green-500 text-white text-xs font-medium rounded-full">2 mois offerts</span>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-slate-800">Annuel</p>
                            <p class="text-sm text-slate-500">Meilleur rapport qualit√©/prix</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-slate-800">99‚Ç¨</p>
                            <p class="text-xs text-slate-500">/an <span class="line-through text-slate-400">118,80‚Ç¨</span></p>
                        </div>
                    </div>
                </div>
            </label>

            <!-- Licence √† vie (discret) -->
            <details class="group">
                <summary class="flex items-center justify-center gap-2 py-2 text-sm text-slate-400 cursor-pointer hover:text-slate-600">
                    <span>Autres options</span>
                    <svg class="w-4 h-4 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <label class="block cursor-pointer mt-3">
                    <input type="radio" name="plan" value="lifetime" class="hidden peer">
                    <div class="p-4 border-2 border-slate-200 rounded-xl peer-checked:border-primary-600 peer-checked:bg-primary-50 transition-all">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-slate-800">Licence √† vie</p>
                                <p class="text-sm text-slate-500">Paiement unique, acc√®s permanent</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-slate-800">199‚Ç¨</p>
                                <p class="text-xs text-slate-500">une seule fois</p>
                            </div>
                        </div>
                    </div>
                </label>
            </details>
        </div>

        <!-- Comparaison Essai vs Pro -->
        <div class="bg-slate-50 rounded-xl p-4 mb-6">
            <p class="text-sm font-medium text-slate-700 mb-3">Ce qui change avec la version Pro :</p>
            <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Nombre de chantiers</span>
                    <div class="flex items-center gap-3">
                        <span class="text-slate-400 line-through">3 max</span>
                        <span class="text-green-600 font-semibold">Illimit√© ‚úì</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Photos et vocaux</span>
                    <span class="text-green-600 font-semibold">Illimit√© ‚úì</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Partage client</span>
                    <span class="text-green-600 font-semibold">Illimit√© ‚úì</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Sync temps r√©el</span>
                    <span class="text-green-600 font-semibold">‚úì</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Support prioritaire</span>
                    <span class="text-green-600 font-semibold">‚úì</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-600">Mises √† jour incluses</span>
                    <span class="text-green-600 font-semibold">‚úì</span>
                </div>
            </div>
        </div>

        <!-- Bouton -->
        <button onclick="handleSubscribe()" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            S'abonner maintenant
        </button>

        <p class="text-xs text-slate-400 text-center mt-3">Paiement s√©curis√© par Stripe. Annulation possible √† tout moment.</p>
    </div>
</div>

<!-- Modal Limite Atteinte (Trial) -->
<div id="trialLimitModal" class="modal-overlay" onclick="closeTrialLimitModal(event)">
    <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
        <div class="text-center">
            <!-- Illustration -->
            <div class="w-20 h-20 bg-gradient-to-br from-amber-100 to-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-4xl">üöÄ</span>
            </div>

            <h2 class="text-xl font-bold text-slate-800 mb-2">Vous avez atteint la limite</h2>
            <p class="text-slate-600 mb-4">La version d'essai est limit√©e √† <strong>3 chantiers</strong>.</p>

            <!-- Ce que l'utilisateur manque -->
            <div class="bg-gradient-to-r from-primary-50 to-blue-50 rounded-xl p-4 mb-6 text-left">
                <p class="text-sm font-medium text-slate-700 mb-3">Passez √† la version Pro pour d√©bloquer :</p>
                <ul class="space-y-2 text-sm text-slate-600">
                    <li class="flex items-center gap-2">
                        <span class="text-green-500 font-bold">‚úì</span>
                        <span><strong>Chantiers illimit√©s</strong> - Plus de limite</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-green-500 font-bold">‚úì</span>
                        <span>Historique complet de vos projets</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-green-500 font-bold">‚úì</span>
                        <span>Support prioritaire</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <span class="text-green-500 font-bold">‚úì</span>
                        <span>Fonctionnalit√©s avanc√©es √† venir</span>
                    </li>
                </ul>
            </div>

            <!-- Offre sp√©ciale -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-6">
                <p class="text-sm text-amber-800">
                    <span class="font-semibold">üéÅ Offre sp√©ciale :</span> Passez au plan annuel et √©conomisez <strong>2 mois</strong>
                </p>
            </div>

            <!-- Boutons -->
            <div class="space-y-3">
                <button onclick="closeTrialLimitModal(); showSubscriptionModal();" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Passer √† la version Pro
                </button>
                <button onclick="closeTrialLimitModal()" class="w-full text-slate-500 py-2 text-sm hover:text-slate-700">
                    Continuer avec mes 3 chantiers
                </button>
            </div>

            <p class="text-xs text-slate-400 mt-4">√Ä partir de 9,90‚Ç¨/mois ‚Ä¢ Annulation √† tout moment</p>
        </div>
    </div>
</div>

<!-- Archives Modal -->
<div id="archivesModal" class="modal-overlay" onclick="closeArchivesModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Chantiers archiv√©s</h2>
            <button onclick="closeArchivesModal()" class="p-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="archives-list" class="max-h-96 overflow-y-auto">
            <!-- Liste des archives g√©n√©r√©e dynamiquement -->
        </div>
    </div>
</div>

<!-- Auth Modal - Connexion/Inscription -->
<div id="authModal" class="modal-overlay" style="align-items: center; background: rgba(0,0,0,0.9);" role="dialog" aria-labelledby="authModalTitle">
    <div class="bg-white rounded-3xl w-full max-w-sm mx-4 overflow-hidden">
        <div class="p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </div>
                <h2 id="authModalTitle" class="text-2xl font-bold text-slate-800">SuiviTravaux<span class="text-primary-600">.app</span></h2>
                <p class="text-slate-500 text-sm mt-1">Light, simple, efficace</p>
            </div>

            <!-- B√©n√©fices - Section valeur -->
            <div id="auth-benefits" class="mb-6 space-y-2">
                <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                    <span class="text-xl">üìµ</span>
                    <p class="text-sm text-slate-600">Fini les appels r√©p√©t√©s sur l'avancement du chantier</p>
                </div>
                <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                    <span class="text-xl">üì∏</span>
                    <p class="text-sm text-slate-600">1 photo = client inform√© en 30 secondes</p>
                </div>
                <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                    <span class="text-xl">üòå</span>
                    <p class="text-sm text-slate-600">Moins de stress, plus de confiance client</p>
                </div>
            </div>

            <!-- Login Form -->
            <div id="auth-login-form">
                <form id="login-form" method="post" action="#" onsubmit="event.preventDefault(); handleLogin(); return false;" autocomplete="on" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="login-email" name="email" autocomplete="email" placeholder="votre@email.com"
                            class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-700 mb-1">Mot de passe</label>
                        <input type="password" id="login-password" name="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" id="login-btn" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700">
                        Se connecter
                    </button>
                </form>
                <p class="text-center text-sm text-slate-500 mt-4">
                    Pas encore de compte ? <button type="button" onclick="showSignupForm()" class="text-primary-600 font-medium">S'inscrire</button>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="auth-signup-form" class="hidden">
                <form id="signup-form" onsubmit="event.preventDefault(); handleSignup();" autocomplete="on" class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-slate-700 mb-1">Votre nom</label>
                        <input type="text" id="signup-name" name="name" autocomplete="name" placeholder="Jean Dupont"
                            class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label for="signup-phone" class="block text-sm font-medium text-slate-700 mb-1">T√©l√©phone <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="signup-phone-prefix" name="phone-prefix" class="border border-slate-200 rounded-xl px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 bg-slate-50">
                                <option value="+262">üá∑üá™ +262</option>
                                <option value="+33">üá´üá∑ +33</option>
                                <option value="+596">üá≤üá∂ +596</option>
                                <option value="+594">üá¨üá´ +594</option>
                            </select>
                            <input type="tel" id="signup-phone" name="phone" autocomplete="tel-national" placeholder="0692 XX XX XX"
                                class="flex-1 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                        </div>
                        <p class="text-xs text-slate-400 mt-1">1 compte par num√©ro - Protection anti-abus</p>
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="signup-email" name="email" autocomplete="email" placeholder="votre@email.com"
                            class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-slate-700 mb-1">Mot de passe</label>
                        <input type="password" id="signup-password" name="password" autocomplete="new-password" placeholder="Min. 6 caract√®res"
                            class="w-full border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <p id="signup-error" class="text-red-500 text-sm hidden"></p>
                    <p id="signup-success" class="text-green-600 text-sm hidden bg-green-50 p-3 rounded-xl"></p>
                    <button type="submit" id="signup-btn" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700">
                        D√©marrer mon essai gratuit
                    </button>
                    <p class="text-xs text-center text-slate-400">14 jours d'essai gratuit ‚Ä¢ Jusqu'√† 3 chantiers</p>
                </form>
                <p class="text-center text-sm text-slate-500 mt-4">
                    D√©j√† un compte ? <button type="button" onclick="showLoginForm()" class="text-primary-600 font-medium">Se connecter</button>
                </p>
            </div>

            <!-- Demo mode link -->
            <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                <button onclick="enterDemoMode()" class="text-sm text-slate-400 hover:text-slate-600">
                    Essayer en mode d√©mo ‚Üí
                </button>
            </div>

            <!-- Admin login (discret) -->
            <div id="admin-login-toggle" class="mt-3 text-center">
                <button onclick="showAdminLogin()" class="text-xs text-slate-300 hover:text-slate-500">
                    Acc√®s Pro
                </button>
            </div>

            <!-- Admin Login Form (cach√© par d√©faut) -->
            <div id="admin-login-form" class="hidden mt-4 pt-4 border-t border-slate-100">
                <p class="text-xs text-center text-slate-500 mb-3">Connexion compte Pro</p>
                <form onsubmit="handleAdminLogin(event)" class="space-y-3">
                    <input type="text" id="admin-username" placeholder="Identifiant" required
                        class="w-full border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <input type="password" id="admin-password" placeholder="Mot de passe" required
                        class="w-full border border-slate-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <p id="admin-error" class="text-red-500 text-xs hidden">Identifiants incorrects</p>
                    <button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-2 rounded-xl font-semibold text-sm hover:from-amber-600 hover:to-orange-600">
                        Connexion Pro
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Onboarding Modal -->
<div id="onboardingModal" class="modal-overlay" style="align-items: center; background: rgba(0,0,0,0.8);">
    <div class="bg-white rounded-3xl w-full max-w-sm mx-4 overflow-hidden" onclick="event.stopPropagation()">
        <div id="onboarding-slides" class="relative">
            <!-- Slide 1 -->
            <div class="onboarding-slide active p-8 text-center">
                <div class="text-6xl mb-6">üèóÔ∏è</div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">Bienvenue sur SuiviTravaux.app</h2>
                <p class="text-slate-600 mb-6">G√©rez vos chantiers et gardez vos clients inform√©s en temps r√©el</p>
                <div class="flex gap-2 justify-center mb-6">
                    <div class="w-2 h-2 rounded-full bg-primary-600"></div>
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                </div>
                <button onclick="nextOnboardingSlide()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium">Continuer</button>
            </div>
            <!-- Slide 2 -->
            <div class="onboarding-slide p-8 text-center" style="display:none;">
                <div class="text-6xl mb-6">üì∏</div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">Photo rapide</h2>
                <p class="text-slate-600 mb-6">Prenez une photo et votre client la voit instantanement. Pas de compte requis pour lui !</p>
                <div class="flex gap-2 justify-center mb-6">
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <div class="w-2 h-2 rounded-full bg-primary-600"></div>
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                </div>
                <button onclick="nextOnboardingSlide()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium">Continuer</button>
            </div>
            <!-- Slide 3 -->
            <div class="onboarding-slide p-8 text-center" style="display:none;">
                <div class="text-6xl mb-6">üîó</div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">Lien unique client</h2>
                <p class="text-slate-600 mb-6">Partagez un lien WhatsApp. Votre client suit l'avancement sans t√©l√©charger d'app</p>
                <div class="flex gap-2 justify-center mb-6">
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <div class="w-2 h-2 rounded-full bg-primary-600"></div>
                </div>
                <button onclick="closeOnboarding()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium">Commencer</button>
            </div>
        </div>
    </div>
</div>

<script>
// =============================================
// MODE APPLICATION (demo ou supabase)
// =============================================
let APP_MODE = 'demo'; // 'demo', 'supabase' ou 'admin'
let currentUser = null;
let IS_ADMIN_MODE = false; // Mode admin = compte pro sans restrictions

// =============================================
// COMPTES ADMIN PRO (identifiant/mot de passe)
// =============================================
const ADMIN_ACCOUNTS = {
    'ProDemo': 'SuiviPro2024!',
    'ClientVIP': 'VIP@2024',
    'TestPro': 'TestPro123'
    // Ajouter d'autres comptes ici au besoin
};

// Enregistrer le Service Worker pour PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
            })
            .catch((error) => {
                console.log('Service Worker non enregistr√©:', error);
            });
    });
}

// Flag pour savoir si les donn√©es sont charg√©es
let dataLoaded = false;

// Initialiser Supabase au chargement
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîÑ Chargement de l\'application...');
    console.log('üì¶ SuiviTravauxAPI disponible:', !!window.SuiviTravauxAPI);
    console.log('üì¶ Supabase SDK disponible:', !!window.supabase);

    // Afficher le modal auth imm√©diatement (non bloquant)
    showAuthModal();

    // Initialiser l'API Supabase en arri√®re-plan
    if (window.SuiviTravauxAPI && window.supabase) {
        try {
            const client = SuiviTravauxAPI.init();
            if (!client) {
                console.log('Supabase non initialis√©, mode d√©mo');
                return;
            }

            // V√©rifier si l'utilisateur est d√©j√† connect√© (en arri√®re-plan, non bloquant)
            setTimeout(async () => {
                try {
                    const user = await Promise.race([
                        SuiviTravauxAPI.Auth.getCurrentUser(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000))
                    ]);

                    if (user) {
                        currentUser = user;
                        APP_MODE = 'supabase';
                        await loadSupabaseData();
                        hideAuthModal();
                    }
                } catch (e) {
                    console.log('V√©rification auth:', e.message);
                    // Modal d√©j√† affich√©, rien √† faire
                }
            }, 100);
        } catch (e) {
            console.log('Erreur init Supabase:', e.message);
        }
    } else {
        console.log('Supabase SDK non disponible, mode d√©mo');
    }
});

// =============================================
// AUTHENTIFICATION
// =============================================

// =============================================
// GESTION DES CREDENTIALS NAVIGATEUR
// =============================================
// Propose d'enregistrer les identifiants apr√®s connexion/inscription r√©ussie

// V√©rifier si l'utilisateur a refus√© l'enregistrement
function hasDeclinedCredentialSave() {
    return localStorage.getItem('credential_save_declined') === 'true';
}

// Marquer comme refus√©
function declineCredentialSave() {
    localStorage.setItem('credential_save_declined', 'true');
}

// Proposer d'enregistrer les identifiants (non bloquant)
async function offerSaveCredentials(email, password) {
    // Sauvegarder l'email en localStorage pour pr√©-remplissage
    saveLastEmail(email);

    // V√©rifier si l'API Credential est disponible
    if (!window.PasswordCredential) {
        console.log('üíæ Credential Management API non support√©e - email sauv√© localement');
        return;
    }

    // Ne pas proposer si d√©j√† refus√©
    if (hasDeclinedCredentialSave()) {
        console.log('üíæ Enregistrement des identifiants d√©j√† refus√©');
        return;
    }

    try {
        const credential = new PasswordCredential({
            id: email,
            password: password,
            name: email
        });

        // Stocker les credentials (le navigateur demandera confirmation)
        await navigator.credentials.store(credential);
        console.log('üíæ Identifiants enregistr√©s');
    } catch (error) {
        // L'utilisateur a annul√© ou refus√©
        if (error.name === 'NotAllowedError') {
            declineCredentialSave();
            console.log('üíæ Enregistrement refus√© par l\'utilisateur');
        } else {
            console.log('üíæ Erreur enregistrement credentials:', error.message);
        }
    }
}

// Sauvegarder le dernier email utilis√©
function saveLastEmail(email) {
    localStorage.setItem('last_login_email', email);
}

// R√©cup√©rer le dernier email utilis√©
function getLastEmail() {
    return localStorage.getItem('last_login_email') || '';
}

// Pr√©-remplir le champ email au chargement du modal
function prefillLoginEmail() {
    const lastEmail = getLastEmail();
    if (lastEmail) {
        const emailInput = document.getElementById('login-email');
        if (emailInput && !emailInput.value) {
            emailInput.value = lastEmail;
            // Focus sur le mot de passe si email pr√©-rempli
            setTimeout(() => {
                const pwdInput = document.getElementById('login-password');
                if (pwdInput) pwdInput.focus();
            }, 100);
        }
    }
}

function showAuthModal() {
    document.getElementById('authModal').classList.add('active');
    // Pr√©-remplir l'email apr√®s affichage
    setTimeout(prefillLoginEmail, 50);
    // R√©initialiser le formulaire admin
    resetAdminLoginForm();
}

function hideAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    resetAdminLoginForm();
}

function resetAdminLoginForm() {
    const toggle = document.getElementById('admin-login-toggle');
    const form = document.getElementById('admin-login-form');
    const error = document.getElementById('admin-error');
    const username = document.getElementById('admin-username');
    const password = document.getElementById('admin-password');

    if (toggle) toggle.classList.remove('hidden');
    if (form) form.classList.add('hidden');
    if (error) error.classList.add('hidden');
    if (username) username.value = '';
    if (password) password.value = '';
}

function showLoginForm() {
    document.getElementById('auth-login-form').classList.remove('hidden');
    document.getElementById('auth-signup-form').classList.add('hidden');
    document.getElementById('auth-error').classList.add('hidden');
    document.getElementById('auth-benefits').classList.remove('hidden');
}

function showSignupForm() {
    document.getElementById('auth-login-form').classList.add('hidden');
    document.getElementById('auth-signup-form').classList.remove('hidden');
    document.getElementById('signup-error').classList.add('hidden');
    document.getElementById('auth-benefits').classList.add('hidden'); // Cache les b√©n√©fices pour gagner de la place
}

async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('auth-error');
    const btn = document.getElementById('login-btn');

    if (!email || !password) {
        errorEl.textContent = 'Remplissez tous les champs';
        errorEl.classList.remove('hidden');
        return;
    }

    // V√©rifier que Supabase est disponible
    if (!window.SuiviTravauxAPI) {
        errorEl.textContent = 'Erreur de connexion au serveur. Rechargez la page (Ctrl+Shift+R).';
        errorEl.classList.remove('hidden');
        console.error('SuiviTravauxAPI non charg√©. V√©rifiez que supabase-config.js est accessible.');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Connexion...';

    try {
        await SuiviTravauxAPI.Auth.signIn(email, password);
        currentUser = await SuiviTravauxAPI.Auth.getCurrentUser();
        APP_MODE = 'supabase';

        // Quitter le mode d√©mo si actif
        exitDemoMode();

        await loadSupabaseData();

        // Proposer d'enregistrer les identifiants (si pas d√©j√† refus√©)
        await offerSaveCredentials(email, password);

        hideAuthModal();
        showToast('Bienvenue !');
    } catch (error) {
        errorEl.textContent = error.message || 'Erreur de connexion';
        errorEl.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Se connecter';
    }
}

async function handleSignup() {
    const name = document.getElementById('signup-name').value.trim();
    const phonePrefix = document.getElementById('signup-phone-prefix').value;
    const phoneNumber = document.getElementById('signup-phone').value.trim().replace(/\s/g, '');
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const errorEl = document.getElementById('signup-error');
    const btn = document.getElementById('signup-btn');

    // Validation du t√©l√©phone
    if (!phoneNumber) {
        errorEl.textContent = 'Le num√©ro de t√©l√©phone est obligatoire';
        errorEl.classList.remove('hidden');
        return;
    }

    // Nettoyer et formater le num√©ro
    const cleanPhone = phoneNumber.replace(/^0/, ''); // Enlever le 0 initial si pr√©sent
    const fullPhone = phonePrefix + cleanPhone;

    // V√©rifier format basique (au moins 6 chiffres)
    if (cleanPhone.length < 6 || !/^\d+$/.test(cleanPhone)) {
        errorEl.textContent = 'Num√©ro de t√©l√©phone invalide';
        errorEl.classList.remove('hidden');
        return;
    }

    if (!name || !email || !password) {
        errorEl.textContent = 'Remplissez tous les champs';
        errorEl.classList.remove('hidden');
        return;
    }

    if (password.length < 6) {
        errorEl.textContent = 'Le mot de passe doit faire au moins 6 caract√®res';
        errorEl.classList.remove('hidden');
        return;
    }

    // V√©rifier que Supabase est disponible
    if (!window.SuiviTravauxAPI) {
        errorEl.textContent = 'Erreur de connexion au serveur. Rechargez la page (Ctrl+Shift+R).';
        errorEl.classList.remove('hidden');
        console.error('SuiviTravauxAPI non charg√©. V√©rifiez que supabase-config.js est accessible.');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'V√©rification...';

    try {
        // V√©rifier si le num√©ro de t√©l√©phone est d√©j√† utilis√©
        const phoneExists = await checkPhoneExists(fullPhone);
        if (phoneExists) {
            errorEl.textContent = 'Ce num√©ro de t√©l√©phone est d√©j√† associ√© √† un compte';
            errorEl.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'D√©marrer mon essai gratuit';
            return;
        }

        btn.textContent = 'Cr√©ation...';

        // Inscription avec le t√©l√©phone dans les m√©tadonn√©es
        await SuiviTravauxAPI.Auth.signUp(email, password, name, fullPhone);
        currentUser = await SuiviTravauxAPI.Auth.getCurrentUser();

        if (currentUser) {
            APP_MODE = 'supabase';
            // Quitter le mode d√©mo si actif
            exitDemoMode();
            // Initialiser les donn√©es pour le nouvel utilisateur avec essai gratuit
            localStorage.setItem('trial-start', new Date().toISOString());
            appData = {
                user: { name, initials: name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2), since: new Date().getFullYear(), phone: fullPhone },
                chantiers: [],
                archivedChantiers: []
            };

            // Proposer d'enregistrer les identifiants pour les prochaines connexions
            await offerSaveCredentials(email, password);

            renderAll();
            hideAuthModal();
            showOnboarding();
            showToast('Bienvenue ! Essai gratuit de 14 jours activ√©');
        } else {
            // Email de confirmation envoy√© - message de succ√®s en vert
            const successEl = document.getElementById('signup-success');
            errorEl.classList.add('hidden');
            successEl.innerHTML = '‚úÖ <strong>Email envoy√© !</strong> V√©rifiez votre bo√Æte mail et cliquez sur le lien de confirmation.';
            successEl.classList.remove('hidden');
            btn.textContent = 'Email envoy√© !';
            return; // Ne pas r√©activer le bouton
        }
    } catch (error) {
        errorEl.textContent = error.message || 'Erreur lors de l\'inscription';
        errorEl.classList.remove('hidden');
        document.getElementById('signup-success').classList.add('hidden');
    } finally {
        btn.disabled = false;
        if (btn.textContent === 'Cr√©ation...' || btn.textContent === 'V√©rification...') {
            btn.textContent = 'D√©marrer mon essai gratuit';
        }
    }
}

// V√©rifier si un num√©ro de t√©l√©phone existe d√©j√†
async function checkPhoneExists(phone) {
    try {
        // V√©rifier dans la table artisans si le num√©ro existe d√©j√†
        const { data, error } = await supabaseClient
            .from('artisans')
            .select('id')
            .eq('phone', phone)
            .maybeSingle();

        if (error) {
            console.error('Erreur v√©rification t√©l√©phone:', error);
            return false; // En cas d'erreur, laisser passer
        }
        return !!data; // true si trouv√©
    } catch (e) {
        console.error('Erreur v√©rification t√©l√©phone:', e);
        return false;
    }
}

async function handleLogout() {
    if (APP_MODE === 'supabase') {
        try {
            await SuiviTravauxAPI.Auth.signOut();
        } catch (e) {
            console.error('Erreur d√©connexion:', e);
        }
    }
    currentUser = null;
    APP_MODE = 'demo';
    closeProfileModal();
    showAuthModal();
    showToast('D√©connect√©');
}

// =============================================
// MODE D√âMO - Fonctionnalit√©s limit√©es
// =============================================
const DEMO_CHANTIER_LIMIT = 1;

function enterDemoMode() {
    APP_MODE = 'demo';
    currentUser = null;

    // Charger ou cr√©er des donn√©es d√©mo
    appData = {
        user: { name: 'Mode D√©mo', initials: 'MD', since: new Date().getFullYear() },
        chantiers: [],
        archivedChantiers: []
    };

    hideAuthModal();
    showDemoBanner();
    renderAll();
    applyDemoRestrictions();
    dataLoaded = true;
    console.log('üéÆ Mode d√©mo activ√© - Fonctionnalit√©s limit√©es');
    showToast('Mode d√©mo activ√©');
}

function exitDemoMode() {
    hideDemoBanner();
    hideAdminBanner();
    removeDemoRestrictions();
    IS_ADMIN_MODE = false;
}

// =============================================
// MODE ADMIN PRO
// =============================================

function showAdminLogin() {
    document.getElementById('admin-login-toggle').classList.add('hidden');
    document.getElementById('admin-login-form').classList.remove('hidden');
}

function handleAdminLogin(event) {
    event.preventDefault();

    const username = document.getElementById('admin-username').value.trim();
    const password = document.getElementById('admin-password').value;
    const errorEl = document.getElementById('admin-error');

    // V√©rifier les identifiants
    if (ADMIN_ACCOUNTS[username] && ADMIN_ACCOUNTS[username] === password) {
        errorEl.classList.add('hidden');
        enterAdminMode(username);
    } else {
        errorEl.classList.remove('hidden');
    }
}

function enterAdminMode(username) {
    APP_MODE = 'admin';
    IS_ADMIN_MODE = true;
    currentUser = null;

    // Donn√©es admin avec plus de libert√©
    appData = {
        user: {
            name: username + ' (Pro)',
            initials: username.slice(0, 2).toUpperCase(),
            since: new Date().getFullYear(),
            subscription_status: 'pro'
        },
        chantiers: [],
        archivedChantiers: []
    };

    hideAuthModal();
    showAdminBanner(username);
    renderAll();
    // Pas de restrictions en mode admin
    removeDemoRestrictions();
    dataLoaded = true;
    console.log('üëë Mode Admin Pro activ√© pour:', username);
    showToast('Mode Pro activ√© - Acc√®s complet');
}

function showAdminBanner(username) {
    // Cacher la banni√®re d√©mo si pr√©sente
    hideDemoBanner();

    // Cr√©er ou afficher la banni√®re admin
    let banner = document.getElementById('admin-banner');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'admin-banner';
        banner.className = 'fixed top-0 left-0 right-0 bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-center py-2 px-4 z-[9998] shadow-md';
        banner.innerHTML = `
            <div class="flex items-center justify-center gap-2 text-sm font-medium">
                <span>üëë</span>
                <span>Compte Pro</span>
                <span class="opacity-75">‚Ä¢</span>
                <span class="opacity-90">${username}</span>
                <span class="opacity-75">‚Ä¢</span>
                <span class="opacity-90">Acc√®s illimit√©</span>
            </div>
        `;
        document.body.insertBefore(banner, document.body.firstChild);
    } else {
        banner.classList.remove('hidden');
        banner.querySelector('span:nth-child(4)').textContent = username;
    }
    document.body.style.paddingTop = '40px';
}

function hideAdminBanner() {
    const banner = document.getElementById('admin-banner');
    if (banner) {
        banner.classList.add('hidden');
    }
}

function showDemoBanner() {
    const banner = document.getElementById('demo-banner');
    if (banner) {
        banner.classList.remove('hidden');
        // Ajouter du padding-top au body pour compenser la banni√®re
        document.body.style.paddingTop = '40px';
    }
}

function hideDemoBanner() {
    const banner = document.getElementById('demo-banner');
    if (banner) {
        banner.classList.add('hidden');
        document.body.style.paddingTop = '';
    }
}

function showDemoUpgradeModal(message = null) {
    const modal = document.getElementById('demoUpgradeModal');
    const msgEl = document.getElementById('demo-upgrade-message');
    if (message && msgEl) {
        msgEl.textContent = message;
    }
    if (modal) modal.classList.add('active');
}

function hideDemoUpgradeModal() {
    const modal = document.getElementById('demoUpgradeModal');
    if (modal) modal.classList.remove('active');
}

// V√©rifier si une action est autoris√©e en mode d√©mo
function isDemoRestricted(action) {
    if (APP_MODE !== 'demo') return false;

    const restrictedActions = ['photo', 'voice', 'share', 'whatsapp', 'create_chantier_over_limit'];
    return restrictedActions.includes(action);
}

// Afficher le modal si action restreinte
function checkDemoRestriction(action, customMessage = null) {
    if (APP_MODE !== 'demo') return false;

    const messages = {
        'photo': 'Les photos ne sont pas disponibles en mode d√©mo.',
        'voice': 'Les messages vocaux ne sont pas disponibles en mode d√©mo.',
        'share': 'Le partage r√©el avec les clients n\'est pas disponible en mode d√©mo.',
        'whatsapp': 'L\'envoi WhatsApp n\'est pas disponible en mode d√©mo.',
        'create_chantier': `Vous avez atteint la limite de ${DEMO_CHANTIER_LIMIT} chantier en mode d√©mo.`
    };

    showDemoUpgradeModal(customMessage || messages[action] || 'Cette fonctionnalit√© n\'est pas disponible en mode d√©mo.');
    return true;
}

// Appliquer les restrictions visuelles en mode d√©mo
function applyDemoRestrictions() {
    // Ajouter une classe au body pour le CSS
    document.body.classList.add('demo-mode');

    // Ajouter la classe demo-restricted aux √©l√©ments photo et vocal
    const restrictedElements = [
        'quick-photo-btn-desktop',
        'quick-photo-btn-mobile',
        'photo-section-container',
        'voice-recorder-container'
    ];

    restrictedElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('demo-restricted');
        }
    });
}

function removeDemoRestrictions() {
    document.body.classList.remove('demo-mode');

    // Retirer la classe demo-restricted des √©l√©ments
    const restrictedElements = [
        'quick-photo-btn-desktop',
        'quick-photo-btn-mobile',
        'photo-section-container',
        'voice-recorder-container'
    ];

    restrictedElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('demo-restricted');
        }
    });
}

// V√©rifier si on peut cr√©er un chantier en mode d√©mo
function canCreateChantierDemo() {
    if (APP_MODE !== 'demo') return true;
    return (appData.chantiers?.length || 0) < DEMO_CHANTIER_LIMIT;
}

// Charger les donn√©es depuis Supabase
async function loadSupabaseData() {
    try {
        let profile = await SuiviTravauxAPI.Auth.getProfile();

        // Si le profil n'existe pas encore (premi√®re connexion apr√®s confirmation email)
        if (!profile && currentUser) {
            console.log('üìù Cr√©ation du profil artisan...');
            const userName = currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            try {
                profile = await SuiviTravauxAPI.Auth.createProfile({ name: userName });
                console.log('‚úÖ Profil cr√©√©:', profile);
            } catch (e) {
                console.error('Erreur cr√©ation profil:', e);
            }
        }

        const chantiers = await SuiviTravauxAPI.Chantiers.getAll();
        const archived = await SuiviTravauxAPI.Chantiers.getArchived();

        appData = {
            user: {
                name: profile?.name || currentUser?.user_metadata?.name || 'Artisan',
                initials: profile?.initials || 'AR',
                since: profile?.created_at ? new Date(profile.created_at).getFullYear() : new Date().getFullYear(),
                phone: profile?.phone || ''
            },
            chantiers: chantiers.map(mapChantierFromSupabase),
            archivedChantiers: archived.map(mapChantierFromSupabase)
        };

        if (appData.chantiers.length > 0) {
            appData.currentChantier = appData.chantiers[0].id;
        } else {
            appData.currentChantier = null;
        }

        renderAll();
        showScreen('list'); // Toujours afficher la liste au d√©marrage
        console.log('‚úÖ Donn√©es charg√©es:', appData.user.name);

        // Marquer les donn√©es comme charg√©es
        dataLoaded = true;

        // Activer la mise √† jour automatique en temps r√©el
        startRealtimeSync(currentUser.id);

    } catch (error) {
        console.error('Erreur chargement donn√©es:', error);
        showToast('Erreur de chargement');
    }
}

// =============================================
// SYNCHRONISATION EN TEMPS R√âEL
// =============================================

// Variables pour √©viter les syncs multiples
let isSyncing = false;
let lastSyncTime = 0;

// Fonction de synchronisation centralis√©e
async function syncData(showNotification = false) {
    // √âviter les syncs trop rapproch√©es (minimum 2 secondes)
    const now = Date.now();
    if (isSyncing || (now - lastSyncTime) < 2000) {
        console.log('‚è≠Ô∏è Sync ignor√©e (trop r√©cente ou en cours)');
        return;
    }

    isSyncing = true;
    lastSyncTime = now;

    try {
        console.log('üîÑ Synchronisation des donn√©es...');

        // Charger chantiers et archives en parall√®le
        const [chantiers, archived] = await Promise.all([
            SuiviTravauxAPI.Chantiers.getAll(),
            SuiviTravauxAPI.Chantiers.getArchived()
        ]);

        // Pr√©server le chantier courant
        const currentId = appData.currentChantier;

        appData.chantiers = chantiers.map(mapChantierFromSupabase);
        appData.archivedChantiers = archived.map(mapChantierFromSupabase);

        // Restaurer la s√©lection du chantier courant
        if (currentId) {
            appData.currentChantier = currentId;
        }

        // Recharger l'historique du chantier actuel
        const c = getCurrentChantier();
        if (c) {
            const updates = await SuiviTravauxAPI.Updates.getByChantier(c.id);
            if (updates) {
                c.history = updates.map(u => ({
                    title: u.title || 'Mise √† jour',
                    progress: u.progress,
                    date: formatDate(u.created_at),
                    hasPhotos: !!u.photo_url,
                    photoUrl: u.photo_url || null,
                    voiceUrl: u.voice_url || null
                }));
                c._historyNeedsRefresh = false;
            }
        }

        // Rafra√Æchir l'affichage
        renderAll();

        if (showNotification) {
            showToast('üîÑ Donn√©es synchronis√©es');
        }

        console.log('‚úÖ Sync termin√©e');
    } catch (error) {
        console.error('Erreur sync:', error);
    } finally {
        isSyncing = false;
    }
}

function startRealtimeSync(userId) {
    if (!SuiviTravauxAPI.Realtime) return;

    SuiviTravauxAPI.Realtime.subscribeToChantiers(userId, async (payload) => {
        console.log('üîÑ Changement Realtime:', payload.eventType);
        await syncData(payload.eventType === 'UPDATE');
    });

    console.log('üì° Synchronisation temps r√©el activ√©e');
}

// Rafra√Æchir quand l'utilisateur revient sur l'onglet/app
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && APP_MODE === 'supabase' && currentUser && dataLoaded) {
        console.log('üëÅÔ∏è Retour sur l\'app');
        await syncData(false);
    }
});

// Rafra√Æchir quand on reprend le focus (mobile) - avec d√©lai pour √©viter double appel
let focusTimeout = null;
window.addEventListener('focus', () => {
    if (APP_MODE === 'supabase' && currentUser && dataLoaded) {
        clearTimeout(focusTimeout);
        focusTimeout = setTimeout(() => syncData(false), 1000);
    }
});

// Mapper un chantier Supabase vers le format local
function mapChantierFromSupabase(c) {
    const statusColors = {
        'preparation': 'slate',
        'en_cours': 'blue',
        'finitions': 'amber',
        'livre': 'green',
        'annule': 'red'
    };
    return {
        id: c.id,
        name: c.name,
        client: c.client_name,
        clientPhone: c.client_phone,
        progress: c.progress,
        stage: c.stage,
        status: c.status,
        statusColor: statusColors[c.stage] || 'slate',
        lastUpdate: formatRelativeDate(c.updated_at),
        lastUpdateFull: formatDate(c.updated_at),
        clientViewed: c.client_viewed,
        clientViewedText: c.client_viewed ? 'Vu' : 'Pas encore vu',
        estimatedEnd: c.estimated_end ? formatDateShort(c.estimated_end) : '√Ä d√©finir',
        estimatedEndRaw: c.estimated_end || null,
        clientFeedback: c.client_feedback,
        shareToken: c.share_token,
        archivedAt: c.archived_at ? formatDate(c.archived_at) : null,
        history: [],
        _historyNeedsRefresh: true, // Marquer que l'historique doit √™tre charg√©
        lastMessage: c.last_message || ''
    };
}

// Formater les dates
function formatRelativeDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) return 'Aujourd\'hui';
    if (days === 1) return 'Hier';
    if (days < 7) return `Il y a ${days} jours`;
    if (days < 30) return `Il y a ${Math.floor(days/7)} semaine${days >= 14 ? 's' : ''}`;
    return `Il y a ${Math.floor(days/30)} mois`;
}

// =============================================
// S√âCURIT√â - √âchappement HTML contre XSS
// =============================================
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('fr-FR', {
        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
    });
}

function formatDateShort(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

// =============================================
// SYST√àME DE DONN√âES - localStorage
// =============================================
const APP_DATA_KEY = 'suivitravaux_data';

// Donn√©es par d√©faut
const defaultData = {
    user: {
        name: 'Jean Dupont',
        initials: 'JD',
        since: '2020',
        totalChantiers: 12,
        rating: 4.9,
        satisfaction: 98
    },
    archivedChantiers: [
        {
            id: 101,
            name: 'R√©novation studio',
            client: 'M. Dubois',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            archivedAt: '15 d√©c 2024',
            clientFeedback: 4
        },
        {
            id: 102,
            name: 'Salle de bain parents',
            client: 'Mme Fournier',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            archivedAt: '28 nov 2024',
            clientFeedback: 3
        }
    ],
    chantiers: [
        {
            id: 1,
            name: 'R√©novation cuisine',
            client: 'M. Dupont',
            progress: 65,
            stage: 'en_cours',
            status: 'En cours',
            statusColor: 'blue',
            lastUpdate: 'Aujourd\'hui',
            lastUpdateFull: 'Aujourd\'hui √† 14:30',
            clientViewed: true,
            clientViewedText: 'Vu ce matin',
            estimatedEnd: '28 jan',
            history: [
                { title: 'Pose du carrelage termin√©e', progress: 65, date: 'Aujourd\'hui √† 14:30', hasPhotos: true },
                { title: 'Plomberie valid√©e', progress: 50, date: 'Hier √† 16:00', hasPhotos: false },
                { title: 'D√©molition termin√©e', progress: 25, date: '15 jan', hasPhotos: false },
                { title: 'Chantier d√©marr√©', progress: 5, date: '10 jan', hasPhotos: false }
            ],
            lastMessage: 'Pose du carrelage termin√©e. Les joints seront faits demain matin.'
        },
        {
            id: 2,
            name: 'Salle de bain',
            client: 'Mme Martin',
            progress: 90,
            stage: 'finitions',
            status: 'Finitions',
            statusColor: 'amber',
            lastUpdate: 'Hier',
            lastUpdateFull: 'Hier √† 10:00',
            clientViewed: true,
            clientViewedText: 'Vu hier',
            estimatedEnd: '20 jan',
            history: [],
            lastMessage: ''
        },
        {
            id: 3,
            name: 'Extension garage',
            client: 'M. Bernard',
            progress: 15,
            stage: 'preparation',
            status: 'Pr√©paration',
            statusColor: 'slate',
            lastUpdate: 'Il y a 3 jours',
            lastUpdateFull: 'Il y a 3 jours',
            clientViewed: false,
            clientViewedText: 'Jamais vu',
            estimatedEnd: '15 f√©v',
            history: [],
            lastMessage: ''
        },
        {
            id: 4,
            name: 'Terrasse bois',
            client: 'Mme Leroy',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 5 jours',
            lastUpdateFull: 'Il y a 5 jours',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 4,
            history: [],
            lastMessage: ''
        },
        {
            id: 5,
            name: 'R√©novation escalier',
            client: 'M. Moreau',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 1 semaine',
            lastUpdateFull: 'Il y a 1 semaine',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 4,
            history: [],
            lastMessage: 'Escalier termin√©, vernis appliqu√©.'
        },
        {
            id: 6,
            name: 'Peinture salon',
            client: 'Mme Petit',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 2 semaines',
            lastUpdateFull: 'Il y a 2 semaines',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 3,
            history: [],
            lastMessage: 'Peinture termin√©e, 2 couches appliqu√©es.'
        },
        {
            id: 7,
            name: 'Pose parquet',
            client: 'M. Garcia',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 3 semaines',
            lastUpdateFull: 'Il y a 3 semaines',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 4,
            history: [],
            lastMessage: 'Parquet pos√© et vitrifi√©.'
        },
        {
            id: 8,
            name: 'Isolation combles',
            client: 'Mme Roux',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 1 mois',
            lastUpdateFull: 'Il y a 1 mois',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 4,
            history: [],
            lastMessage: 'Isolation termin√©e, R=7 atteint.'
        },
        {
            id: 9,
            name: 'Carrelage entr√©e',
            client: 'M. Lambert',
            progress: 100,
            stage: 'livre',
            status: 'Termin√© !',
            statusColor: 'green',
            lastUpdate: 'Il y a 1 mois',
            lastUpdateFull: 'Il y a 1 mois',
            clientViewed: true,
            clientViewedText: 'Vu',
            estimatedEnd: 'Termin√©',
            clientFeedback: 3,
            history: [],
            lastMessage: 'Carrelage pos√© avec joints gris.'
        }
    ],
    currentChantier: 1
};

// Charger les donn√©es
function loadData() {
    const saved = localStorage.getItem(APP_DATA_KEY);
    if (saved) {
        try {
            return JSON.parse(saved);
        } catch (e) {
            console.error('Erreur chargement donn√©es:', e);
        }
    }
    return JSON.parse(JSON.stringify(defaultData));
}

// Sauvegarder les donn√©es
function saveData(data) {
    localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
}

// Obtenir les donn√©es actuelles
let appData = loadData();

// Obtenir un chantier par ID
function getChantier(id) {
    // Comparer en string pour supporter les UUIDs Supabase et les IDs num√©riques d√©mo
    const idStr = String(id);
    return appData.chantiers.find(c => String(c.id) === idStr);
}

// Obtenir le chantier actuel
function getCurrentChantier() {
    return getChantier(appData.currentChantier);
}

// S√©lectionner un chantier comme actuel et aller √† l'√©cran d√©tail
async function selectChantierAndShowDetail(id) {
    appData.currentChantier = id;
    saveData(appData);

    // Si mode Supabase, charger l'historique depuis la base
    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
        try {
            const updates = await SuiviTravauxAPI.Updates.getByChantier(id);
            const chantier = getChantier(id);
            if (chantier && updates) {
                chantier.history = updates.map(u => ({
                    title: u.title || 'Mise √† jour',
                    progress: u.progress,
                    date: formatDate(u.created_at),
                    hasPhotos: !!u.photo_url,
                    photoUrl: u.photo_url || null,
                    voiceUrl: u.voice_url || null
                }));
            }
        } catch (error) {
            console.error('Erreur chargement historique:', error);
        }
    }

    renderAll();
    showScreen('detail');
}

// S√©lectionner un chantier (alias pour compatibilit√©)
async function selectChantier(id) {
    await selectChantierAndShowDetail(id);
}

// Cr√©er un nouveau chantier
async function createNewChantier(name, clientName, estimatedEnd = null) {
    if (APP_MODE === 'supabase') {
        try {
            const newChantier = await SuiviTravauxAPI.Chantiers.create({
                name: name,
                client_name: clientName,
                estimated_end: estimatedEnd
            });
            const mapped = mapChantierFromSupabase(newChantier);
            appData.chantiers.unshift(mapped);
            appData.currentChantier = mapped.id;
            return mapped;
        } catch (error) {
            console.error('Erreur cr√©ation chantier:', error);
            showToast('Erreur lors de la cr√©ation');
            return null;
        }
    } else {
        // Mode d√©mo - localStorage
        const newId = Math.max(...appData.chantiers.map(c => c.id), 0) + 1;
        const formattedEnd = estimatedEnd ? formatEstimatedEnd(estimatedEnd) : '√Ä d√©finir';
        const newChantier = {
            id: newId,
            name: name,
            client: clientName,
            progress: 0,
            stage: 'preparation',
            status: 'Pr√©paration',
            statusColor: 'slate',
            lastUpdate: 'Aujourd\'hui',
            lastUpdateFull: 'Aujourd\'hui',
            clientViewed: false,
            clientViewedText: 'Pas encore vu',
            estimatedEnd: formattedEnd,
            estimatedEndRaw: estimatedEnd,
            shareToken: 'demo-' + newId,
            history: [{ title: 'Chantier cr√©√©', progress: 0, date: 'Aujourd\'hui', hasPhotos: false }],
            lastMessage: ''
        };
        appData.chantiers.unshift(newChantier);
        appData.currentChantier = newId;
        saveData(appData);
        return newChantier;
    }
}

// Formater la date de fin estim√©e
function formatEstimatedEnd(dateStr) {
    if (!dateStr) return '√Ä d√©finir';
    const date = new Date(dateStr);
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('fr-FR', options);
}

// Mettre √† jour un chantier
function updateChantier(id, progress, stage, message) {
    const chantier = getChantier(id);
    if (!chantier) return;

    const oldProgress = chantier.progress;
    chantier.progress = progress;
    chantier.lastUpdate = 'Aujourd\'hui';
    chantier.lastUpdateFull = 'Aujourd\'hui √† ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    chantier.lastMessage = message || '';

    // Update stage
    const stages = {
        'preparation': { status: 'Pr√©paration', color: 'slate' },
        'en_cours': { status: 'En cours', color: 'blue' },
        'finitions': { status: 'Finitions', color: 'amber' },
        'livre': { status: 'Termin√© !', color: 'green' }
    };
    if (stages[stage]) {
        chantier.stage = stage;
        chantier.status = stages[stage].status;
        chantier.statusColor = stages[stage].color;
    }

    // Auto-complete at 100%
    if (progress === 100) {
        chantier.stage = 'livre';
        chantier.status = 'Termin√© !';
        chantier.statusColor = 'green';
    }

    // Add to history
    chantier.history.unshift({
        title: message || 'Mise √† jour',
        progress: progress,
        date: chantier.lastUpdateFull,
        hasPhotos: false
    });

    saveData(appData);
    return chantier;
}

// Mise √† jour avec media (photos/vocaux)
async function updateChantierWithMedia(id, progress, stage, message, photoUrl, voiceUrl) {
    const chantier = getChantier(id);
    if (!chantier) return;

    const oldProgress = chantier.progress;
    chantier.progress = progress;
    chantier.lastUpdate = 'Aujourd\'hui';
    chantier.lastUpdateFull = 'Aujourd\'hui √† ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    chantier.lastMessage = message || '';

    // Update stage
    const stages = {
        'preparation': { status: 'Pr√©paration', color: 'slate' },
        'en_cours': { status: 'En cours', color: 'blue' },
        'finitions': { status: 'Finitions', color: 'amber' },
        'livre': { status: 'Termin√© !', color: 'green' }
    };
    if (stages[stage]) {
        chantier.stage = stage;
        chantier.status = stages[stage].status;
        chantier.statusColor = stages[stage].color;
    }

    // Auto-complete at 100%
    if (progress === 100) {
        chantier.stage = 'livre';
        chantier.status = 'Termin√© !';
        chantier.statusColor = 'green';
    }

    // Add to history with media
    if (!chantier.history) chantier.history = [];
    const historyEntry = {
        title: message || 'Mise √† jour',
        progress: progress,
        date: chantier.lastUpdateFull,
        hasPhotos: !!photoUrl,
        photoUrl: photoUrl || null,
        voiceUrl: voiceUrl || null
    };
    chantier.history.unshift(historyEntry);

    // Si mode Supabase, cr√©er l'update en base
    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
        try {
            await SuiviTravauxAPI.Updates.create(chantier.id, {
                title: message || 'Mise √† jour',
                message: message,
                progress: progress,
                stage: stage,
                photo_url: photoUrl,
                voice_url: voiceUrl
            });

            // Mettre √† jour le chantier en base
            await SuiviTravauxAPI.Chantiers.update(chantier.id, {
                progress: progress,
                stage: stage,
                status: chantier.status,
                last_message: message
            });
        } catch (e) {
            console.error('Erreur sync Supabase:', e);
        }
    }

    saveData(appData);
    return chantier;
}

// R√©initialiser les donn√©es (pour les tests)
function resetData() {
    localStorage.removeItem(APP_DATA_KEY);
    appData = loadData();
    renderAll();
    showToast('Donn√©es r√©initialis√©es !');
}

// =============================================
// RENDU DE L'INTERFACE
// =============================================

// Rendre la liste des chantiers
function renderChantiersList() {
    const desktopList = document.getElementById('chantiers-list');
    const desktopTerminesList = document.getElementById('chantiers-termines-list');
    const mobileList = document.getElementById('mobile-chantiers-list');

    const chantiersEnCours = appData.chantiers.filter(c => c.progress < 100);
    const chantiersTermines = appData.chantiers.filter(c => c.progress === 100);
    const archivesCount = (appData.archivedChantiers || []).length;

    // Update count
    document.querySelectorAll('.chantiers-count').forEach(el => {
        el.textContent = chantiersEnCours.length + ' chantier' + (chantiersEnCours.length > 1 ? 's' : '') + ' en cours';
    });

    // Update archives count (desktop + mobile)
    const archivesCountEl = document.getElementById('archives-count');
    const mobileArchivesCountEl = document.getElementById('mobile-archives-count');
    if (archivesCountEl) archivesCountEl.textContent = archivesCount;
    if (mobileArchivesCountEl) mobileArchivesCountEl.textContent = archivesCount;

    // HTML pour chantiers en cours
    let htmlEnCours = '';
    if (chantiersEnCours.length === 0) {
        htmlEnCours = '<p class="text-slate-400 text-sm text-center py-4">Aucun chantier en cours</p>';
    } else {
        chantiersEnCours.forEach(c => {
            htmlEnCours += createChantierCard(c, false);
        });
    }

    // HTML pour chantiers termin√©s (limite √† 3 affich√©s)
    const LIMITE_TERMINES = 3;
    let htmlTermines = '';
    if (chantiersTermines.length === 0) {
        htmlTermines = '<p class="text-slate-400 text-sm text-center py-4">Aucun chantier termin√©</p>';
    } else {
        const terminesAffiches = chantiersTermines.slice(0, LIMITE_TERMINES);
        terminesAffiches.forEach(c => {
            htmlTermines += createChantierCard(c, true);
        });
        // Bouton "Voir tout" si plus de 3 chantiers termin√©s
        if (chantiersTermines.length > LIMITE_TERMINES) {
            const restants = chantiersTermines.length - LIMITE_TERMINES;
            htmlTermines += `
            <button onclick="showAllTermines()" class="w-full py-3 text-center text-primary-600 text-sm font-medium hover:bg-primary-50 rounded-xl transition-colors">
                Voir ${restants} autre${restants > 1 ? 's' : ''} chantier${restants > 1 ? 's' : ''} termin√©${restants > 1 ? 's' : ''}
            </button>`;
        }
    }

    // Desktop : listes s√©par√©es
    if (desktopList) desktopList.innerHTML = htmlEnCours;
    if (desktopTerminesList) desktopTerminesList.innerHTML = htmlTermines;

    // Mobile : listes s√©par√©es aussi
    const mobileTerminesList = document.getElementById('mobile-chantiers-termines-list');
    if (mobileList) mobileList.innerHTML = htmlEnCours;
    if (mobileTerminesList) mobileTerminesList.innerHTML = htmlTermines;
}

// Variable pour afficher tous les chantiers termin√©s
let showAllTerminesMode = false;

// Afficher tous les chantiers termin√©s
function showAllTermines() {
    showAllTerminesMode = true;
    renderChantiersListFull();
}

// Rendre la liste compl√®te des chantiers termin√©s
function renderChantiersListFull() {
    const desktopTerminesList = document.getElementById('chantiers-termines-list');
    const mobileTerminesList = document.getElementById('mobile-chantiers-termines-list');
    const chantiersTermines = appData.chantiers.filter(c => c.progress === 100);

    let htmlTermines = '';
    chantiersTermines.forEach(c => {
        htmlTermines += createChantierCard(c, true);
    });
    // Bouton pour r√©duire
    htmlTermines += `
    <button onclick="hideExtraTermines()" class="w-full py-3 text-center text-slate-500 text-sm font-medium hover:bg-slate-50 rounded-xl transition-colors">
        Afficher moins
    </button>`;

    if (desktopTerminesList) desktopTerminesList.innerHTML = htmlTermines;
    if (mobileTerminesList) mobileTerminesList.innerHTML = htmlTermines;
}

// Masquer les chantiers termin√©s suppl√©mentaires
function hideExtraTermines() {
    showAllTerminesMode = false;
    renderChantiersList();
}

// Cr√©er une carte de chantier (avec √©chappement XSS)
function createChantierCard(c, isCompleted) {
    const viewedClass = c.clientViewed ? 'text-green-600' : 'text-slate-400';
    const safeName = escapeHtml(c.name);
    const safeClient = escapeHtml(c.client);
    const safeStatus = escapeHtml(c.status);
    const safeLastUpdate = escapeHtml(c.lastUpdate);
    const safeClientViewedText = escapeHtml(c.clientViewedText);

    if (isCompleted) {
        return `
        <div onclick="selectChantierAndShowDetail('${c.id}')" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-4 cursor-pointer hover:shadow-md relative overflow-hidden">
            <div class="absolute -top-1 -right-1 text-2xl opacity-30 rotate-12">üéâ</div>
            <div class="flex justify-between items-start mb-3">
                <div><h3 class="font-semibold text-slate-800">${safeName}</h3><p class="text-sm text-slate-500">${safeClient}</p></div>
                <span class="px-2 py-1 bg-green-500 text-white text-xs font-medium rounded-full z-10">${safeStatus}</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex-1 h-2 bg-green-200 rounded-full overflow-hidden"><div class="h-full bg-green-500 rounded-full" style="width:100%"></div></div>
                <span class="text-sm font-semibold text-green-600">100%</span>
            </div>
            <div class="flex items-center justify-between mt-3">
                <p class="text-xs text-green-600 font-medium">${c.clientFeedback ? '‚≠ê Client satisfait' : 'En attente d\'avis'}</p>
                <button onclick="event.stopPropagation(); archiveChantier('${c.id}')" class="text-xs text-slate-500 underline">Archiver</button>
            </div>
        </div>`;
    }

    const statusColors = {
        'blue': 'bg-blue-100 text-blue-700',
        'amber': 'bg-amber-100 text-amber-700',
        'slate': 'bg-slate-100 text-slate-600',
        'green': 'bg-green-100 text-green-700',
        'red': 'bg-red-100 text-red-700'
    };
    const statusClass = statusColors[c.statusColor] || statusColors['slate'];

    return `
    <div onclick="selectChantierAndShowDetail('${c.id}')" class="bg-white border border-slate-200 rounded-2xl p-4 cursor-pointer hover:shadow-md hover-lift">
        <div class="flex justify-between items-start mb-3">
            <div><h3 class="font-semibold text-slate-800">${safeName}</h3><p class="text-sm text-slate-500">${safeClient}</p></div>
            <span class="px-2 py-1 ${statusClass} text-xs font-medium rounded-full">${safeStatus}</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-primary-600 rounded-full" style="width:${c.progress}%"></div></div>
            <span class="text-sm font-semibold text-primary-600">${c.progress}%</span>
        </div>
        <div class="flex items-center justify-between mt-2">
            <p class="text-xs text-slate-400">Mise √† jour : ${safeLastUpdate}</p>
            <span class="text-xs ${viewedClass} flex items-center gap-1">üëÄ ${safeClientViewedText}</span>
        </div>
    </div>`;
}

// Rendre le d√©tail du chantier
function renderChantierDetail() {
    const c = getCurrentChantier();
    if (!c) return;

    // Desktop detail - avec les nouveaux IDs
    const detailName = document.getElementById('detail-chantier-name');
    const detailClient = document.getElementById('detail-client-name');
    const detailProgressPercent = document.getElementById('detail-progress-percent');
    const detailProgressBar = document.getElementById('detail-progress-bar');
    const detailStage = document.getElementById('detail-stage');
    const detailEndDate = document.getElementById('detail-end-date');
    const detailClientLink = document.getElementById('detail-client-link');
    const detailPhotosCount = document.getElementById('detail-photos-count');
    const detailHistory = document.getElementById('detail-history');
    const updateChantierName = document.getElementById('update-chantier-name');

    if (detailName) detailName.textContent = c.name;
    if (detailClient) detailClient.textContent = c.client;
    if (detailProgressPercent) detailProgressPercent.textContent = c.progress + '%';
    if (detailProgressBar) detailProgressBar.style.width = c.progress + '%';
    if (detailStage) detailStage.textContent = '√âtape : ' + c.status;
    if (detailEndDate) detailEndDate.innerHTML = 'üìÖ Fin estim√©e : ' + c.estimatedEnd;
    if (detailClientLink) {
        const token = c.shareToken || c.id;
        // Utiliser la fonction centralis√©e pour g√©n√©rer le lien
        if (window.location.protocol === 'file:') {
            const currentPath = window.location.pathname;
            const folderPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
            detailClientLink.value = 'file://' + folderPath + 'client.html?t=' + token;
        } else {
            detailClientLink.value = window.location.origin + '/client.html?t=' + token;
        }
    }
    if (detailPhotosCount) detailPhotosCount.textContent = 'Voir tout (' + (c.history?.length || 0) + ')';
    if (updateChantierName) updateChantierName.textContent = c.name;

    // Pr√©-remplir le champ de date dans l'√©cran de mise √† jour
    const updateEndDate = document.getElementById('update-end-date');
    const mobileUpdateEndDate = document.getElementById('mobile-update-end-date');

    // D√©finir la date minimum √† aujourd'hui pour emp√™cher les dates pass√©es
    const today = new Date().toISOString().split('T')[0];
    if (updateEndDate) updateEndDate.setAttribute('min', today);
    if (mobileUpdateEndDate) mobileUpdateEndDate.setAttribute('min', today);

    // Utiliser estimatedEndRaw (format ISO) pour pr√©-remplir le champ date
    if (c.estimatedEndRaw) {
        // Convertir la date ISO en format YYYY-MM-DD pour l'input date
        const dateValue = c.estimatedEndRaw.split('T')[0];
        if (updateEndDate) updateEndDate.value = dateValue;
        if (mobileUpdateEndDate) mobileUpdateEndDate.value = dateValue;
    } else {
        if (updateEndDate) updateEndDate.value = '';
        if (mobileUpdateEndDate) mobileUpdateEndDate.value = '';
    }

    // Changer la couleur de la carte si termin√©
    const progressCard = document.getElementById('detail-progress-card');
    if (progressCard) {
        if (c.progress === 100) {
            progressCard.className = 'bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-4 text-white mb-4';
        } else {
            progressCard.className = 'bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl p-4 text-white mb-4';
        }
    }

    // Render detail history (avec √©chappement XSS)
    if (detailHistory && c.history) {
        let historyHtml = '';
        c.history.slice(0, 5).forEach((h, i) => {
            const iconClass = i === 0 ? 'bg-primary-100 text-primary-600' : 'bg-slate-100 text-slate-500';
            const safeTitle = escapeHtml(h.title);
            const safeDate = escapeHtml(h.date);

            // Construire les m√©dias (photo/vocal) - URLs valid√©es
            let mediaHtml = '';
            if (h.photoUrl && h.photoUrl.startsWith('https://')) {
                mediaHtml += `<img src="${escapeHtml(h.photoUrl)}" alt="Photo" class="mt-2 w-full max-w-xs rounded-lg cursor-pointer hover:opacity-90" onclick="openImageModal('${escapeHtml(h.photoUrl)}')">`;
            }
            if (h.voiceUrl && h.voiceUrl.startsWith('https://')) {
                mediaHtml += `<audio src="${escapeHtml(h.voiceUrl)}" controls class="mt-2 h-10 w-full max-w-xs"></audio>`;
            }

            historyHtml += `
            <div class="flex gap-3">
                <div class="w-10 h-10 ${iconClass} rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <div class="flex-1">
                    <p class="font-medium text-slate-800">${safeTitle}</p>
                    <p class="text-sm text-slate-500">${h.progress}% - ${safeDate}</p>
                    ${mediaHtml}
                </div>
            </div>`;
        });
        detailHistory.innerHTML = historyHtml || '<p class="text-slate-400 text-sm">Aucun historique</p>';
    }

    // Mobile detail
    const mobileDetailName = document.getElementById('mobile-detail-chantier-name');
    const mobileDetailClient = document.getElementById('mobile-detail-client-name');
    const mobileDetailProgress = document.getElementById('mobile-detail-progress');
    const mobileDetailProgressBar = document.getElementById('mobile-detail-progress-bar');
    const mobileDetailStage = document.getElementById('mobile-detail-stage');
    const mobileUpdateName = document.getElementById('mobile-update-chantier-name');

    if (mobileDetailName) mobileDetailName.textContent = c.name;
    if (mobileDetailClient) mobileDetailClient.textContent = c.client;
    if (mobileDetailProgress) mobileDetailProgress.textContent = c.progress + '%';
    if (mobileDetailProgressBar) mobileDetailProgressBar.style.width = c.progress + '%';
    if (mobileDetailStage) mobileDetailStage.textContent = '√âtape : ' + c.status;
    if (mobileUpdateName) mobileUpdateName.textContent = c.name;

    // Mobile detail history (avec √©chappement XSS)
    const mobileDetailHistory = document.getElementById('mobile-detail-history');
    if (mobileDetailHistory && c.history) {
        let mobileHistoryHtml = '';
        c.history.slice(0, 5).forEach((h, i) => {
            const iconClass = i === 0 ? 'bg-primary-100 text-primary-600' : 'bg-slate-100 text-slate-500';
            const safeTitle = escapeHtml(h.title);
            const safeDate = escapeHtml(h.date);

            // Construire les m√©dias (photo/vocal) - URLs valid√©es
            let mediaHtml = '';
            if (h.photoUrl && h.photoUrl.startsWith('https://')) {
                mediaHtml += `<img src="${escapeHtml(h.photoUrl)}" alt="Photo" class="mt-2 w-full rounded-lg cursor-pointer hover:opacity-90" onclick="openImageModal('${escapeHtml(h.photoUrl)}')">`;
            }
            if (h.voiceUrl && h.voiceUrl.startsWith('https://')) {
                mediaHtml += `<audio src="${escapeHtml(h.voiceUrl)}" controls class="mt-2 h-8 w-full"></audio>`;
            }

            mobileHistoryHtml += `
            <div class="flex gap-3 bg-white border border-slate-200 rounded-xl p-3">
                <div class="w-8 h-8 ${iconClass} rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-slate-800 text-sm truncate">${safeTitle}</p>
                    <p class="text-xs text-slate-500">${h.progress}% - ${safeDate}</p>
                    ${mediaHtml}
                </div>
            </div>`;
        });
        mobileDetailHistory.innerHTML = mobileHistoryHtml || '<p class="text-slate-400 text-sm">Aucun historique</p>';
    }

    // Set slider to current progress
    const slider = document.getElementById('progress-slider');
    const mSlider = document.getElementById('mobile-progress-slider');
    const display = document.getElementById('progress-value');
    const mDisplay = document.getElementById('mobile-progress-value');
    if (slider) slider.value = c.progress;
    if (mSlider) mSlider.value = c.progress;
    if (display) display.textContent = c.progress + '%';
    if (mDisplay) mDisplay.textContent = c.progress + '%';

    // Update stage buttons to match current stage
    updateStageButtons(c.stage);
}

// Rendre la vue client
function renderClientView() {
    const c = getCurrentChantier();
    if (!c) return;

    // Update name and artisan
    const clientViewName = document.getElementById('client-view-name');
    if (clientViewName) clientViewName.textContent = c.name;

    const clientViewArtisan = document.getElementById('client-view-artisan');
    if (clientViewArtisan) clientViewArtisan.textContent = 'Artisan : ' + appData.user.name;

    // Update circular progress
    const circumference = 2 * Math.PI * 70;
    const offset = circumference - (c.progress / 100) * circumference;

    const progressCircle = document.getElementById('client-progress-circle');
    if (progressCircle) progressCircle.setAttribute('stroke-dashoffset', offset);

    const progressPercent = document.getElementById('client-progress-percent');
    if (progressPercent) progressPercent.textContent = c.progress + '%';

    const statusText = document.getElementById('client-status-text');
    if (statusText) statusText.textContent = c.status;

    const lastUpdate = document.getElementById('client-last-update');
    if (lastUpdate) lastUpdate.textContent = c.lastUpdateFull;

    const lastMessage = document.getElementById('client-last-message');
    if (lastMessage) lastMessage.textContent = c.lastMessage || 'Aucune mise √† jour r√©cente';

    // Afficher la date de fin estim√©e
    const clientEndDate = document.getElementById('client-end-date');
    const clientEstimatedEnd = document.getElementById('client-estimated-end');
    if (clientEndDate && clientEstimatedEnd) {
        if (c.estimatedEnd && c.estimatedEnd !== '√Ä d√©finir' && c.estimatedEnd !== 'Termin√©') {
            // Parser le format "20 jan" vers une date compl√®te
            const dateStr = c.estimatedEnd;
            const months = {'jan': 0, 'f√©v': 1, 'mar': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                            'juil': 6, 'ao√ªt': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'd√©c': 11};
            const parts = dateStr.toLowerCase().split(' ');
            if (parts.length === 2) {
                const day = parseInt(parts[0]);
                const monthIndex = months[parts[1]];
                if (!isNaN(day) && monthIndex !== undefined) {
                    const year = new Date().getFullYear();
                    const date = new Date(year, monthIndex, day);
                    clientEndDate.textContent = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    clientEstimatedEnd.style.display = 'flex';
                } else {
                    clientEndDate.textContent = c.estimatedEnd;
                    clientEstimatedEnd.style.display = 'flex';
                }
            } else {
                clientEndDate.textContent = c.estimatedEnd;
                clientEstimatedEnd.style.display = 'flex';
            }
        } else {
            clientEstimatedEnd.style.display = 'none';
        }
    }

    // Render stages
    const stagesContainer = document.getElementById('client-stages');
    if (stagesContainer) {
        const stageOrder = ['preparation', 'en_cours', 'finitions', 'livre'];
        const stageNames = ['Pr√©pa', 'En cours', 'Finitions', 'Livr√©'];
        const currentStageIndex = stageOrder.indexOf(c.stage);
        const isFullyCompleted = c.stage === 'livre' || c.progress === 100;

        let stagesHtml = '';
        stageOrder.forEach((stage, i) => {
            // Si chantier livr√©, toutes les √©tapes sont compl√©t√©es (vertes avec coche)
            const isCompleted = isFullyCompleted ? true : (i < currentStageIndex);
            const isCurrent = isFullyCompleted ? false : (i === currentStageIndex);
            const bgClass = isCompleted ? 'bg-green-500 text-white' : (isCurrent ? 'bg-primary-600 text-white' : 'bg-slate-200 text-slate-400');
            const textClass = isCompleted ? 'text-green-600 font-medium' : (isCurrent ? 'text-primary-600 font-medium' : 'text-slate-400');
            const lineClass = isCompleted || (isFullyCompleted && i < stageOrder.length - 1) ? 'bg-green-500' : 'bg-slate-200';
            const content = isCompleted ? '&#10003;' : (i + 1);

            stagesHtml += `<div class="flex flex-col items-center"><div class="w-8 h-8 ${bgClass} rounded-full flex items-center justify-center text-sm">${content}</div><span class="text-xs ${textClass} mt-1">${stageNames[i]}</span></div>`;
            if (i < stageOrder.length - 1) {
                stagesHtml += `<div class="flex-1 h-1 ${lineClass} self-center mx-2 rounded"></div>`;
            }
        });
        stagesContainer.innerHTML = stagesHtml;
    }

    // Render history
    const historyContainer = document.getElementById('client-history');
    if (historyContainer && c.history) {
        let historyHtml = '';
        c.history.slice(0, 5).forEach(h => {
            const safeTitle = escapeHtml(h.title);
            const safeDate = escapeHtml(h.date);

            // Construire les m√©dias (photo/vocal) - URLs valid√©es
            let mediaHtml = '';
            if (h.photoUrl && h.photoUrl.startsWith('https://')) {
                mediaHtml += `<img src="${escapeHtml(h.photoUrl)}" alt="Photo" class="mt-2 w-full rounded-lg cursor-pointer hover:opacity-90" onclick="openImageModal('${escapeHtml(h.photoUrl)}')">`;
            }
            if (h.voiceUrl && h.voiceUrl.startsWith('https://')) {
                mediaHtml += `<audio src="${escapeHtml(h.voiceUrl)}" controls class="mt-2 h-8 w-full"></audio>`;
            }

            historyHtml += `
            <div class="bg-white border border-slate-200 rounded-xl p-3">
                <div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-slate-700">${safeTitle}</span><span class="text-xs text-slate-400">${safeDate}</span></div>
                <div class="flex items-center gap-2"><div class="h-1.5 flex-1 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-primary-600 rounded-full" style="width:${h.progress}%"></div></div><span class="text-xs text-slate-500">${h.progress}%</span></div>
                ${mediaHtml}
            </div>`;
        });
        historyContainer.innerHTML = historyHtml || '<p class="text-slate-400 text-sm">Aucun historique</p>';
    }

    // =============================================
    // VUE CLIENT MOBILE
    // =============================================
    const mobileClientName = document.getElementById('mobile-client-view-name');
    const mobileClientArtisan = document.getElementById('mobile-client-view-artisan');
    const mobileClientProgress = document.getElementById('mobile-client-progress-percent');
    const mobileClientStatus = document.getElementById('mobile-client-status');
    const mobileClientProgressCircle = document.getElementById('mobile-client-progress-circle');
    const mobileClientLastUpdate = document.getElementById('mobile-client-last-update');
    const mobileClientLastMessage = document.getElementById('mobile-client-last-message');
    const mobileClientStages = document.getElementById('mobile-client-stages');
    const mobileClientHistory = document.getElementById('mobile-client-history');

    if (mobileClientName) mobileClientName.textContent = c.name;
    if (mobileClientArtisan) mobileClientArtisan.textContent = 'Artisan : ' + appData.user.name;
    if (mobileClientProgress) mobileClientProgress.textContent = c.progress + '%';
    if (mobileClientStatus) mobileClientStatus.textContent = c.status;
    if (mobileClientLastUpdate) mobileClientLastUpdate.textContent = c.lastUpdateFull;
    if (mobileClientLastMessage) mobileClientLastMessage.textContent = c.lastMessage || 'Aucune mise √† jour';

    // Afficher la date de fin estim√©e mobile
    const mobileClientEndDate = document.getElementById('mobile-client-end-date');
    const mobileClientEstimatedEnd = document.getElementById('mobile-client-estimated-end');
    if (mobileClientEndDate && mobileClientEstimatedEnd) {
        if (c.estimatedEnd && c.estimatedEnd !== '√Ä d√©finir' && c.estimatedEnd !== 'Termin√©') {
            // Parser le format "20 jan" vers une date compl√®te
            const dateStr = c.estimatedEnd;
            const months = {'jan': 0, 'f√©v': 1, 'mar': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                            'juil': 6, 'ao√ªt': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'd√©c': 11};
            const parts = dateStr.toLowerCase().split(' ');
            if (parts.length === 2) {
                const day = parseInt(parts[0]);
                const monthIndex = months[parts[1]];
                if (!isNaN(day) && monthIndex !== undefined) {
                    const year = new Date().getFullYear();
                    const date = new Date(year, monthIndex, day);
                    mobileClientEndDate.textContent = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    mobileClientEstimatedEnd.style.display = 'flex';
                } else {
                    mobileClientEndDate.textContent = c.estimatedEnd;
                    mobileClientEstimatedEnd.style.display = 'flex';
                }
            } else {
                mobileClientEndDate.textContent = c.estimatedEnd;
                mobileClientEstimatedEnd.style.display = 'flex';
            }
        } else {
            mobileClientEstimatedEnd.style.display = 'none';
        }
    }

    // Cercle de progression mobile (rayon 62)
    if (mobileClientProgressCircle) {
        const mobileCircumference = 2 * Math.PI * 62;
        const mobileOffset = mobileCircumference - (c.progress / 100) * mobileCircumference;
        mobileClientProgressCircle.setAttribute('stroke-dashoffset', mobileOffset);
    }

    // Stages mobile
    if (mobileClientStages) {
        const stageOrder = ['preparation', 'en_cours', 'finitions', 'livre'];
        const stageNames = ['Pr√©pa', 'En cours', 'Finitions', 'Livr√©'];
        const currentStageIndex = stageOrder.indexOf(c.stage);
        const isFullyCompleted = c.stage === 'livre' || c.progress === 100;

        let mobileStagesHtml = '';
        stageOrder.forEach((stage, i) => {
            const isCompleted = isFullyCompleted ? true : (i < currentStageIndex);
            const isCurrent = isFullyCompleted ? false : (i === currentStageIndex);
            const bgClass = isCompleted ? 'bg-green-500 text-white' : (isCurrent ? 'bg-primary-600 text-white' : 'bg-slate-200 text-slate-400');
            const textClass = isCompleted ? 'text-green-600' : (isCurrent ? 'text-primary-600 font-medium' : 'text-slate-400');
            const lineClass = isCompleted ? 'bg-green-500' : 'bg-slate-200';
            const content = isCompleted ? '&#10003;' : (i + 1);

            mobileStagesHtml += `<div class="flex flex-col items-center"><div class="w-7 h-7 ${bgClass} rounded-full flex items-center justify-center text-xs">${content}</div><span class="text-[10px] ${textClass} mt-1">${stageNames[i]}</span></div>`;
            if (i < stageOrder.length - 1) {
                mobileStagesHtml += `<div class="flex-1 h-1 ${lineClass} self-center mx-1 rounded"></div>`;
            }
        });
        mobileClientStages.innerHTML = mobileStagesHtml;
    }

    // Historique mobile (avec √©chappement XSS)
    if (mobileClientHistory && c.history) {
        let mobileHistoryHtml = '';
        c.history.slice(0, 5).forEach(h => {
            const safeTitle = escapeHtml(h.title);
            const safeDate = escapeHtml(h.date);

            // Construire les m√©dias (photo/vocal) - URLs valid√©es
            let mediaHtml = '';
            if (h.photoUrl && h.photoUrl.startsWith('https://')) {
                mediaHtml += `<img src="${escapeHtml(h.photoUrl)}" alt="Photo" class="mt-2 w-full rounded-lg cursor-pointer hover:opacity-90" onclick="openImageModal('${escapeHtml(h.photoUrl)}')">`;
            }
            if (h.voiceUrl && h.voiceUrl.startsWith('https://')) {
                mediaHtml += `<audio src="${escapeHtml(h.voiceUrl)}" controls class="mt-2 h-8 w-full"></audio>`;
            }

            mobileHistoryHtml += `
            <div class="bg-white border border-slate-200 rounded-xl p-3">
                <div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-slate-700">${safeTitle}</span><span class="text-xs text-slate-400">${safeDate}</span></div>
                <div class="flex items-center gap-2"><div class="h-1.5 flex-1 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-primary-600 rounded-full" style="width:${h.progress}%"></div></div><span class="text-xs text-slate-500">${h.progress}%</span></div>
                ${mediaHtml}
            </div>`;
        });
        mobileClientHistory.innerHTML = mobileHistoryHtml || '<p class="text-slate-400 text-sm">Aucun historique</p>';
    }

    // Afficher/masquer la section feedback selon l'√©tat du chantier
    const feedbackSection = document.getElementById('client-feedback-section');
    const alreadyRatedSection = document.getElementById('client-already-rated');
    const ratedEmoji = document.getElementById('client-rated-emoji');

    if (feedbackSection && alreadyRatedSection) {
        if (c.progress === 100) {
            if (c.clientFeedback) {
                // D√©j√† not√©
                feedbackSection.classList.add('hidden');
                alreadyRatedSection.classList.remove('hidden');
                const emojis = {1: 'üòï', 2: 'üôÇ', 3: 'üòä', 4: 'ü§©'};
                if (ratedEmoji) ratedEmoji.textContent = emojis[c.clientFeedback] || 'ü§©';
            } else {
                // Pas encore not√© - montrer le formulaire
                feedbackSection.classList.remove('hidden');
                alreadyRatedSection.classList.add('hidden');
                // R√©initialiser l'√©tat des emojis
                resetEmojiSelection();
            }
        } else {
            // Chantier pas termin√© - tout masquer
            feedbackSection.classList.add('hidden');
            alreadyRatedSection.classList.add('hidden');
        }
    }

    // Mettre √† jour les boutons de contact avec le num√©ro de l'artisan
    const artisanPhone = appData.user.phone;
    const clientContactSection = document.getElementById('client-contact-section');
    const mobileClientContactSection = document.getElementById('mobile-client-contact-section');
    const clientCallBtn = document.getElementById('client-call-btn');
    const clientWhatsappBtn = document.getElementById('client-whatsapp-btn');
    const mobileClientCallBtn = document.getElementById('mobile-client-call-btn');
    const mobileClientWhatsappBtn = document.getElementById('mobile-client-whatsapp-btn');

    if (artisanPhone) {
        // Nettoyer le num√©ro pour les liens (enlever espaces, tirets, points)
        const cleanPhone = artisanPhone.replace(/[\s\-\.]/g, '');
        // Format international pour WhatsApp (remplacer 0 initial par 33 ou 262, etc.)
        let whatsappPhone = cleanPhone;
        if (cleanPhone.startsWith('0')) {
            // D√©tecter si c'est un num√©ro DOM-TOM ou m√©tropole
            if (cleanPhone.startsWith('0692') || cleanPhone.startsWith('0693')) {
                whatsappPhone = '262' + cleanPhone.slice(1); // R√©union
            } else if (cleanPhone.startsWith('0694') || cleanPhone.startsWith('0696') || cleanPhone.startsWith('0697')) {
                whatsappPhone = '596' + cleanPhone.slice(1); // Martinique/Guadeloupe
            } else {
                whatsappPhone = '33' + cleanPhone.slice(1); // M√©tropole
            }
        }

        // Afficher les sections de contact
        if (clientContactSection) clientContactSection.style.display = 'block';
        if (mobileClientContactSection) mobileClientContactSection.style.display = 'block';

        // Mettre √† jour les liens
        if (clientCallBtn) clientCallBtn.href = 'tel:' + cleanPhone;
        if (clientWhatsappBtn) clientWhatsappBtn.href = 'https://wa.me/' + whatsappPhone;
        if (mobileClientCallBtn) mobileClientCallBtn.href = 'tel:' + cleanPhone;
        if (mobileClientWhatsappBtn) mobileClientWhatsappBtn.href = 'https://wa.me/' + whatsappPhone;
    } else {
        // Masquer les sections si pas de num√©ro
        if (clientContactSection) clientContactSection.style.display = 'none';
        if (mobileClientContactSection) mobileClientContactSection.style.display = 'none';
    }
}

// R√©initialiser la s√©lection d'emoji
function resetEmojiSelection() {
    document.querySelectorAll('.emoji-mood').forEach(btn => {
        btn.classList.remove('scale-125', 'opacity-100');
        btn.classList.add('opacity-60');
    });
    const hint = document.getElementById('client-emoji-hint');
    const submitBtn = document.getElementById('client-emoji-submit');
    if (hint) hint.textContent = 'Optionnel, sans pression';
    if (submitBtn) submitBtn.disabled = true;
    selectedMoodInline = 0;
}

// Variable pour stocker le mood s√©lectionn√©
let selectedMoodInline = 0;

// S√©lectionner un emoji (version inline dans la vue client)
function setClientMoodInline(mood) {
    selectedMoodInline = mood;
    const allMoods = document.querySelectorAll('.emoji-mood');
    const hint = document.getElementById('client-emoji-hint');
    const submitBtn = document.getElementById('client-emoji-submit');

    allMoods.forEach((btn) => {
        const btnMood = parseInt(btn.dataset.mood);
        if (btnMood === mood) {
            btn.classList.remove('opacity-60');
            btn.classList.add('scale-125', 'opacity-100');
        } else {
            btn.classList.add('opacity-60');
            btn.classList.remove('scale-125', 'opacity-100');
        }
    });

    // Messages doux, sans pression
    const messages = {
        1: "Merci pour votre honn√™tet√©",
        2: "Merci pour votre retour",
        3: "Content que √ßa se soit bien pass√© !",
        4: "G√©nial ! Merci beaucoup !"
    };
    if (hint) hint.textContent = messages[mood];
    if (submitBtn) submitBtn.disabled = false;

    if (mood === 4) {
        showConfetti();
    }
}

// Soumettre le feedback (version inline)
function submitClientMoodInline() {
    if (selectedMoodInline > 0) {
        const c = getCurrentChantier();
        if (c) {
            c.clientFeedback = selectedMoodInline;
            saveData(appData);
            renderAll();
            showToast('üôè Merci pour votre avis !');
        }
    }
}

// Rendre tout
function renderAll() {
    renderChantiersList();
    renderChantierDetail();
    renderClientView();
    renderHeaderStats();
    renderProfile();
    updateTrialIndicator();
}

// Rendre le profil utilisateur dynamique
function renderProfile() {
    const user = appData.user;

    // Avatar initials dans le header et le profil
    const headerAvatar = document.getElementById('header-avatar');
    const mobileHeaderAvatar = document.getElementById('mobile-header-avatar');
    const profileAvatar = document.getElementById('profile-avatar');

    if (headerAvatar) headerAvatar.textContent = user.initials;
    if (mobileHeaderAvatar) mobileHeaderAvatar.textContent = user.initials;
    if (profileAvatar) profileAvatar.textContent = user.initials;

    // Nom et anciennet√©
    const profileName = document.getElementById('profile-name');
    const profileSince = document.getElementById('profile-since');

    if (profileName) profileName.textContent = user.name;
    if (profileSince) profileSince.textContent = 'Artisan depuis ' + user.since;

    // Stats du profil
    const totalChantiers = appData.chantiers.length;
    const feedbacks = appData.chantiers.filter(c => c.clientFeedback).map(c => c.clientFeedback);
    const avgRating = feedbacks.length > 0 ? (feedbacks.reduce((a, b) => a + b, 0) / feedbacks.length * 1.25).toFixed(1) : '-';
    const satisfiedCount = feedbacks.filter(f => f >= 3).length;
    const satisfactionRate = feedbacks.length > 0 ? Math.round((satisfiedCount / feedbacks.length) * 100) + '%' : '-';

    const profileChantiersCount = document.getElementById('profile-chantiers-count');
    const profileNote = document.getElementById('profile-note');
    const profileSatisfaction = document.getElementById('profile-satisfaction');

    if (profileChantiersCount) profileChantiersCount.textContent = totalChantiers;
    if (profileNote) profileNote.textContent = avgRating;
    if (profileSatisfaction) profileSatisfaction.textContent = satisfactionRate;
}

// Mettre √† jour les boutons d'√©tape selon le stage actuel
function updateStageButtons(currentStage) {
    const stageMap = {
        'preparation': 0,
        'en_cours': 1,
        'finitions': 2,
        'livre': 3
    };
    const currentIndex = stageMap[currentStage] ?? 1;

    // Desktop stage buttons
    document.querySelectorAll('.stage-btn').forEach((btn, i) => {
        btn.classList.remove('active', 'bg-primary-600', 'text-white', 'border-primary-500');
        btn.classList.add('border-slate-200');
        if (i === currentIndex) {
            btn.classList.add('active', 'bg-primary-600', 'text-white', 'border-primary-500');
            btn.classList.remove('border-slate-200');
        }
    });

    // Mobile stage buttons
    document.querySelectorAll('.mobile-stage-btn').forEach((btn, i) => {
        btn.classList.remove('active', 'bg-primary-600', 'text-white', 'border-primary-500');
        btn.classList.add('border-slate-200');
        if (i === currentIndex) {
            btn.classList.add('active', 'bg-primary-600', 'text-white', 'border-primary-500');
            btn.classList.remove('border-slate-200');
        }
    });
}

// Rendre les stats du header dynamiques
function renderHeaderStats() {
    const chantiersEnCours = appData.chantiers.filter(c => c.progress < 100).length;
    const chantiersTermines = appData.chantiers.filter(c => c.progress === 100).length;
    const totalChantiers = chantiersEnCours + chantiersTermines;

    // Calcul de la note moyenne (bas√© sur les feedbacks)
    const feedbacks = appData.chantiers.filter(c => c.clientFeedback).map(c => c.clientFeedback);
    const avgRating = feedbacks.length > 0 ? (feedbacks.reduce((a, b) => a + b, 0) / feedbacks.length * 1.25).toFixed(1) : '4.9';

    // Desktop header
    document.querySelectorAll('.header-chantiers-count').forEach(el => {
        el.textContent = chantiersEnCours + ' chantier' + (chantiersEnCours > 1 ? 's' : '') + ' en cours';
    });
    document.querySelectorAll('.stat-rating').forEach(el => {
        el.textContent = avgRating;
    });
    document.querySelectorAll('.stat-total-chantiers').forEach(el => {
        el.textContent = totalChantiers;
    });

    // Notification client qui a vu (avec √©chappement XSS)
    const viewedClients = appData.chantiers.filter(c => c.clientViewed && c.progress < 100);
    const notifClientName = document.getElementById('notif-client-name');
    const notifContainer = document.getElementById('notification-client-viewed');
    if (viewedClients.length > 0 && notifClientName) {
        notifClientName.innerHTML = '<strong>' + escapeHtml(viewedClients[0].client) + '</strong>';
        if (notifContainer) notifContainer.classList.remove('hidden');
    } else if (notifContainer) {
        notifContainer.classList.add('hidden');
    }

    // Mobile header
    const mobileCount = document.querySelector('#mobile-screen-list .text-slate-500.text-sm');
    if (mobileCount) mobileCount.textContent = chantiersEnCours + ' chantier' + (chantiersEnCours > 1 ? 's' : '') + ' en cours';

    // Nom de l'utilisateur (desktop + mobile)
    const userName = document.getElementById('header-user-name');
    const mobileUserName = document.getElementById('mobile-header-user-name');
    const greeting = 'Bonjour ' + appData.user.name.split(' ')[0] + ' !';
    if (userName) userName.textContent = greeting;
    if (mobileUserName) mobileUserName.textContent = greeting;

    // Mobile chantiers count
    document.querySelectorAll('.mobile-chantiers-count').forEach(el => {
        el.textContent = chantiersEnCours + ' chantier' + (chantiersEnCours > 1 ? 's' : '') + ' en cours';
    });

    // Mobile stats
    document.querySelectorAll('.mobile-stat-rating').forEach(el => {
        el.textContent = avgRating;
    });
    document.querySelectorAll('.mobile-stat-total').forEach(el => {
        el.textContent = totalChantiers;
    });

    // Mobile notification client (avec √©chappement XSS)
    const mobileNotifClient = document.getElementById('mobile-notif-client-name');
    const mobileNotifContainer = document.getElementById('mobile-notification-client');
    if (viewedClients.length > 0 && mobileNotifClient) {
        mobileNotifClient.innerHTML = '<strong>' + escapeHtml(viewedClients[0].client) + '</strong>';
        if (mobileNotifContainer) mobileNotifContainer.classList.remove('hidden');
    } else if (mobileNotifContainer) {
        mobileNotifContainer.classList.add('hidden');
    }
}

// =============================================
// NAVIGATION
// =============================================

async function showScreen(screenId) {
    // Attendre que les donn√©es soient charg√©es (max 3 secondes)
    if (!dataLoaded && APP_MODE === 'supabase') {
        console.log('‚è≥ Attente du chargement des donn√©es...');
        let attempts = 0;
        while (!dataLoaded && attempts < 30) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        if (!dataLoaded) {
            console.log('‚ö†Ô∏è Timeout - donn√©es non charg√©es');
            showToast('Chargement en cours...', false);
            return;
        }
    }

    // V√©rifier qu'un chantier est s√©lectionn√© pour les √©crans qui en n√©cessitent un
    const requiresChantier = ['detail', 'update', 'client'];
    if (requiresChantier.includes(screenId)) {
        let c = getCurrentChantier();

        // Si aucun chantier s√©lectionn√©, s√©lectionner le premier automatiquement
        if (!c && appData.chantiers && appData.chantiers.length > 0) {
            appData.currentChantier = appData.chantiers[0].id;
            c = appData.chantiers[0];
            console.log('Auto-s√©lection du premier chantier:', c.name);
        }

        if (!c) {
            // Toujours pas de chantier (liste vide), retourner √† la liste
            console.log('Aucun chantier disponible, retour √† la liste');
            screenId = 'list';
        } else {
            // Charger l'historique si pas d√©j√† charg√© ou si mode Supabase
            if (APP_MODE === 'supabase' && window.SuiviTravauxAPI && (!c.history || c.history.length === 0 || c._historyNeedsRefresh)) {
                try {
                    const updates = await SuiviTravauxAPI.Updates.getByChantier(c.id);
                    if (updates) {
                        c.history = updates.map(u => ({
                            title: u.title || 'Mise √† jour',
                            progress: u.progress,
                            date: formatDate(u.created_at),
                            hasPhotos: !!u.photo_url,
                            photoUrl: u.photo_url || null,
                            voiceUrl: u.voice_url || null
                        }));
                        c._historyNeedsRefresh = false;
                        // Rafra√Æchir l'affichage avec l'historique charg√©
                        renderChantierDetail();
                        renderClientView();
                    }
                } catch (error) {
                    console.error('Erreur chargement historique:', error);
                }
            }
        }
    }

    document.querySelectorAll('.phone-content .screen').forEach(s => s.classList.remove('active'));
    const ds = document.getElementById('screen-' + screenId);
    if (ds) ds.classList.add('active');

    document.querySelectorAll('.mobile-content .screen').forEach(s => s.classList.remove('active'));
    const ms = document.getElementById('mobile-screen-' + screenId);
    if (ms) ms.classList.add('active');

    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary-600', 'text-white');
        btn.classList.add('text-slate-600');
    });
    const adb = document.querySelector('.nav-btn[data-screen="' + screenId + '"]');
    if (adb) { adb.classList.add('bg-primary-600', 'text-white'); adb.classList.remove('text-slate-600'); }

    document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
        btn.classList.remove('text-primary-600');
        btn.classList.add('text-slate-400');
        btn.querySelector('span').classList.remove('font-medium');
    });
    const amb = document.querySelector('.nav-btn-mobile[data-screen-mobile="' + screenId + '"]');
    if (amb) { amb.classList.remove('text-slate-400'); amb.classList.add('text-primary-600'); amb.querySelector('span').classList.add('font-medium'); }

    // Afficher/masquer le FAB selon l'√©cran
    const fab = document.getElementById('fab-new-chantier');
    const mobileFab = document.querySelector('.mobile-content + .fixed');
    if (fab) {
        fab.style.display = (screenId === 'list') ? 'flex' : 'none';
    }
}

function setProgress(value) {
    const slider = document.getElementById('progress-slider');
    const display = document.getElementById('progress-value');
    if (slider) slider.value = value;
    if (display) display.textContent = value + '%';
    const mSlider = document.getElementById('mobile-progress-slider');
    const mDisplay = document.getElementById('mobile-progress-value');
    if (mSlider) mSlider.value = value;
    if (mDisplay) mDisplay.textContent = value + '%';
}

document.addEventListener('DOMContentLoaded', function() {
    const slider = document.getElementById('progress-slider');
    const display = document.getElementById('progress-value');
    const mSlider = document.getElementById('mobile-progress-slider');
    const mDisplay = document.getElementById('mobile-progress-value');

    if (slider) slider.addEventListener('input', (e) => {
        if (display) display.textContent = e.target.value + '%';
        if (mSlider) mSlider.value = e.target.value;
        if (mDisplay) mDisplay.textContent = e.target.value + '%';
    });
    if (mSlider) mSlider.addEventListener('input', (e) => {
        if (mDisplay) mDisplay.textContent = e.target.value + '%';
        if (slider) slider.value = e.target.value;
        if (display) display.textContent = e.target.value + '%';
    });

    document.querySelectorAll('.stage-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.stage-btn').forEach(b => { b.classList.remove('active','bg-primary-600','text-white','border-primary-500'); b.classList.add('border-slate-200'); });
            this.classList.add('active','bg-primary-600','text-white','border-primary-500'); this.classList.remove('border-slate-200');
        });
    });
    document.querySelectorAll('.mobile-stage-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.mobile-stage-btn').forEach(b => { b.classList.remove('active','bg-primary-600','text-white','border-primary-500'); b.classList.add('border-slate-200'); });
            this.classList.add('active','bg-primary-600','text-white','border-primary-500'); this.classList.remove('border-slate-200');
        });
    });
});

// Modal functions
function openNewChantierModal() {
    // V√©rifier la limite du mode d√©mo
    if (APP_MODE === 'demo' && !canCreateChantierDemo()) {
        checkDemoRestriction('create_chantier');
        return;
    }

    // V√©rifier la limite de l'essai gratuit
    const check = canCreateChantier();
    if (!check.allowed) {
        showTrialLimitModal();
        return;
    }

    document.getElementById('newChantierModal').classList.add('active');
    // Pr√©-remplir le nom de l'artisan
    const artisanInput = document.getElementById('new-artisan-name');
    if (artisanInput) artisanInput.value = appData.user.name;

    // Afficher info sur les chantiers restants si en essai
    const trialInfo = getTrialInfoMessage();
    const infoContainer = document.getElementById('new-chantier-trial-info');
    if (infoContainer && trialInfo) {
        infoContainer.innerHTML = `
            <div class="flex items-center gap-2 text-sm ${trialInfo.type === 'warning' ? 'text-amber-600 bg-amber-50' : 'text-slate-500 bg-slate-50'} px-3 py-2 rounded-lg">
                <span>${trialInfo.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <span>${trialInfo.text}</span>
            </div>
        `;
        infoContainer.classList.remove('hidden');
    } else if (infoContainer) {
        infoContainer.classList.add('hidden');
    }
}
function closeNewChantierModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('newChantierModal').classList.remove('active');
    }
}
function createChantier() {
    closeNewChantierModal();
    showToast('Chantier cr√©√© ! Lien client g√©n√©r√©.');
    showScreen('detail');
}

async function createChantierWithLoading(btn) {
    // R√©cup√©rer les valeurs du formulaire via les IDs
    const chantierNameInput = document.getElementById('new-chantier-name');
    const clientNameInput = document.getElementById('new-client-name');
    const artisanNameInput = document.getElementById('new-artisan-name');
    const estimatedEndInput = document.getElementById('new-estimated-end');

    const chantierName = chantierNameInput?.value.trim();
    const clientName = clientNameInput?.value.trim();
    const estimatedEnd = estimatedEndInput?.value || null;

    if (!chantierName || !clientName) {
        showToast('‚ö†Ô∏è Remplissez tous les champs');
        return;
    }

    setButtonLoading(btn, true);

    // Cr√©er le chantier (async pour Supabase)
    const newChantier = await createNewChantier(chantierName, clientName, estimatedEnd);

    setButtonLoading(btn, false);

    if (newChantier) {
        // R√©initialiser le formulaire
        if (chantierNameInput) chantierNameInput.value = '';
        if (clientNameInput) clientNameInput.value = '';
        if (artisanNameInput) artisanNameInput.value = appData.user.name;
        if (estimatedEndInput) estimatedEndInput.value = '';

        closeNewChantierModal();
        showConfetti();
        renderAll();
        showToast('üéâ Chantier "' + chantierName + '" cr√©√© !');
        showScreen('detail');
    }
}

// Toast function
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = isError ? '#dc2626' : '#059669';
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
}

// Afficher une erreur utilisateur (pour les erreurs r√©seau, etc.)
function showError(message) {
    showToast(message || 'Une erreur est survenue. Veuillez r√©essayer.', true);
}

// Gestion globale des erreurs non captur√©es
window.addEventListener('unhandledrejection', function(event) {
    console.error('Erreur non g√©r√©e:', event.reason);
    // Ne pas afficher les erreurs techniques aux utilisateurs, juste logger
});

// V√©rifier la connexion r√©seau
function checkOnlineStatus() {
    if (!navigator.onLine) {
        showToast('Vous √™tes hors ligne. Certaines fonctionnalit√©s sont indisponibles.', true);
    }
}
window.addEventListener('online', () => showToast('Connexion r√©tablie'));
window.addEventListener('offline', () => showToast('Connexion perdue', true));

// Modal pour afficher les images en plein √©cran
function openImageModal(imageUrl) {
    // Cr√©er le modal s'il n'existe pas
    let modal = document.getElementById('image-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.className = 'fixed inset-0 bg-black/90 z-[500] flex items-center justify-center p-4 cursor-pointer';
        modal.style.display = 'none';
        modal.onclick = () => modal.style.display = 'none';
        modal.innerHTML = `
            <button class="absolute top-4 right-4 text-white p-2 hover:bg-white/20 rounded-full" onclick="document.getElementById('image-modal').style.display='none'">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="modal-image" src="" alt="Photo" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
        `;
        document.body.appendChild(modal);
    }

    // Afficher l'image
    document.getElementById('modal-image').src = imageUrl;
    modal.style.display = 'flex';
}

// =============================================
// GESTION DES PHOTOS
// =============================================
let selectedPhotos = [];

function handlePhotoSelect(input) {
    // V√©rifier restriction mode d√©mo
    if (checkDemoRestriction('photo')) {
        input.value = '';
        return;
    }

    const files = Array.from(input.files);
    const maxPhotos = 3;

    if (selectedPhotos.length + files.length > maxPhotos) {
        showToast('Maximum ' + maxPhotos + ' photos');
        return;
    }

    files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
            showToast('Photo trop lourde (max 5MB)');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            selectedPhotos.push({
                file: file,
                preview: e.target.result
            });
            renderPhotoPreview();
        };
        reader.readAsDataURL(file);
    });

    input.value = '';
}

function renderPhotoPreview() {
    const container = document.getElementById('photo-preview-container');
    const maxPhotos = 3;

    let html = '';

    selectedPhotos.forEach((photo, index) => {
        html += '<div class="relative w-24 h-24">' +
            '<img src="' + photo.preview + '" class="w-full h-full object-cover rounded-xl">' +
            '<button onclick="removePhoto(' + index + ')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs shadow-lg">&times;</button>' +
        '</div>';
    });

    if (selectedPhotos.length < maxPhotos) {
        html += '<div onclick="document.getElementById(\'update-photos\').click()" class="w-24 h-24 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:bg-slate-200 transition-colors">' +
            '<svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>' +
        '</div>';
    }

    container.innerHTML = html;
}

function removePhoto(index) {
    selectedPhotos.splice(index, 1);
    renderPhotoPreview();
}

function clearPhotos() {
    selectedPhotos = [];
    renderPhotoPreview();
}

// =============================================
// GESTION DE L'ENREGISTREMENT VOCAL
// =============================================
let mediaRecorder = null;
let audioChunks = [];
let voiceBlob = null;
let isRecording = false;
let currentStream = null;

// D√©terminer le meilleur type MIME support√©
function getSupportedMimeType() {
    const types = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/mp4',
        'audio/mpeg'
    ];
    for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) {
            console.log('Format audio support√©:', type);
            return type;
        }
    }
    return 'audio/webm'; // Fallback
}

async function startRecording() {
    // V√©rifier restriction mode d√©mo
    if (checkDemoRestriction('voice', 'Les messages vocaux ne sont pas disponibles en mode d√©mo.')) return;

    if (isRecording) return;

    try {
        currentStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            }
        });

        const mimeType = getSupportedMimeType();
        const options = { mimeType };

        try {
            mediaRecorder = new MediaRecorder(currentStream, options);
        } catch (e) {
            // Si le mimeType n'est pas support√©, utiliser les param√®tres par d√©faut
            console.warn('MimeType non support√©, utilisation des param√®tres par d√©faut');
            mediaRecorder = new MediaRecorder(currentStream);
        }

        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            if (audioChunks.length === 0) {
                console.error('Aucune donn√©e audio enregistr√©e');
                showToast('Erreur: aucun son captur√©');
                return;
            }

            // Utiliser le type MIME r√©el du recorder
            const actualMimeType = mediaRecorder.mimeType || 'audio/webm';
            voiceBlob = new Blob(audioChunks, { type: actualMimeType });

            console.log('Blob cr√©√©:', voiceBlob.size, 'bytes, type:', actualMimeType);

            if (voiceBlob.size < 100) {
                console.error('Enregistrement trop court');
                showToast('Enregistrement trop court');
                return;
            }

            const audioUrl = URL.createObjectURL(voiceBlob);
            const audioElement = document.getElementById('voice-audio');

            audioElement.src = audioUrl;
            audioElement.load(); // Forcer le chargement

            document.getElementById('voice-preview').classList.remove('hidden');
            document.getElementById('voice-record-btn').classList.add('hidden');

            // Arr√™ter le stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        };

        // Collecter les donn√©es toutes les 100ms pour √©viter de perdre des chunks
        mediaRecorder.start(100);
        isRecording = true;

        document.getElementById('voice-record-btn').classList.add('bg-red-100', 'border-red-500');
        document.getElementById('voice-record-text').textContent = 'Enregistrement...';

    } catch (err) {
        console.error('Erreur micro:', err);
        if (err.name === 'NotAllowedError') {
            showToast('Acc√®s au micro refus√©');
        } else if (err.name === 'NotFoundError') {
            showToast('Aucun micro d√©tect√©');
        } else {
            showToast('Impossible d\'acc√©der au micro');
        }
    }
}

function stopRecording() {
    if (!isRecording || !mediaRecorder) return;

    // V√©rifier que l'√©tat du recorder permet l'arr√™t
    if (mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }

    isRecording = false;

    document.getElementById('voice-record-btn').classList.remove('bg-red-100', 'border-red-500');
    document.getElementById('voice-record-text').textContent = 'Maintenir pour enregistrer';
}

function deleteVoiceRecording() {
    voiceBlob = null;
    document.getElementById('voice-audio').src = '';
    document.getElementById('voice-preview').classList.add('hidden');
    document.getElementById('voice-record-btn').classList.remove('hidden');
}

function clearVoice() {
    deleteVoiceRecording();
}

// =============================================
// ENVOI DE LA MISE A JOUR
// =============================================

// Send update function
function sendUpdate() {
    document.getElementById('successModal').classList.add('active');
}

// Success modal functions
function closeSuccessModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('successModal').classList.remove('active');
        showScreen('detail');
    }
}

// Send rating request to client
function sendRatingRequest() {
    closeSuccessModal();
    const c = getCurrentChantier();
    const clientName = c ? c.client : 'votre client';
    showToast('üì© Demande d\'avis envoy√©e √† ' + clientName + ' !');
}

// Client feedback modal (FIN DE CHANTIER uniquement)
function openClientFeedback() {
    // Mettre √† jour le nom de l'artisan dynamiquement
    const thankEl = document.getElementById('client-thank-artisan');
    if (thankEl && appData.user.name) {
        const firstName = appData.user.name.split(' ')[0];
        thankEl.textContent = 'Merci d\'avoir fait confiance √† ' + firstName;
    }
    document.getElementById('clientFeedbackModal').classList.add('active');
}
function closeClientFeedback(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('clientFeedbackModal').classList.remove('active');
    }
}

// Client mood system (optionnel, sans pression)
let clientMood = 0;
function setClientMood(mood) {
    clientMood = mood;
    const allMoods = document.querySelectorAll('.client-mood');
    const hint = document.getElementById('client-mood-hint');
    const submitBtn = document.getElementById('submit-mood-btn');

    allMoods.forEach((btn) => {
        const btnMood = parseInt(btn.dataset.mood);
        if (btnMood === mood) {
            btn.classList.remove('opacity-50');
            btn.classList.add('scale-125');
        } else {
            btn.classList.add('opacity-50');
            btn.classList.remove('scale-125');
        }
    });

    // Messages doux, sans pression
    const messages = {
        1: "Merci pour votre honn√™tet√©",
        2: "Merci pour votre retour",
        3: "Content que √ßa se soit bien pass√© !",
        4: "G√©nial ! Merci beaucoup ! üéâ"
    };
    if (hint) hint.textContent = messages[mood];
    if (submitBtn) submitBtn.disabled = false;

    if (mood === 4) {
        showConfetti();
    }
}

function submitClientMood() {
    if (clientMood > 0) {
        const emojis = {1: 'üòï', 2: 'üôÇ', 3: 'üòä', 4: 'ü§©'};
        showToast('üôè Merci pour votre retour !');
        // Close modal after submit
        document.getElementById('clientFeedbackModal').classList.remove('active');
    }
}

// Quick photo function - Ouvre l'appareil photo pour une mise √† jour rapide
function quickPhoto() {
    // V√©rifier restriction mode d√©mo
    if (checkDemoRestriction('photo')) return;

    const c = getCurrentChantier();
    if (!c) {
        showToast('S√©lectionnez un chantier d\'abord');
        return;
    }

    // Cr√©er un input file temporaire pour la capture photo
    let photoInput = document.getElementById('quick-photo-input');
    if (!photoInput) {
        photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.id = 'quick-photo-input';
        photoInput.accept = 'image/*';
        photoInput.capture = 'environment'; // Cam√©ra arri√®re sur mobile
        photoInput.style.display = 'none';
        document.body.appendChild(photoInput);

        photoInput.addEventListener('change', async function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];

                // V√©rifier la taille (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Photo trop lourde (max 5MB)', true);
                    return;
                }

                showToast('üì∏ Envoi de la photo...');

                try {
                    let photoUrl = null;

                    // Upload vers Supabase si connect√©
                    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
                        photoUrl = await SuiviTravauxAPI.Storage.uploadPhoto(c.id, file);
                    } else {
                        // Mode d√©mo - cr√©er un URL local temporaire
                        photoUrl = URL.createObjectURL(file);
                    }

                    // Cr√©er une mise √† jour avec la photo
                    const currentProgress = c.progress;
                    const currentStage = c.stage;

                    await updateChantierWithMedia(
                        c.id,
                        currentProgress,
                        currentStage,
                        'Photo du chantier',
                        photoUrl,
                        null
                    );

                    renderAll();
                    showConfetti();
                    showSuccessModal();

                } catch (error) {
                    console.error('Erreur upload photo:', error);
                    showToast('Erreur lors de l\'envoi', true);
                }

                // Reset l'input
                this.value = '';
            }
        });
    }

    // D√©clencher l'ouverture de l'appareil photo
    photoInput.click();
}

// Afficher le modal de succ√®s
function showSuccessModal() {
    const c = getCurrentChantier();
    if (c) {
        const clientNameEl = document.getElementById('success-client-name');
        if (clientNameEl) clientNameEl.textContent = c.client || 'Le client';
    }
    document.getElementById('successModal').classList.add('active');
}

// Copy/Share link functions
function getClientLink() {
    const c = getCurrentChantier();
    if (!c) return '';
    const token = c.shareToken || c.id;

    // En local (file://), utiliser un chemin relatif
    if (window.location.protocol === 'file:') {
        // Obtenir le chemin du dossier actuel
        const currentPath = window.location.pathname;
        const folderPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        return 'file://' + folderPath + 'client.html?t=' + token;
    }

    // En production (http/https), utiliser le baseUrl
    const baseUrl = window.location.origin;
    return baseUrl + '/client.html?t=' + token;
}

function copyLink() {
    // En mode d√©mo, afficher un message mais permettre de copier
    if (APP_MODE === 'demo') {
        showDemoUpgradeModal('Le lien copi√© est fictif. Cr√©ez un compte pour partager r√©ellement avec vos clients.');
        return;
    }
    const link = getClientLink();
    navigator.clipboard.writeText(link);
    showToast('Lien copi√© !');
}

function shareLink() {
    // V√©rifier restriction mode d√©mo
    if (checkDemoRestriction('whatsapp', 'L\'envoi WhatsApp n\'est pas disponible en mode d√©mo. Cr√©ez un compte pour partager avec vos clients.')) return;

    const c = getCurrentChantier();
    const link = getClientLink();
    const text = `Bonjour ${c?.client || ''}, suivez l'avancement de votre chantier "${c?.name || ''}" ici : ${link}`;
    window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
}

// Profile modal functions
function openProfileModal() {
    // Mettre √† jour les infos du profil
    const avatarEl = document.getElementById('profile-avatar');
    const nameEl = document.getElementById('profile-name');
    const sinceEl = document.getElementById('profile-since');
    const chantiersCountEl = document.getElementById('profile-chantiers-count');

    if (avatarEl) avatarEl.textContent = appData.user.initials || 'AR';
    if (nameEl) nameEl.textContent = appData.user.name || 'Artisan';
    if (sinceEl) sinceEl.textContent = 'Artisan depuis ' + (appData.user.since || new Date().getFullYear());
    if (chantiersCountEl) {
        const total = (appData.chantiers?.length || 0) + (appData.archivedChantiers?.length || 0);
        chantiersCountEl.textContent = total;
    }

    document.getElementById('profileModal').classList.add('active');
}
function closeProfileModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('profileModal').classList.remove('active');
    }
}

// Edit Profile modal functions
function showEditProfileForm() {
    try {
        // Pr√©-remplir les champs avec v√©rification
        const user = appData?.user || {};
        document.getElementById('edit-profile-name').value = user.name || '';
        document.getElementById('edit-profile-phone').value = user.phone || '';
        document.getElementById('edit-profile-email').value = currentUser?.email || '';

        // Cacher les messages
        document.getElementById('edit-profile-error').classList.add('hidden');
        document.getElementById('edit-profile-success').classList.add('hidden');

        // Fermer le modal profil et ouvrir l'√©dition
        document.getElementById('profileModal').classList.remove('active');
        document.getElementById('editProfileModal').classList.add('active');
    } catch (error) {
        console.error('Erreur ouverture formulaire profil:', error);
        showToast('Erreur lors de l\'ouverture');
    }
}

function closeEditProfileModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('editProfileModal').classList.remove('active');
    }
}

// Valider le format du num√©ro de t√©l√©phone fran√ßais (m√©tropole + DOM-TOM)
function isValidFrenchPhone(phone) {
    if (!phone) return true; // Le t√©l√©phone est optionnel
    // Nettoyer le num√©ro (supprimer espaces, tirets, points)
    const cleaned = phone.replace(/[\s\-\.]/g, '');
    // Formats accept√©s:
    // - M√©tropole mobile: 06/07 + 8 chiffres
    // - M√©tropole fixe: 01-05, 09 + 8 chiffres
    // - La R√©union mobile: 0692/0693 + 6 chiffres
    // - La R√©union fixe: 0262 + 6 chiffres
    // - Avec indicatif international +33 ou +262
    const metropoleMobile = /^(0[67]\d{8}|\+33[67]\d{8})$/;
    const metropoleFixed = /^(0[1-59]\d{8}|\+33[1-59]\d{8})$/;
    const reunionMobile = /^(069[23]\d{6}|\+26269[23]\d{6})$/;
    const reunionFixed = /^(0262\d{6}|\+262262\d{6})$/;
    return metropoleMobile.test(cleaned) || metropoleFixed.test(cleaned) ||
           reunionMobile.test(cleaned) || reunionFixed.test(cleaned);
}

async function saveProfile() {
    const name = document.getElementById('edit-profile-name').value.trim();
    const phone = document.getElementById('edit-profile-phone').value.trim();
    const errorEl = document.getElementById('edit-profile-error');
    const successEl = document.getElementById('edit-profile-success');
    const btn = document.getElementById('save-profile-btn');

    if (!name) {
        errorEl.textContent = 'Le nom est obligatoire';
        errorEl.classList.remove('hidden');
        successEl.classList.add('hidden');
        return;
    }

    // Valider le num√©ro de t√©l√©phone
    if (phone && !isValidFrenchPhone(phone)) {
        errorEl.textContent = 'Num√©ro invalide. Ex: 0692 12 34 56 (R√©union) ou 06 12 34 56 78 (M√©tropole)';
        errorEl.classList.remove('hidden');
        successEl.classList.add('hidden');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Enregistrement...';
    errorEl.classList.add('hidden');

    try {
        // Mettre √† jour localement
        appData.user.name = name;
        appData.user.phone = phone;
        appData.user.initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

        // Si connect√© √† Supabase, mettre √† jour en ligne
        if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
            await SuiviTravauxAPI.Auth.updateProfile({
                name: name,
                phone: phone,
                initials: appData.user.initials
            });
        }

        saveData(appData);
        renderAll();

        successEl.textContent = 'Profil mis √† jour !';
        successEl.classList.remove('hidden');

        // Fermer apr√®s un d√©lai
        setTimeout(() => {
            closeEditProfileModal();
            showToast('Profil mis √† jour !');
        }, 1000);

    } catch (error) {
        errorEl.textContent = error.message || 'Erreur lors de la mise √† jour';
        errorEl.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Enregistrer';
    }
}

// Review request modal functions
function closeReviewModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('reviewRequestModal').classList.remove('active');
    }
}
function sendReviewRequest() {
    closeReviewModal();
    showToast('Demande d\'avis envoy√©e au client !');
}
function skipReviewRequest() {
    closeReviewModal();
}

// Trigger review modal when completing a chantier at 100%
function completeChantier() {
    document.getElementById('reviewRequestModal').classList.add('active');
}

// Onboarding functions
let currentOnboardingSlide = 0;
function nextOnboardingSlide() {
    const slides = document.querySelectorAll('.onboarding-slide');
    slides[currentOnboardingSlide].style.display = 'none';
    currentOnboardingSlide++;
    if (currentOnboardingSlide < slides.length) {
        slides[currentOnboardingSlide].style.display = 'block';
    }
}
function closeOnboarding() {
    document.getElementById('onboardingModal').classList.remove('active');
    localStorage.setItem('onboardingComplete', 'true');
}
function showOnboarding() {
    // R√©initialiser les slides au d√©but
    currentOnboardingSlide = 0;
    const slides = document.querySelectorAll('.onboarding-slide');
    slides.forEach((slide, index) => {
        slide.style.display = index === 0 ? 'block' : 'none';
    });
    document.getElementById('onboardingModal').classList.add('active');
}

// Check if first visit (for demo, show onboarding on click)
// In production: if (!localStorage.getItem('onboardingComplete')) { showOnboarding(); }

// Dark mode toggle
let isDarkMode = false;
function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark', isDarkMode);
    document.querySelector('.phone-screen')?.classList.toggle('dark', isDarkMode);
    document.querySelector('.mobile-content')?.classList.toggle('dark', isDarkMode);

    const icon = document.getElementById('dark-mode-icon');
    const label = document.getElementById('dark-mode-label');
    const toggle = document.getElementById('dark-mode-toggle');
    const knob = document.getElementById('dark-mode-knob');

    if (isDarkMode) {
        icon.textContent = '‚òÄÔ∏è';
        label.textContent = 'Mode clair';
        toggle.classList.add('bg-primary-600');
        toggle.classList.remove('bg-slate-300');
        knob.style.transform = 'translateX(24px)';
    } else {
        icon.textContent = 'üåô';
        label.textContent = 'Mode sombre';
        toggle.classList.remove('bg-primary-600');
        toggle.classList.add('bg-slate-300');
        knob.style.transform = 'translateX(0)';
    }
    localStorage.setItem('darkMode', isDarkMode);
}

// Search/filter chantiers (en cours + termin√©s)
function filterChantiers(query) {
    const q = query.toLowerCase().trim();
    // Filtrer les chantiers en cours
    const cardsEnCours = document.querySelectorAll('#chantiers-list > div, #mobile-chantiers-list > div');
    cardsEnCours.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(q) ? '' : 'none';
    });
    // Filtrer les chantiers termin√©s
    const cardsTermines = document.querySelectorAll('#chantiers-termines-list > div, #mobile-chantiers-termines-list > div');
    cardsTermines.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(q) ? '' : 'none';
    });
}

// Confetti celebration
function showConfetti() {
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        container.appendChild(confetti);
    }
    setTimeout(() => container.remove(), 4000);
}

// Loading button state
function setButtonLoading(btn, loading) {
    if (loading) {
        btn.dataset.originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span> Envoi...';
        btn.classList.add('btn-loading');
    } else {
        btn.innerHTML = btn.dataset.originalText;
        btn.classList.remove('btn-loading');
    }
}

// Enhanced send update with loading
async function sendUpdateWithLoading(btn) {
    console.log('sendUpdateWithLoading called');
    const c = getCurrentChantier();
    if (!c) {
        console.error('Pas de chantier s√©lectionn√©');
        showToast('Aucun chantier s√©lectionn√©');
        return;
    }
    console.log('Chantier:', c.id, c.name);

    // R√©cup√©rer la progression et le commentaire
    const slider = document.getElementById('progress-slider') || document.getElementById('mobile-progress-slider');
    const textarea = btn.closest('.px-4')?.querySelector('textarea');
    const progress = parseInt(slider?.value || c.progress);
    const message = textarea?.value.trim() || '';

    // R√©cup√©rer la date de fin estim√©e
    const endDateInput = document.getElementById('update-end-date') || document.getElementById('mobile-update-end-date');
    const endDateValue = endDateInput?.value;

    // Valider que la date n'est pas dans le pass√©
    if (endDateValue) {
        const selectedDate = new Date(endDateValue);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (selectedDate < today) {
            showToast('La date de fin estim√©e ne peut pas √™tre dans le pass√©');
            return;
        }
    }

    // R√©cup√©rer l'√©tape s√©lectionn√©e
    const activeStage = document.querySelector('.stage-btn.active, .mobile-stage-btn.active');
    let stage = c.stage;
    if (activeStage) {
        const stageText = activeStage.querySelector('p')?.textContent.toLowerCase();
        if (stageText?.includes('pr√©paration')) stage = 'preparation';
        else if (stageText?.includes('en cours')) stage = 'en_cours';
        else if (stageText?.includes('finitions')) stage = 'finitions';
        else if (stageText?.includes('livr√©') || stageText?.includes('livre')) stage = 'livre';
    }

    setButtonLoading(btn, true);

    try {
        let photoUrl = null;
        let voiceUrl = null;

        // Upload photos si mode Supabase
        if (APP_MODE === 'supabase' && selectedPhotos.length > 0 && window.SuiviTravauxAPI) {
            try {
                // Upload la premi√®re photo (on peut √©tendre pour plusieurs)
                photoUrl = await SuiviTravauxAPI.Storage.uploadPhoto(c.id, selectedPhotos[0].file);
                console.log('Photo upload√©e:', photoUrl);
            } catch (e) {
                console.error('Erreur upload photo:', e);
                showToast('Erreur upload photo');
            }
        }

        // Upload vocal si mode Supabase
        if (APP_MODE === 'supabase' && voiceBlob && window.SuiviTravauxAPI) {
            try {
                voiceUrl = await SuiviTravauxAPI.Storage.uploadVoice(c.id, voiceBlob);
                console.log('Vocal upload√©:', voiceUrl);
            } catch (e) {
                console.error('Erreur upload vocal:', e);
                showToast('Erreur upload vocal');
            }
        }

        // Mettre √† jour la date de fin estim√©e si renseign√©e
        if (endDateValue) {
            const date = new Date(endDateValue);
            const options = { day: 'numeric', month: 'short' };
            c.estimatedEnd = date.toLocaleDateString('fr-FR', options);
            saveData(appData);
        }

        // Mettre √† jour le chantier
        const wasCompleted = c.progress === 100;
        await updateChantierWithMedia(c.id, progress, stage, message, photoUrl, voiceUrl);
        renderAll();

        showConfetti();

        // Mettre √† jour le nom du client dans les modals
        const successClientName = document.getElementById('success-client-name');
        const reviewClientName = document.getElementById('review-client-name');
        if (successClientName) successClientName.textContent = c.client;
        if (reviewClientName) reviewClientName.textContent = c.client;

        // Si passage √† 100%, montrer le modal de fin de chantier
        if (progress === 100 && !wasCompleted) {
            document.getElementById('reviewRequestModal').classList.add('active');
        } else {
            document.getElementById('successModal').classList.add('active');
        }

        // R√©initialiser les champs
        if (textarea) textarea.value = '';
        clearPhotos();
        clearVoice();

    } catch (error) {
        console.error('Erreur mise √† jour:', error);
        console.error('Stack:', error.stack);
        showToast('Erreur: ' + (error.message || 'Mise √† jour √©chou√©e'));
    } finally {
        setButtonLoading(btn, false);
    }
}

// Archiver un chantier
async function archiveChantier(id) {
    // Convertir l'ID en string pour la comparaison (UUID Supabase vs number d√©mo)
    const idStr = String(id);
    const chantier = appData.chantiers.find(c => String(c.id) === idStr);

    if (chantier) {
        // Si mode Supabase, archiver dans la base
        if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
            try {
                await SuiviTravauxAPI.Chantiers.archive(id);
            } catch (error) {
                console.error('Erreur archivage Supabase:', error);
                showToast('Erreur lors de l\'archivage');
                return;
            }
        }

        chantier.archivedAt = new Date().toLocaleDateString('fr-FR');
        if (!appData.archivedChantiers) appData.archivedChantiers = [];
        appData.archivedChantiers.push(chantier);
        appData.chantiers = appData.chantiers.filter(c => String(c.id) !== idStr);
        saveData(appData);
        renderAll();
        showToast('Chantier archiv√© !');
    }
}

// Confirmer l'annulation d'un chantier
function confirmCancelChantier() {
    const c = getCurrentChantier();
    if (!c) return;

    // Afficher une confirmation
    const confirmed = confirm(
        `‚ö†Ô∏è Annuler le chantier "${c.name}" ?\n\n` +
        `Cette action va marquer le chantier comme "Annul√©" et l'archiver.\n` +
        `Le client verra que le chantier a √©t√© annul√©.\n\n` +
        `Voulez-vous continuer ?`
    );

    if (confirmed) {
        cancelChantier(c.id);
    }
}

// Annuler un chantier (probl√®mes insolvables)
async function cancelChantier(id) {
    const chantier = appData.chantiers.find(c => c.id === id);
    if (!chantier) return;

    // Marquer comme annul√©
    chantier.status = 'Annul√©';
    chantier.statusColor = 'red';
    chantier.progress = 0;
    chantier.cancelledAt = new Date().toLocaleDateString('fr-FR');

    // Ajouter √† l'historique
    if (!chantier.history) chantier.history = [];
    chantier.history.unshift({
        title: 'Chantier annul√©',
        date: new Date().toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'}),
        progress: 0
    });

    // Si en mode Supabase, mettre √† jour dans la base
    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
        try {
            await SuiviTravauxAPI.Chantiers.update(id, {
                status: 'Annul√©',
                progress: 0,
                stage: 'annule'
            });
            await SuiviTravauxAPI.Updates.create(id, {
                title: 'Chantier annul√©',
                message: 'Ce chantier a √©t√© annul√©',
                progress: 0,
                stage: 'annule'
            });
        } catch (error) {
            console.error('Erreur Supabase:', error);
        }
    }

    // Archiver le chantier annul√©
    chantier.archivedAt = new Date().toLocaleDateString('fr-FR');
    if (!appData.archivedChantiers) appData.archivedChantiers = [];
    appData.archivedChantiers.push(chantier);
    appData.chantiers = appData.chantiers.filter(c => c.id !== id);

    saveData(appData);
    showScreen('list');
    renderAll();
    showToast('Chantier annul√© et archiv√©');
}

// Restaurer un chantier archiv√©
async function restoreChantier(id) {
    const idStr = String(id);

    // Si en mode Supabase, appeler l'API
    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
        try {
            await SuiviTravauxAPI.Chantiers.restore(id);
            // Recharger les chantiers depuis Supabase
            await syncData();
            renderArchives();
            showToast('Chantier restaur√© !');
        } catch (error) {
            console.error('Erreur restauration:', error);
            showToast('Erreur lors de la restauration');
        }
        return;
    }

    // Mode local et d√©mo
    const chantier = appData.archivedChantiers.find(c => String(c.id) === idStr);
    if (chantier) {
        delete chantier.archivedAt;
        appData.chantiers.push(chantier);
        appData.archivedChantiers = appData.archivedChantiers.filter(c => String(c.id) !== idStr);
        saveData(appData);
        renderAll();
        renderArchives();
        showToast('Chantier restaur√© !');
    }
}

// Supprimer d√©finitivement un chantier archiv√©
async function deleteArchivedChantier(id) {
    const idStr = String(id);

    // Si en mode Supabase, appeler l'API
    if (APP_MODE === 'supabase' && window.SuiviTravauxAPI) {
        try {
            await SuiviTravauxAPI.Chantiers.delete(id);
            // Recharger les archives depuis Supabase
            await syncData();
            renderArchives();
            showToast('Chantier supprim√© d√©finitivement');
        } catch (error) {
            console.error('Erreur suppression:', error);
            showToast('Erreur lors de la suppression');
        }
        return;
    }

    // Mode local et d√©mo
    appData.archivedChantiers = appData.archivedChantiers.filter(c => String(c.id) !== idStr);
    saveData(appData);
    renderArchives();
    showToast('Chantier supprim√© d√©finitivement');
}

// =============================================
// NOTIFICATIONS
// =============================================

let notificationsEnabled = false;

function showNotificationsModal() {
    document.getElementById('notificationsModal').classList.add('active');
    updateNotificationUI();
}

function closeNotificationsModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('notificationsModal').classList.remove('active');
    }
}

async function toggleNotifications() {
    if (!notificationsEnabled) {
        // Demander la permission
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('notifications-enabled', 'true');
                showToast('Notifications activ√©es');
            } else if (permission === 'denied') {
                showToast('Notifications bloqu√©es par le navigateur');
            }
        } else {
            showToast('Notifications non support√©es');
        }
    } else {
        notificationsEnabled = false;
        localStorage.setItem('notifications-enabled', 'false');
        showToast('Notifications d√©sactiv√©es');
    }
    updateNotificationUI();
}

function updateNotificationUI() {
    // V√©rifier l'√©tat
    const savedPref = localStorage.getItem('notifications-enabled');
    const browserPermission = 'Notification' in window ? Notification.permission : 'denied';

    notificationsEnabled = savedPref === 'true' && browserPermission === 'granted';

    // Toggle
    const toggle = document.getElementById('notif-toggle');
    const knob = document.getElementById('notif-toggle-knob');
    const options = document.getElementById('notif-options');
    const statusIcon = document.getElementById('notif-status-icon');
    const statusText = document.getElementById('notif-status-text');
    const statusDesc = document.getElementById('notif-status-desc');
    const statusBox = document.getElementById('notif-status');

    if (notificationsEnabled) {
        toggle.classList.remove('bg-slate-300');
        toggle.classList.add('bg-primary-600');
        knob.style.transform = 'translateX(24px)';
        options.classList.remove('opacity-50', 'pointer-events-none');
        statusIcon.classList.remove('bg-slate-200');
        statusIcon.classList.add('bg-green-100');
        statusIcon.innerHTML = '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        statusText.textContent = 'Notifications activ√©es';
        statusDesc.textContent = 'Vous recevrez les alertes';
        statusBox.classList.remove('bg-slate-50', 'border-slate-200');
        statusBox.classList.add('bg-green-50', 'border-green-200');
    } else {
        toggle.classList.add('bg-slate-300');
        toggle.classList.remove('bg-primary-600');
        knob.style.transform = 'translateX(0)';
        options.classList.add('opacity-50', 'pointer-events-none');
        statusIcon.classList.add('bg-slate-200');
        statusIcon.classList.remove('bg-green-100');
        statusIcon.innerHTML = '<svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>';
        statusText.textContent = 'Notifications d√©sactiv√©es';
        statusDesc.textContent = browserPermission === 'denied' ? 'Bloqu√©es dans le navigateur' : 'Activez pour recevoir les alertes';
        statusBox.classList.add('bg-slate-50', 'border-slate-200');
        statusBox.classList.remove('bg-green-50', 'border-green-200');
    }
}

// Envoyer une notification (pour usage futur)
function sendNotification(title, body, icon = 'favicon.svg') {
    if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon });
    }
}

// =============================================
// AIDE & SUPPORT
// =============================================

function showSupportModal() {
    document.getElementById('supportModal').classList.add('active');
}

function closeSupportModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('supportModal').classList.remove('active');
    }
}

// =============================================
// MENTIONS L√âGALES
// =============================================

function showLegalModal(tab = 'privacy') {
    document.getElementById('legalModal').classList.add('active');
    showLegalTab(tab);
}

function closeLegalModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('legalModal').classList.remove('active');
    }
}

function showLegalTab(tab) {
    // Masquer tous les contenus
    document.querySelectorAll('.legal-content').forEach(el => el.classList.add('hidden'));
    // Afficher le contenu s√©lectionn√©
    document.getElementById('legal-' + tab).classList.remove('hidden');

    // Mettre √† jour les onglets
    document.querySelectorAll('.legal-tab').forEach(el => {
        el.classList.remove('bg-primary-600', 'text-white');
        el.classList.add('bg-slate-100', 'text-slate-600');
    });
    document.getElementById('tab-' + tab).classList.remove('bg-slate-100', 'text-slate-600');
    document.getElementById('tab-' + tab).classList.add('bg-primary-600', 'text-white');

    // Mettre √† jour le titre
    const titles = { privacy: 'Politique de confidentialit√©', terms: 'Conditions d\'utilisation', legal: 'Mentions l√©gales' };
    document.getElementById('legal-title').textContent = titles[tab];
}

// =============================================
// ABONNEMENT
// =============================================

function showSubscriptionModal() {
    document.getElementById('subscriptionModal').classList.add('active');
    updateSubscriptionStatus();
}

function closeSubscriptionModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('subscriptionModal').classList.remove('active');
    }
}

function updateSubscriptionStatus() {
    // R√©cup√©rer les infos d'abonnement (simul√© pour l'instant)
    // En production, ces donn√©es viendraient de Supabase
    const subscription = getSubscriptionInfo();

    const statusEl = document.getElementById('subscription-status');
    const badgeEl = document.getElementById('subscription-badge');
    const trialDaysEl = document.getElementById('trial-days');
    const trialProgressEl = document.getElementById('trial-progress');

    if (subscription.status === 'trial') {
        const daysLeft = subscription.trialDaysLeft;
        const progress = (daysLeft / 14) * 100;

        statusEl.className = 'mb-6 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200';
        statusEl.innerHTML = `
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">üéÅ</span>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">P√©riode d'essai</p>
                    <p class="text-sm text-slate-600">Il vous reste <strong>${daysLeft} jour${daysLeft > 1 ? 's' : ''}</strong></p>
                </div>
            </div>
            <div class="h-2 bg-amber-200 rounded-full overflow-hidden mt-3">
                <div class="h-full bg-amber-500 rounded-full transition-all" style="width: ${progress}%"></div>
            </div>
        `;
        if (badgeEl) {
            badgeEl.textContent = 'Essai';
            badgeEl.className = 'px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 rounded-full';
        }
    } else if (subscription.status === 'active') {
        statusEl.className = 'mb-6 p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200';
        statusEl.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">‚úì</span>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Abonnement ${subscription.plan}</p>
                    <p class="text-sm text-slate-600">Actif jusqu'au ${subscription.expiresAt}</p>
                </div>
            </div>
        `;
        if (badgeEl) {
            badgeEl.textContent = 'Pro';
            badgeEl.className = 'px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full';
        }
    } else if (subscription.status === 'lifetime') {
        statusEl.className = 'mb-6 p-4 rounded-xl bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200';
        statusEl.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                    <span class="text-xl">‚≠ê</span>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Licence √† vie</p>
                    <p class="text-sm text-slate-600">Acc√®s permanent, merci pour votre confiance !</p>
                </div>
            </div>
        `;
        if (badgeEl) {
            badgeEl.textContent = 'Pro ‚≠ê';
            badgeEl.className = 'px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-700 rounded-full';
        }
    }
}

function getSubscriptionInfo() {
    // Simul√© - En production, r√©cup√©rer depuis Supabase/Stripe
    const trialStart = localStorage.getItem('trial-start');
    if (!trialStart) {
        localStorage.setItem('trial-start', new Date().toISOString());
    }

    const startDate = new Date(localStorage.getItem('trial-start'));
    const now = new Date();
    const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
    const daysLeft = Math.max(0, 14 - daysPassed);

    return {
        status: 'trial', // 'trial', 'active', 'lifetime', 'expired'
        trialDaysLeft: daysLeft,
        plan: null,
        expiresAt: null
    };
}

function handleSubscribe() {
    const selectedPlan = document.querySelector('input[name="plan"]:checked')?.value;

    if (!selectedPlan) {
        showToast('S√©lectionnez une offre');
        return;
    }

    const prices = {
        monthly: '9,90‚Ç¨/mois',
        yearly: '99‚Ç¨/an',
        lifetime: '199‚Ç¨ (une fois)'
    };

    // En production, rediriger vers Stripe Checkout
    showToast(`Redirection vers le paiement... (${prices[selectedPlan]})`);

    // Simuler la redirection vers Stripe
    // window.location.href = '/api/checkout?plan=' + selectedPlan;

    console.log('Plan s√©lectionn√©:', selectedPlan);
}

// =============================================
// GESTION LIMITE ESSAI (3 CHANTIERS MAX)
// =============================================

const TRIAL_CHANTIER_LIMIT = 3;

// V√©rifier si l'utilisateur peut cr√©er un nouveau chantier
function canCreateChantier() {
    const subscription = getSubscriptionInfo();

    // Mode admin Pro = acc√®s illimit√©
    if (IS_ADMIN_MODE || APP_MODE === 'admin') {
        return { allowed: true, remaining: Infinity };
    }

    // Utilisateurs payants = pas de limite
    if (subscription.status === 'active' || subscription.status === 'lifetime') {
        return { allowed: true, remaining: Infinity };
    }

    // Mode d√©mo = pas de limite (pour tester)
    if (APP_MODE === 'demo') {
        return { allowed: true, remaining: Infinity };
    }

    // Essai gratuit = limite √† 3 chantiers (actifs + archiv√©s)
    const activeChantiers = appData.chantiers?.length || 0;
    const archivedChantiers = appData.archivedChantiers?.length || 0;
    const totalChantiers = activeChantiers + archivedChantiers;
    const remaining = TRIAL_CHANTIER_LIMIT - totalChantiers;

    return {
        allowed: remaining > 0,
        remaining: Math.max(0, remaining),
        current: totalChantiers,
        limit: TRIAL_CHANTIER_LIMIT
    };
}

// Afficher le modal limite atteinte
function showTrialLimitModal() {
    document.getElementById('trialLimitModal').classList.add('active');
}

// Fermer le modal limite atteinte
function closeTrialLimitModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('trialLimitModal').classList.remove('active');
    }
}

// Obtenir le message d'info sur les chantiers restants
function getTrialInfoMessage() {
    const check = canCreateChantier();
    if (check.remaining === Infinity) return null;

    if (check.remaining === 0) {
        return { type: 'warning', text: `Limite atteinte (${check.limit}/${check.limit} chantiers)` };
    } else if (check.remaining === 1) {
        return { type: 'info', text: `Plus qu'1 chantier disponible sur ${check.limit}` };
    } else {
        return { type: 'info', text: `${check.remaining} chantiers disponibles sur ${check.limit}` };
    }
}

// Mettre √† jour l'indicateur de limite dans le dashboard
function updateTrialIndicator() {
    const container = document.getElementById('trial-limit-indicator');
    if (!container) return;

    const check = canCreateChantier();
    const subscription = getSubscriptionInfo();

    // Ne pas afficher pour les utilisateurs payants ou en mode d√©mo
    if (check.remaining === Infinity) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    const percentage = (check.current / check.limit) * 100;
    const isWarning = check.remaining <= 1;
    const isLimitReached = check.remaining === 0;

    container.innerHTML = `
        <div class="p-3 rounded-xl ${isLimitReached ? 'bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200' : 'bg-slate-50 border border-slate-200'}">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm ${isWarning ? 'text-amber-600' : 'text-slate-600'}">
                        ${isLimitReached ? 'üîí' : 'üìä'} Chantiers utilis√©s
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold ${isLimitReached ? 'text-amber-700' : 'text-slate-700'}">${check.current}/${check.limit}</span>
                    ${isLimitReached ? `
                        <button onclick="showSubscriptionModal()" class="text-xs bg-primary-600 text-white px-2 py-1 rounded-lg hover:bg-primary-700">
                            Passer Pro
                        </button>
                    ` : ''}
                </div>
            </div>
            <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all ${isLimitReached ? 'bg-amber-500' : isWarning ? 'bg-amber-400' : 'bg-primary-500'}" style="width: ${percentage}%"></div>
            </div>
            ${subscription.status === 'trial' && subscription.trialDaysLeft > 0 ? `
                <p class="text-xs text-slate-400 mt-2">Essai gratuit : ${subscription.trialDaysLeft} jour${subscription.trialDaysLeft > 1 ? 's' : ''} restant${subscription.trialDaysLeft > 1 ? 's' : ''}</p>
            ` : ''}
        </div>
    `;
}

// =============================================
// ARCHIVES
// =============================================

// Afficher le modal des archives
function showArchivesModal() {
    document.getElementById('archivesModal').classList.add('active');
    renderArchives();
}

// Fermer le modal des archives
function closeArchivesModal(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('archivesModal').classList.remove('active');
    }
}

// Rendre la liste des archives
function renderArchives() {
    const container = document.getElementById('archives-list');
    if (!container) return;

    const archives = appData.archivedChantiers || [];

    if (archives.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-center py-8">Aucun chantier archiv√©</p>';
        return;
    }

    let html = '';
    archives.forEach(c => {
        html += `
        <div class="bg-slate-50 rounded-xl p-4 mb-3">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="font-semibold text-slate-800">${c.name}</h3>
                    <p class="text-sm text-slate-500">${c.client}</p>
                </div>
                <span class="text-xs text-slate-400">Archiv√© le ${c.archivedAt}</span>
            </div>
            <div class="flex gap-2 mt-3">
                <button onclick="restoreChantier('${c.id}')" class="flex-1 text-sm py-2 bg-primary-100 text-primary-600 rounded-lg hover:bg-primary-200">Restaurer</button>
                <button onclick="deleteArchivedChantier('${c.id}')" class="text-sm py-2 px-4 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">Supprimer</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

// Initialize dark mode from localStorage
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('darkMode') === 'true') {
        toggleDarkMode();
    }
    // Rendu initial des donn√©es
    renderAll();
});

// Bouton de r√©initialisation (pour les tests) - accessible via console: resetData()
console.log('üèóÔ∏è SuiviTravaux.app - Pour r√©initialiser les donn√©es: resetData()');
console.log('üìä Donn√©es actuelles:', appData.chantiers.length, 'chantiers');
</script>
</body>
</html>